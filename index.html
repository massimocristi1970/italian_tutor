<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italian & Sicilian Tutor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .pulse-animation {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }
        }
        .word-button {
            cursor: pointer;
            @apply bg-white border border-gray-300 text-gray-800 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-150 hover:bg-blue-500 hover:text-white dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500 dark:hover:bg-blue-600;
        }
        .word-button.in-sentence {
            cursor: pointer;
            @apply bg-blue-500 text-white shadow-md;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="flex items-center justify-center min-h-screen p-4 transition-colors duration-500 bg-gray-100 dark:bg-gray-900">
    <!-- Main application container -->
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-sm sm:max-w-lg transition-colors duration-500 dark:bg-gray-800">
        <!-- Header with language selection and user ID -->
        <div class="flex items-center justify-between mb-6 flex-wrap">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 text-center flex-grow dark:text-gray-100">Language Tutor</h1>
            <div class="flex items-center space-x-2">
                <span id="flag-display" class="text-3xl">ðŸ‡®ðŸ‡¹</span>
                <select id="language-select" class="bg-gray-200 text-gray-800 p-2 rounded-lg cursor-pointer dark:bg-gray-700 dark:text-gray-100 mt-2 sm:mt-0">
                    <option value="italian">Italian</option>
                    <option value="sicilian">Sicilian</option>
                </select>
            </div>
            <div id="user-id-display" class="w-full text-center text-xs text-gray-600 mt-2 truncate dark:text-gray-400">User ID: Loading...</div>
        </div>

        <!-- Mode Toggle Buttons -->
        <div class="flex justify-center space-x-4 mb-6">
            <button id="tutor-mode-btn" class="py-2 px-4 rounded-lg font-semibold bg-blue-500 text-white transition-colors duration-300">Phrase Tutor</button>
            <button id="chat-mode-btn" class="py-2 px-4 rounded-lg font-semibold bg-gray-200 text-gray-800 transition-colors duration-300 dark:bg-gray-700 dark:text-gray-100">AI Chat</button>
        </div>

        <!-- Tutor Section (Sentence Builder) -->
        <div id="tutor-section" class="text-center">
            <!-- System message/alert container -->
            <div id="tutor-system-message" class="text-center font-semibold text-sm mb-4 h-6 opacity-0 transition-opacity duration-500 text-gray-800 dark:text-gray-100"></div>

            <!-- Flashcard content (English Phrase) -->
            <div class="h-20 sm:h-24 flex items-center justify-center bg-gray-50 rounded-lg p-4 mb-6 transition-colors duration-500 dark:bg-gray-700">
                <div class="flex flex-col">
                    <p id="phrase-en" class="text-lg sm:text-2xl font-medium text-gray-800 transition-opacity duration-300 dark:text-gray-100"></p>
                    <!-- Mastery Indicator -->
                    <div id="mastery-indicator" class="text-xs mt-1 font-semibold text-gray-500 dark:text-gray-400"></div>
                </div>
            </div>

            <!-- Sentence Construction Area -->
            <div class="text-left text-sm font-semibold text-gray-700 mb-2 dark:text-gray-300">Your Sentence:</div>
            <div id="current-sentence" class="min-h-[50px] p-3 border-2 border-dashed border-gray-400 rounded-lg mb-4 flex flex-wrap gap-2 items-center dark:bg-gray-700 dark:border-gray-500">
                <!-- Selected word buttons will appear here -->
            </div>

            <!-- Word Bank -->
            <div class="text-left text-sm font-semibold text-gray-700 mb-2 dark:text-gray-300">Word Bank:</div>
            <div id="word-bank" class="min-h-[80px] p-3 bg-gray-100 rounded-lg flex flex-wrap gap-2 justify-center mb-6 transition-colors duration-500 dark:bg-gray-700">
                <!-- Shuffled word buttons and distractors will appear here -->
            </div>

            <!-- Feedback and action buttons -->
            <div id="tutor-feedback" class="text-center text-sm font-semibold h-6 mb-4"></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="check-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg w-full transition-all duration-300 transform hover:scale-105 shadow-md">
                    Check Sentence
                </button>
                <button id="next-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg w-full transition-all duration-300 transform hover:scale-105 shadow-md hidden">
                    Next Phrase
                </button>
                <button id="reveal-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg w-full transition-all duration-300 transform hover:scale-105 shadow-md">
                    Reveal Answer
                </button>
            </div>
             <!-- Listen Button -->
            <div class="mt-4">
                <button id="tutor-listen-btn" class="bg-gray-200 text-gray-800 p-3 rounded-lg transition-all duration-300 hover:bg-gray-300 w-full dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-volume-up mr-2"></i> Listen to the correct phrase
                </button>
            </div>
        </div>

        <!-- Chat Section -->
        <div id="chat-section" class="hidden flex flex-col h-[60vh] max-h-[600px] overflow-hidden">
            <div id="chat-window" class="flex-grow p-4 bg-gray-50 rounded-lg mb-4 overflow-y-auto transition-colors duration-500 dark:bg-gray-700">
                <div class="text-center text-sm text-gray-500 dark:text-gray-400">Start a conversation with the AI tutor.</div>
            </div>
            <div class="flex items-center space-x-2">
                <input id="chat-input" type="text" placeholder="Send a message..."
                       class="flex-grow p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300 dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                <button id="chat-send-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition-all duration-300">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ensure Firebase logging is enabled for debugging
        setLogLevel('debug');

        // --- Global Environment Setup (Constants must be present) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- User-Provided Firebase Configuration (Using placeholder config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAMlShSEWBzHhKTL6lcFYVec1U6i_kNco0",
            authDomain: "italiantutorapp.firebaseapp.com",
            projectId: "italiantutorapp",
            storageBucket: "italiantutorapp.firebasestorage.app",
            messagingSenderId: "915130971011",
            appId: "1:915130971011:web:171cfb69941fdf7997fcb6"
        };
        
        // --- Core Application State & Firebase References ---
        let db, auth;
        let userId = null;
        let chatHistory = [];
        let isWaitingForResponse = false;
        
        // -----------------------------------------------------------
        // --- IMPORTANT: PASTE YOUR GEMINI API KEY HERE ---
        // This key is used for the free AI Chat and Text generation.
        // -----------------------------------------------------------
        const API_KEY = "AIzaSyBJzBPjcCDlDaN0G2OyBrm6zwr7oLI1aUU"; // <--- PASTE YOUR KEY INSIDE THESE QUOTES
        const GEMINI_TEXT_API = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        
        // --- Phrase Data (Mastery system preserved) ---
        const masteredThreshold = 2; // Need 2 correct answers to master a phrase
        const italianPhrases = [
            { en: "Hello", it: "Ciao", mastered: 0 },
            { en: "Thank you very much", it: "Grazie mille", mastered: 0 },
            { en: "Please, a bottle of water", it: "Per favore, una bottiglia d'acqua", mastered: 0 },
            { en: "Excuse me, where is the station?", it: "Mi scusi, dov'Ã¨ la stazione?", mastered: 0 },
            { en: "Yes, I like the red wine", it: "SÃ¬, mi piace il vino rosso", mastered: 0 },
            { en: "No, I do not want the fish", it: "No, non voglio il pesce", mastered: 0 },
            { en: "Goodbye, see you tomorrow", it: "Arrivederci, a domani", mastered: 0 },
            { en: "How are you doing today?", it: "Come stai oggi?", mastered: 0 },
            { en: "I don't understand the question", it: "Non capisco la domanda", mastered: 0 },
            { en: "Do you speak English or French?", it: "Parli inglese o francese?", mastered: 0 },
            { en: "What is your name, sir?", it: "Qual Ã¨ il tuo nome, signore?", mastered: 0 },
            { en: "My name is Antonio", it: "Mi chiamo Antonio", mastered: 0 },
            { en: "Where are you from, madam?", it: "Di dove sei, signora?", mastered: 0 },
            { en: "I am from Rome, in Italy", it: "Sono di Roma, in Italia", mastered: 0 },
            { en: "I am sorry for the delay", it: "Mi dispiace per il ritardo", mastered: 0 },
            { en: "How much does this coffee cost?", it: "Quanto costa questo caffÃ¨?", mastered: 0 },
            { en: "The food is delicious and hot", it: "Il cibo Ã¨ delizioso e caldo", mastered: 0 },
            { en: "I would like a large cappuccino", it: "Vorrei un cappuccino grande", mastered: 0 },
            { en: "I am tired after the long trip", it: "Sono stanco dopo il lungo viaggio", mastered: 0 },
            { en: "Let's go to the market now", it: "Andiamo al mercato ora", mastered: 0 }
        ];

        const sicilianPhrases = [
            { en: "Hello", it: "Salutu", mastered: 0 },
            { en: "Thank you very much", it: "GrazzÃ® assai", mastered: 0 },
            { en: "Please, a bottle of water", it: "Pi favuri, na buttÃ¬gghia d'acqua", mastered: 0 },
            { en: "Excuse me, where is the station?", it: "M'accatti, unni Ã¨ la stazzioni?", mastered: 0 },
            { en: "Yes, I like the red wine", it: "SÃ¬, mi piaci lu vinu russu", mastered: 0 },
            { en: "No, I do not want the fish", it: "No, nun vogghiu lu pisci", mastered: 0 },
            { en: "Goodbye, see you tomorrow", it: "Addiu, nni videmu dumani", mastered: 0 },
            { en: "How are you doing today?", it: "Comu si senti Ã²i?", mastered: 0 },
            { en: "I don't understand the question", it: "Nun capisciu la dumannata", mastered: 0 },
            { en: "Do you speak English or French?", it: "Parra ngrisi o francisi?", mastered: 0 },
            { en: "What is your name, sir?", it: "Qual Ã¨ lu tÃ² nomi, signuri?", mastered: 0 },
            { en: "My name is Antonio", it: "Mi chiÃ mu Antoniu", mastered: 0 },
            { en: "Where are you from, madam?", it: "Di unni si, signura?", mastered: 0 },
            { en: "I am from Rome, in Italy", it: "Sugnu di Roma, 'n Talia", mastered: 0 },
            { en: "I am sorry for the delay", it: "M'addulÃ¬u pÃ» ritardu", mastered: 0 },
            { en: "How much does this coffee cost?", it: "Quantu costa stu cafÃ¨?", mastered: 0 },
            { en: "The food is delicious and hot", it: "Lu manciari Ã¨ diliziusu e cÃ udu", mastered: 0 },
            { en: "I would like a large cappuccino", it: "VuÃ²gghiu un cappuccinu granni", mastered: 0 },
            { en: "I am tired after the long trip", it: "Sugnu stancu doppu lu longu viÃ ggiu", mastered: 0 },
            { en: "Let's go to the market now", it: "Iemu Ã´ mircatu ora", mastered: 0 }
        ];

        let currentPhrases = italianPhrases;
        let currentPhrase = null;

        // --- DOM Element References ---
        const languageSelect = document.getElementById('language-select');
        const tutorSection = document.getElementById('tutor-section');
        const chatSection = document.getElementById('chat-section');
        const tutorModeBtn = document.getElementById('tutor-mode-btn');
        const chatModeBtn = document.getElementById('chat-mode-btn');
        const flagDisplay = document.getElementById('flag-display');
        const phraseEnElement = document.getElementById('phrase-en');
        const masteryIndicator = document.getElementById('mastery-indicator');
        const currentSentenceElement = document.getElementById('current-sentence');
        const wordBankElement = document.getElementById('word-bank');
        const tutorListenBtn = document.getElementById('tutor-listen-btn');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const revealBtn = document.getElementById('reveal-btn');
        const tutorFeedbackElement = document.getElementById('tutor-feedback');
        const tutorSystemMessageElement = document.getElementById('tutor-system-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        

        // --- Firebase Data Reference Helpers ---
        const progressDocRef = () => doc(db, 'artifacts', appId, 'users', userId, 'progress', 'user_progress');
        const chatHistoryDocRef = () => doc(db, 'artifacts', appId, 'users', userId, 'chat', languageSelect.value);

        // --- UI & Utility Functions ---
        function switchMode(mode) {
            if (mode === 'tutor') {
                tutorSection.classList.remove('hidden', 'flex');
                chatSection.classList.add('hidden');
                tutorModeBtn.classList.add('bg-blue-500', 'text-white');
                tutorModeBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');
                chatModeBtn.classList.remove('bg-blue-500', 'text-white');
                chatModeBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');
            } else {
                chatSection.classList.remove('hidden');
                chatSection.classList.add('flex');
                tutorSection.classList.add('hidden');
                chatModeBtn.classList.add('bg-blue-500', 'text-white');
                chatModeBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');
                tutorModeBtn.classList.remove('bg-blue-500', 'text-white');
                tutorModeBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');
                loadChatHistory();
            }
        }

        function updateFlag() {
            flagDisplay.textContent = languageSelect.value === 'italian' ? 'ðŸ‡®ðŸ‡¹' : 'ðŸ‡¸ðŸ‡®'; // Using Sicily flag
        }

        function showTutorSystemMessage(message) {
            tutorSystemMessageElement.textContent = message;
            tutorSystemMessageElement.classList.remove('opacity-0');
            tutorSystemMessageElement.classList.add('opacity-100');
            setTimeout(() => {
                tutorSystemMessageElement.classList.remove('opacity-100');
                tutorSystemMessageElement.classList.add('opacity-0');
            }, 3000);
        }
        
        function appendChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('my-2', 'p-3', 'rounded-lg', 'max-w-[80%]');
            if (sender === 'user') {
                messageDiv.classList.add('bg-blue-500', 'text-white', 'ml-auto');
            } else {
                messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-600', 'dark:text-gray-100');
            }
            messageDiv.textContent = message;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                // Use Italian language code for both Italian and Sicilian for best voice compatibility
                utterance.lang = 'it-IT'; 
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('Browser does not support native Text-to-Speech.');
            }
        }
        
        function renderMastery() {
            if (!currentPhrase) return;
            const masteredCount = currentPhrase.mastered;
            const target = masteredThreshold;
            
            if (masteredCount >= target) {
                masteryIndicator.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> Mastered!`;
            } else if (masteredCount >= 0) {
                masteryIndicator.innerHTML = `Mastery: <span class="text-blue-500 font-bold">${masteredCount}/${target}</span>`;
            } else {
                masteryIndicator.innerHTML = `<i class="fas fa-times-circle text-red-500"></i> Needs practice`;
            }
        }

        // --- Sentence Builder Logic ---
        function renderWordBank(words) {
            wordBankElement.innerHTML = '';
            currentSentenceElement.innerHTML = '';

            words.forEach(word => {
                const button = createWordButton(word, 'bank');
                wordBankElement.appendChild(button);
            });
            wordBankElement.classList.remove('opacity-0');
        }

        function createWordButton(word, location) {
            const button = document.createElement('button');
            button.textContent = word;
            button.classList.add('word-button');
            button.setAttribute('data-word', word);
            button.setAttribute('data-location', location);
            
            if (location === 'sentence') {
                button.classList.add('in-sentence');
            }

            button.addEventListener('click', () => {
                const currentLoc = button.getAttribute('data-location');
                if (currentLoc === 'bank') {
                    // Move from bank to sentence
                    button.classList.add('in-sentence');
                    currentSentenceElement.appendChild(button);
                    button.setAttribute('data-location', 'sentence');
                    tutorFeedbackElement.textContent = ''; // Clear feedback on move
                } else {
                    // Move from sentence back to bank
                    button.classList.remove('in-sentence');
                    wordBankElement.appendChild(button);
                    button.setAttribute('data-location', 'bank');
                }
                checkButtonState();
            });
            return button;
        }

        function checkButtonState() {
            // Only enable check/reveal if there are words in the sentence
            const hasWords = currentSentenceElement.children.length > 0;
            checkBtn.disabled = !hasWords;
            revealBtn.disabled = !hasWords;
        }
        
        function selectNewPhrase() {
            // Find unmastered phrases or reset if all are mastered
            const unmasteredPhrases = currentPhrases.filter(p => p.mastered < masteredThreshold);
            if (unmasteredPhrases.length === 0) {
                currentPhrases.forEach(p => p.mastered = 0);
                showTutorSystemMessage("You have mastered all phrases! Starting over.");
            }

            // Prioritize phrases that need practice (mastered < 0)
            const phrasesToRepeat = currentPhrases.filter(p => p.mastered < 0);
            
            let phraseSet = phrasesToRepeat.length > 0 ? phrasesToRepeat : unmasteredPhrases;
            if (phraseSet.length === 0) phraseSet = currentPhrases; // Should not happen after reset, but fallback

            currentPhrase = phraseSet[Math.floor(Math.random() * phraseSet.length)];
            
            // 1. Set English phrase
            phraseEnElement.textContent = currentPhrase.en;
            renderMastery();

            // 2. Prepare words for the bank
            const correctWords = currentPhrase.it.split(/[\s,.'â€™]+/g).filter(w => w.length > 0);
            let allWords = [...correctWords];

            // 3. Add 3 Distractor words (Difficulty level)
            const allTargetWords = (currentPhrases.flatMap(p => p.it.split(/[\s,.'â€™]+/g))).filter(w => w.length > 2);
            let distractors = [];
            while (distractors.length < 3) {
                const randomWord = allTargetWords[Math.floor(Math.random() * allTargetWords.length)];
                // Ensure the distractor is not a correct word and is unique
                if (!correctWords.includes(randomWord) && !distractors.includes(randomWord)) {
                    distractors.push(randomWord);
                }
            }
            
            allWords = allWords.concat(distractors);
            
            // Shuffle the final list of words
            allWords.sort(() => Math.random() - 0.5);
            
            // 4. Render the UI
            renderWordBank(allWords);
            tutorFeedbackElement.textContent = '';
            nextBtn.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            checkButtonState();
        }

        // --- Firebase Handlers ---
        async function saveProgress(phrases) {
            if (!userId || !db) return console.error("Database not ready.");
            try {
                // IMPORTANT: We stringify the entire phrase array for simplicity in Firestore
                const progressData = { phrases: JSON.stringify(phrases) };
                await setDoc(progressDocRef(), progressData, { merge: true });
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        }
        
        async function loadProgress() {
            if (!userId || !db) return;

            try {
                const docSnap = await getDoc(progressDocRef());
                if (docSnap.exists() && docSnap.data().phrases) {
                    const savedPhrases = JSON.parse(docSnap.data().phrases);
                    
                    // Match saved mastery levels to the current phrase set
                    currentPhrases.forEach(phrase => {
                        const saved = savedPhrases.find(p => p.en === phrase.en);
                        if (saved) {
                            phrase.mastered = saved.mastered;
                        }
                    });
                    showTutorSystemMessage("Progress loaded successfully!");
                }
            } catch (error) {
                console.error("Error loading progress:", error);
            }
        }

        async function saveChatHistory() {
            if (!userId || !db) return console.error("Database not ready, cannot save chat.");
            try {
                await setDoc(chatHistoryDocRef(), { history: JSON.stringify(chatHistory) });
            } catch (error) {
                console.error("Error saving chat history:", error);
            }
        }

        async function loadChatHistory() {
            if (!userId || !db) return;
            try {
                const docSnap = await getDoc(chatHistoryDocRef());
                if (docSnap.exists()) {
                    chatHistory = JSON.parse(docSnap.data().history);
                } else {
                    chatHistory = [];
                }
                renderChatHistory();
            } catch (error) {
                console.error("Error loading chat history:", error);
            }
        }
        
        function renderChatHistory() {
            chatWindow.innerHTML = '';
            chatHistory.forEach(message => {
                appendChatMessage(message.text, message.sender);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- Gemini API Handlers (Simplified for single file) ---
        async function getTutorResponse(userMessage) {
            if (isWaitingForResponse) return;
            isWaitingForResponse = true;

            appendChatMessage(userMessage, 'user');
            chatHistory.push({ text: userMessage, sender: 'user' });
            chatInput.value = '';
            chatInput.placeholder = "Tutor is typing...";

            const targetLang = languageSelect.value === 'italian' ? 'Italian' : 'Sicilian';
            const prompt = `You are a conversational language tutor for ${targetLang}. Respond naturally in the target language. Keep the response simple, encouraging, and helpful for a beginner learner. Do not provide a translation unless the user asks for it explicitly.`;
            
            const payload = {
                contents: chatHistory.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                })),
                systemInstruction: { parts: [{ text: prompt }] },
                generationConfig: { temperature: 0.8, maxOutputTokens: 100, },
            };

            let responseText = "Sorry, I couldn't get a response. The Gemini API Key is missing or invalid.";
            if (API_KEY === "") {
                appendChatMessage(responseText, 'model');
                isWaitingForResponse = false;
                chatInput.placeholder = "Send a message...";
                return;
            }

            try {
                const response = await fetch(GEMINI_TEXT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    responseText = result.candidates[0].content.parts[0].text;
                } else if (result.error) {
                    responseText = `API Error: ${result.error.message}. Please check that your Gemini key is valid and not restricted.`;
                }
            } catch (error) {
                console.error('Error with Gemini text generation:', error);
                responseText = "Sorry, I couldn't connect to the Gemini API. Check your network or API key settings.";
            }

            appendChatMessage(responseText, 'model');
            chatHistory.push({ text: responseText, sender: 'model' });
            saveChatHistory();
            if (!responseText.startsWith("Error:") && !responseText.startsWith("Sorry,")) {
                speakText(responseText);
            }
            isWaitingForResponse = false;
            chatInput.placeholder = "Send a message...";
        }

        // --- Main App Initialization ---
        function startAppLogic(language) { 
            if (language === 'italian') {
                currentPhrases = italianPhrases;
            } else if (language === 'sicilian') {
                currentPhrases = sicilianPhrases;
            }
            updateFlag();
            loadProgress().then(() => {
                selectNewPhrase();
            });
        }

        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // IMPORTANT FIX: Use signInAnonymously to avoid the custom-token-mismatch error
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = `User ID: ${userId}`;
                            unsubscribe();
                            resolve();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Firebase Auth Error (Anonymous Failed):", error);
                                userIdDisplay.textContent = "Auth failed (using random ID)";
                                userId = crypto.randomUUID(); 
                            }
                        }
                    });
                });

                // Start application logic now that auth is ready
                startAppLogic(languageSelect.value);

            } catch (error) {
                console.error("FATAL FIREBASE INITIALIZATION ERROR:", error);
                userIdDisplay.textContent = "FATAL ERROR: Firebase Initialization Failed.";
                showTutorSystemMessage("Initialization failed. Check console for details.");
                startAppLogic(languageSelect.value); // Use app even if Firebase failed
            }
        }
        
        // --- Event Listeners Setup ---
        tutorModeBtn.addEventListener('click', () => switchMode('tutor'));
        chatModeBtn.addEventListener('click', () => switchMode('chat'));

        languageSelect.addEventListener('change', (e) => {
            if (chatSection.classList.contains('hidden')) {
                startAppLogic(e.target.value);
            } else {
                loadChatHistory();
                updateFlag();
            }
        });

        checkBtn.addEventListener('click', () => {
            if (!currentPhrase) return showTutorSystemMessage("The tutor is not ready yet.");

            // Get the sentence constructed by the user
            const sentenceWords = Array.from(currentSentenceElement.children).map(btn => btn.textContent.trim());
            
            // Clean the joined sentence for comparison (remove spaces before punctuation)
            const userAnswer = sentenceWords.join(' ')
                .replace(/\s([.,?!:;])/g, '$1') // Fix spaces before punctuation
                .toLowerCase();
            
            // Normalize the correct answer for comparison (remove spaces before punctuation)
            const correctAnswer = currentPhrase.it
                .replace(/\s([.,?!:;])/g, '$1')
                .toLowerCase()
                // Replace special characters that might be confusing (e.g., ' or â€™)
                .replace(/'|â€™/g, "'"); 
                
            const normalizedUserAnswer = userAnswer.replace(/'|â€™/g, "'");

            if (normalizedUserAnswer === correctAnswer) {
                tutorFeedbackElement.textContent = "Correct! Great job!";
                tutorFeedbackElement.style.color = '#10B981';
                checkBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                
                // Set words to green
                Array.from(currentSentenceElement.children).forEach(btn => {
                    btn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    btn.classList.remove('bg-blue-500', 'hover:bg-blue-500');
                    btn.disabled = true;
                });

                currentPhrase.mastered++;
                saveProgress(currentPhrases);
            } else {
                tutorFeedbackElement.textContent = "That's not quite right. Try re-arranging the words!";
                tutorFeedbackElement.style.color = '#EF4444';
                
                // Mastery score penalty for incorrect answer
                if (currentPhrase.mastered > 0) currentPhrase.mastered = 0;
                if (currentPhrase.mastered === 0) currentPhrase.mastered = -1; // Flag for needs review
                saveProgress(currentPhrases);
            }
            renderMastery();
        });

        nextBtn.addEventListener('click', () => selectNewPhrase());

        revealBtn.addEventListener('click', () => {
            if (!currentPhrase) return showTutorSystemMessage("The tutor is not ready yet.");

            tutorFeedbackElement.textContent = `The correct answer is: "${currentPhrase.it}"`;
            tutorFeedbackElement.style.color = '#4B5563';
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            
            // Disable interactions
            wordBankElement.classList.add('opacity-0');
            Array.from(currentSentenceElement.children).forEach(btn => btn.disabled = true);

            // Set mastery score to penalty for revealing
            currentPhrase.mastered = -1;
            saveProgress(currentPhrases);
            renderMastery();
        });

        tutorListenBtn.addEventListener('click', () => {
            if (!currentPhrase) return showTutorSystemMessage("The tutor is not ready yet.");
            speakText(currentPhrase.it);
        });

        chatSendBtn.addEventListener('click', () => {
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                getTutorResponse(userMessage);
            }
        });

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                chatSendBtn.click();
            }
        });

        // Initial calls
        setupFirebase();
    </script>
</body>
</html>