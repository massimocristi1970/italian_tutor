<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Italian Language Tutor</title>

    <link rel="icon" href="favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="output.css" type="text/css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- PHASE 6 PART 1: Responsive Styles -->
    <link rel="stylesheet" href="responsive-styles.css?v=3" />
    <style>
      :root {
        /* Default Light Theme Variables */
        --bg-primary: #f7f9fb;
        --bg-secondary: #ffffff;
        --text-primary: #1f2937;
        --text-secondary: #4b5563;
        --border-color: #e5e7eb;
        --input-bg: #f3f4f6;
      }

      .dark {
        /* Dark Theme Variables */
        --bg-primary: #1f2937;
        --bg-secondary: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --border-color: #4b5563;
        --input-bg: #4b5563;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s, color 0.3s;
      }

      .bg-white {
        background-color: var(--bg-secondary);
      }

      .border-gray-100 {
        border-color: var(--border-color);
      }

      .bg-gray-50 {
        background-color: var(--input-bg);
      }

      .text-gray-800 {
        color: var(--text-primary);
      }

      .text-gray-500 {
        color: var(--text-secondary);
      }

      .chat-area {
        height: calc(100vh - 20rem);
        transition: height 0.3s;
      }

      .bubble {
        max-width: 85%;
        word-wrap: break-word;
      }

      /* Styling for the audio button to be subtle */
      .audio-btn {
        background-color: transparent;
        border: none;
        color: #4f46e5;
        cursor: pointer;
        transition: color 0.15s;
      }

      .audio-btn:hover {
        color: #3730a3;
      }

      /* Custom scrollbar for aesthetics */
      .chat-area::-webkit-scrollbar {
        width: 6px;
      }

      .chat-area::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }

      .dark .chat-area::-webkit-scrollbar-thumb {
        background-color: #6b7280;
      }

      /* ========================================
   PHASE 1 ENHANCEMENTS
   ======================================== */

      /* Context Indicator Badges */
      .context-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 2px solid;
        background-color: rgba(255, 255, 255, 0.95);
        transition: all 0.2s ease;
        cursor: help;
        margin-top: 4px;
      }

      .context-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .context-icon {
        font-size: 1em;
        line-height: 1;
      }

      /* Alternative Expressions Panel */
      .alternatives-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
        margin-bottom: 12px;
        color: white;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .alternatives-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .alternatives-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
      }

      .alternatives-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.3rem;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .alternatives-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .alternatives-original {
        background: rgba(255, 255, 255, 0.15);
        padding: 10px 14px;
        border-radius: 8px;
        margin-bottom: 14px;
        font-size: 0.9rem;
      }

      .alternatives-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .alternative-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 14px;
        border-radius: 8px;
        border-left: 3px solid rgba(255, 255, 255, 0.4);
        transition: all 0.2s;
      }

      .alternative-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(4px);
      }

      .alternative-item.sicilian {
        border-left-color: #4caf50;
      }

      .alternative-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .alternative-text {
        font-size: 0.95rem;
        font-weight: 600;
        flex: 1;
      }

      .alternative-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .alternative-badge.formal {
        background: rgba(33, 150, 243, 0.3);
        border: 1px solid rgba(33, 150, 243, 0.6);
      }

      .alternative-badge.informal {
        background: rgba(76, 175, 80, 0.3);
        border: 1px solid rgba(76, 175, 80, 0.6);
      }

      .alternative-note {
        font-size: 0.85rem;
        opacity: 0.9;
        line-height: 1.4;
        margin: 0;
      }

      .alternatives-section {
        margin-bottom: 14px;
      }

      .alternatives-section-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0 0 10px 0;
        opacity: 0.95;
      }

      .alternatives-tip {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        line-height: 1.4;
        border: 1px dashed rgba(255, 255, 255, 0.3);
        margin-top: 12px;
      }

      /* Dark mode */
      .dark .context-badge {
        background-color: rgba(55, 65, 81, 0.95);
      }

      /* ========================================
   PHASE 2 - PROGRESS DASHBOARD & MILESTONES
   ======================================== */

      /* Progress Dashboard Container */
      .progress-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 20px;
        color: white;
        margin-bottom: 20px;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .dashboard-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
      }

      .dashboard-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 4px;
      }

      /* Skill Area Cards */
      .skill-areas {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .skill-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .skill-card:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      .skill-card.active {
        border-color: white;
        background: rgba(255, 255, 255, 0.25);
      }

      .skill-icon {
        font-size: 2rem;
        margin-bottom: 8px;
        display: block;
      }

      .skill-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .skill-description {
        font-size: 0.8rem;
        opacity: 0.85;
        line-height: 1.3;
      }

      .skill-progress {
        margin-top: 8px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      /* Progress Bars */
      .progress-bar-container {
        background: rgba(0, 0, 0, 0.2);
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-bar-fill {
        height: 100%;
        background: white;
        border-radius: 4px;
        transition: width 0.5s ease;
        position: relative;
      }

      .progress-bar-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }

        100% {
          transform: translateX(100%);
        }
      }

      /* Milestone Cards */
      .milestones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .milestone-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .milestone-card.completed {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
      }

      .milestone-card.locked {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .milestone-card:not(.locked):not(.completed):hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
      }

      .milestone-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }

      .milestone-icon {
        font-size: 2.5rem;
        line-height: 1;
      }

      .milestone-info {
        flex: 1;
      }

      .milestone-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 4px 0;
      }

      .milestone-description {
        font-size: 0.85rem;
        opacity: 0.9;
        margin: 0;
      }

      .milestone-requirements {
        margin-top: 12px;
      }

      .requirement-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .requirement-label {
        font-size: 0.85rem;
        flex: 1;
      }

      .requirement-progress {
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 8px;
      }

      .milestone-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.3);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .milestone-badge.completed {
        background: #4caf50;
      }

      .milestone-badge.locked {
        background: rgba(0, 0, 0, 0.3);
      }

      /* Achievement Unlocked Animation */
      .achievement-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #1f2937;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideInBounce 0.6s ease-out;
        max-width: 320px;
      }

      @keyframes slideInBounce {
        0% {
          transform: translateX(400px);
          opacity: 0;
        }

        60% {
          transform: translateX(-20px);
          opacity: 1;
        }

        80% {
          transform: translateX(10px);
        }

        100% {
          transform: translateX(0);
        }
      }

      .achievement-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .achievement-icon {
        font-size: 2.5rem;
      }

      .achievement-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0;
      }

      .achievement-message {
        font-size: 0.95rem;
        margin: 0;
        opacity: 0.9;
      }

      .achievement-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.2);
        border: none;
        color: inherit;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .achievement-close:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      /* Stats Display */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 0.8rem;
        opacity: 0.85;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Practice Streak Calendar */
      .streak-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-top: 12px;
      }

      .calendar-day {
        aspect-ratio: 1;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        position: relative;
      }

      .calendar-day.practiced {
        background: #4caf50;
        font-weight: 600;
      }

      .calendar-day.today {
        border: 2px solid white;
      }

      /* Feedback Panel */
      .feedback-panel {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
      }

      .feedback-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .feedback-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .feedback-item {
        padding: 10px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .feedback-icon {
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .progress-dashboard {
          padding: 16px;
        }

        .dashboard-title {
          font-size: 1.2rem;
        }

        .skill-areas {
          grid-template-columns: 1fr;
        }

        .milestones-grid {
          grid-template-columns: 1fr;
        }

        .achievement-popup {
          right: 10px;
          left: 10px;
          max-width: none;
        }
      }

      /* Dark mode adjustments */
      .dark .progress-dashboard {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .dark .milestone-card {
        background: rgba(0, 0, 0, 0.2);
      }

      .dark .skill-card {
        background: rgba(0, 0, 0, 0.2);
      }

      /* Scenarios Modal/Panel */
      .scenarios-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        backdrop-filter: blur(4px);
      }

      .scenarios-panel {
        background: var(--bg-secondary);
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .scenarios-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
      }

      .scenarios-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
      }

      .scenarios-close-btn {
        background: transparent;
        border: none;
        font-size: 2rem;
        color: var(--text-secondary);
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .scenarios-close-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        transform: rotate(90deg);
      }

      /* Category Tabs */
      .category-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 8px;
      }

      .category-tab {
        padding: 10px 20px;
        border-radius: 12px;
        border: 2px solid transparent;
        background: var(--input-bg);
        color: var(--text-secondary);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .category-tab:hover {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
      }

      .category-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
      }

      /* Scenario Cards Grid */
      .scenarios-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }

      .scenario-card {
        background: var(--input-bg);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .scenario-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        opacity: 0;
        transition: opacity 0.3s;
      }

      .scenario-card:hover::before {
        opacity: 1;
      }

      .scenario-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
      }

      .scenario-card.locked {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .scenario-card.locked:hover {
        transform: none;
        box-shadow: none;
        border-color: transparent;
      }

      .scenario-card.completed {
        border-color: #10b981;
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1),
          rgba(5, 150, 105, 0.05)
        );
      }

      .scenario-card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }

      .scenario-icon {
        font-size: 2.5rem;
        line-height: 1;
      }

      .scenario-info {
        flex: 1;
      }

      .scenario-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 4px 0;
      }

      .scenario-difficulty {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .scenario-difficulty.beginner {
        background: rgba(34, 197, 94, 0.2);
        color: #16a34a;
      }

      .scenario-difficulty.intermediate {
        background: rgba(59, 130, 246, 0.2);
        color: #2563eb;
      }

      .scenario-difficulty.advanced {
        background: rgba(239, 68, 68, 0.2);
        color: #dc2626;
      }

      .scenario-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .scenario-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .scenario-turns {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .scenario-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #10b981;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .scenario-badge.locked {
        background: #9ca3af;
      }

      /* Active Scenario View */
      .scenario-active {
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .scenario-active-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
      }

      .scenario-active-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .scenario-active-icon {
        font-size: 2rem;
      }

      .scenario-active-info h3 {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0 0 4px 0;
        color: var(--text-primary);
      }

      .scenario-active-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .scenario-exit-btn {
        background: rgba(239, 68, 68, 0.1);
        border: 2px solid #ef4444;
        color: #ef4444;
        padding: 8px 16px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .scenario-exit-btn:hover {
        background: #ef4444;
        color: white;
      }

      /* Cultural Note */
      .cultural-note {
        background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
        color: #78350f;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .cultural-note-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      /* Dialogue Display */
      .dialogue-container {
        margin-bottom: 20px;
      }

      .dialogue-message {
        margin-bottom: 16px;
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dialogue-message.npc {
        display: flex;
        justify-content: flex-start;
      }

      .dialogue-message.player {
        display: flex;
        justify-content: flex-end;
      }

      .dialogue-bubble {
        max-width: 75%;
        padding: 16px;
        border-radius: 16px;
        position: relative;
      }

      .dialogue-bubble.npc {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-left-radius: 4px;
      }

      .dialogue-bubble.player {
        background: var(--input-bg);
        color: var(--text-primary);
        border: 2px solid #10b981;
        border-bottom-right-radius: 4px;
      }

      .dialogue-speaker {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        opacity: 0.8;
        margin-bottom: 6px;
        letter-spacing: 0.5px;
      }

      .dialogue-text {
        font-size: 1.05rem;
        line-height: 1.5;
        margin-bottom: 8px;
      }

      .dialogue-translation {
        font-size: 0.85rem;
        opacity: 0.8;
        font-style: italic;
        margin-bottom: 6px;
      }

      .dialogue-audio-hint {
        font-size: 0.75rem;
        opacity: 0.7;
        font-family: monospace;
      }

      .dialogue-listen-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        margin-top: 8px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .dialogue-listen-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Player Input Section */
      .player-input-section {
        background: var(--input-bg);
        border-radius: 16px;
        padding: 20px;
        border: 2px dashed var(--border-color);
      }

      .input-hints {
        margin-bottom: 16px;
      }

      .input-hints-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .hint-item {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .vocabulary-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }

      .vocab-chip {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .vocab-chip:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .scenario-input-container {
        display: flex;
        gap: 12px;
      }

      .scenario-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
      }

      .scenario-input:focus {
        outline: none;
        border-color: #6366f1;
      }

      .scenario-submit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .scenario-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .scenario-submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Progress Indicator */
      .scenario-progress {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
      }

      .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--border-color);
        transition: all 0.3s;
      }

      .progress-dot.completed {
        background: #10b981;
        transform: scale(1.2);
      }

      .progress-dot.current {
        background: #6366f1;
        transform: scale(1.4);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
      }

      /* Completion Screen */
      .scenario-completion {
        text-align: center;
        padding: 40px 20px;
      }

      .completion-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        animation: bounce 1s ease-in-out;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-20px);
        }
      }

      .completion-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
      }

      .completion-message {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 24px;
      }

      .completion-stats {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-bottom: 24px;
      }

      .completion-stat {
        text-align: center;
      }

      .completion-stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #6366f1;
      }

      .completion-stat-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .completion-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .completion-btn {
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .completion-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
      }

      .completion-btn-secondary {
        background: transparent;
        color: var(--text-primary);
        border: 2px solid var(--border-color);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .scenarios-panel {
          padding: 16px;
          max-height: 95vh;
        }

        .scenarios-grid {
          grid-template-columns: 1fr;
        }

        .dialogue-bubble {
          max-width: 90%;
        }

        .category-tabs {
          flex-wrap: nowrap;
          overflow-x: scroll;
        }
      }

      /* ========================================
   PHASE 4 - PRONUNCIATION PRACTICE
   ======================================== */

      /* Pronunciation Modal */
      .pronunciation-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        backdrop-filter: blur(4px);
      }

      .pronunciation-modal.active {
        display: flex;
      }

      .pronunciation-panel {
        background: var(--bg-secondary);
        border-radius: 20px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
      }

      .pronunciation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
      }

      .pronunciation-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
      }

      /* Category Selection */
      .pronunciation-categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .pronunciation-category-card {
        background: var(--input-bg);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        text-align: center;
      }

      .pronunciation-category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #6366f1;
      }

      .pronunciation-category-card.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
      }

      .category-card-icon {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .category-card-name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .category-card-description {
        font-size: 0.8rem;
        opacity: 0.85;
      }

      /* Practice Area */
      .pronunciation-practice-area {
        background: var(--input-bg);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .pronunciation-target {
        text-align: center;
        margin-bottom: 24px;
      }

      .pronunciation-text {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .pronunciation-ipa {
        font-size: 1.2rem;
        color: #6366f1;
        font-family: "Courier New", monospace;
        margin-bottom: 8px;
      }

      .pronunciation-english {
        font-size: 1rem;
        color: var(--text-secondary);
        font-style: italic;
      }

      .pronunciation-focus {
        display: inline-block;
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 8px;
      }

      /* Recording Controls */
      .pronunciation-controls {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .pronunciation-btn {
        padding: 16px 32px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        border: none;
      }

      .pronunciation-btn-listen {
        background: #10b981;
        color: white;
      }

      .pronunciation-btn-listen:hover {
        background: #059669;
        transform: translateY(-2px);
      }

      .pronunciation-btn-record {
        background: #ef4444;
        color: white;
        position: relative;
      }

      .pronunciation-btn-record:hover:not(:disabled) {
        background: #dc2626;
      }

      .pronunciation-btn-record.recording {
        animation: pulse 1.5s infinite;
      }

      .pronunciation-btn-record:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
      }

      .pronunciation-btn-next {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .pronunciation-btn-next:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      /* Feedback Area */
      .pronunciation-feedback {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid var(--border-color);
        display: none;
      }

      .pronunciation-feedback.show {
        display: block;
      }

      .dark .pronunciation-feedback {
        background: var(--bg-secondary);
      }

      .pronunciation-score {
        text-align: center;
        margin-bottom: 16px;
      }

      .score-display {
        font-size: 4rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 8px;
      }

      .score-display.excellent {
        color: #10b981;
      }

      .score-display.good {
        color: #3b82f6;
      }

      .score-display.fair {
        color: #f59e0b;
      }

      .score-display.needs-work {
        color: #ef4444;
      }

      .score-label {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .pronunciation-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }

      .comparison-box {
        background: var(--input-bg);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
      }

      .comparison-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .comparison-text {
        font-size: 1.1rem;
        color: var(--text-primary);
        font-weight: 600;
      }

      .pronunciation-tips {
        background: rgba(59, 130, 246, 0.1);
        border-left: 4px solid #3b82f6;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .tips-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tips-content {
        font-size: 0.9rem;
        color: var(--text-primary);
        line-height: 1.5;
      }

      .pronunciation-mistakes {
        background: rgba(239, 68, 68, 0.1);
        border-left: 4px solid #ef4444;
        padding: 12px 16px;
        border-radius: 8px;
      }

      .mistakes-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #ef4444;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .mistakes-content {
        font-size: 0.85rem;
        color: var(--text-primary);
        line-height: 1.4;
      }

      /* Progress Tracking */
      .pronunciation-progress-bar {
        background: rgba(0, 0, 0, 0.1);
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 20px;
      }

      .pronunciation-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #3b82f6);
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      .pronunciation-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 20px;
      }

      .pronunciation-stat-card {
        background: var(--input-bg);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
      }

      .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #6366f1;
      }

      .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      /* Waveform Animation */
      .waveform {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        height: 60px;
        margin: 20px 0;
      }

      .waveform-bar {
        width: 4px;
        background: #6366f1;
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
      }

      .waveform-bar:nth-child(1) {
        animation-delay: 0s;
      }
      .waveform-bar:nth-child(2) {
        animation-delay: 0.1s;
      }
      .waveform-bar:nth-child(3) {
        animation-delay: 0.2s;
      }
      .waveform-bar:nth-child(4) {
        animation-delay: 0.3s;
      }
      .waveform-bar:nth-child(5) {
        animation-delay: 0.4s;
      }

      @keyframes wave {
        0%,
        100% {
          height: 10px;
        }
        50% {
          height: 50px;
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .pronunciation-panel {
          padding: 16px;
        }

        .pronunciation-text {
          font-size: 2rem;
        }

        .pronunciation-controls {
          flex-direction: column;
        }

        .pronunciation-btn {
          width: 100%;
        }

        .pronunciation-comparison {
          grid-template-columns: 1fr;
        }

        .pronunciation-categories {
          grid-template-columns: 1fr;
        }
      }
      /* ========================================
   PHASE 4 - ADDITIONAL FEATURES (Part 2)
   Fluency Challenges, SRS, Progress Reports
   ======================================== */

      /* ===== FLUENCY CHALLENGE MODAL ===== */
      .fluency-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        backdrop-filter: blur(4px);
      }

      .fluency-modal.active {
        display: flex;
      }

      .fluency-panel {
        background: var(--bg-secondary);
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
      }

      .challenge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .challenge-card {
        background: var(--input-bg);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
      }

      .challenge-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-color: #f59e0b;
      }

      .challenge-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
        display: block;
      }

      .challenge-name {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-primary);
      }

      .challenge-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .challenge-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .challenge-active {
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .challenge-timer {
        text-align: center;
        margin: 20px 0;
      }

      .timer-display {
        font-size: 3rem;
        font-weight: 700;
        color: #f59e0b;
        font-family: "Courier New", monospace;
      }

      .timer-display.warning {
        color: #ef4444;
        animation: pulse 1s infinite;
      }

      .challenge-progress-text {
        text-align: center;
        font-size: 1.2rem;
        margin: 16px 0;
        color: var(--text-primary);
      }

      .challenge-score-display {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        margin: 20px 0;
      }

      .score-number {
        font-size: 4rem;
        font-weight: 700;
        color: #1f2937;
      }

      .score-label {
        font-size: 1.2rem;
        color: #4b5563;
        margin-top: 8px;
      }

      /* ===== SRS CARD INTERFACE ===== */
      .srs-container {
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid var(--border-color);
      }

      .srs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .srs-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .srs-due-count {
        background: #ef4444;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .flashcard {
        background: var(--input-bg);
        border-radius: 16px;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        perspective: 1000px;
      }

      .flashcard:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      }

      .flashcard-front,
      .flashcard-back {
        text-align: center;
        width: 100%;
      }

      .flashcard-text {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
      }

      .flashcard-pronunciation {
        font-size: 1.2rem;
        color: #6366f1;
        font-family: "Courier New", monospace;
        margin-bottom: 20px;
      }

      .flashcard-example {
        font-size: 1rem;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 16px;
        padding: 12px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
      }

      .flashcard-back {
        display: none;
      }

      .flashcard.flipped .flashcard-front {
        display: none;
      }

      .flashcard.flipped .flashcard-back {
        display: block;
      }

      .srs-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .srs-btn {
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .srs-btn-again {
        background: #ef4444;
        color: white;
      }

      .srs-btn-hard {
        background: #f59e0b;
        color: white;
      }

      .srs-btn-good {
        background: #3b82f6;
        color: white;
      }

      .srs-btn-easy {
        background: #10b981;
        color: white;
      }

      .srs-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }

      .srs-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 20px;
      }

      .srs-stat-card {
        background: var(--input-bg);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .srs-stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #6366f1;
      }

      .srs-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 4px;
      }

      /* ===== PROGRESS REPORT MODAL ===== */
      .progress-report-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        backdrop-filter: blur(4px);
      }

      .progress-report-modal.active {
        display: flex;
      }

      .progress-report-panel {
        background: var(--bg-secondary);
        border-radius: 20px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
      }

      .report-header {
        text-align: center;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 2px solid var(--border-color);
      }

      .report-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .report-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
      }

      .report-section {
        margin-bottom: 32px;
      }

      .report-section-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .report-highlight {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 24px;
      }

      .report-highlight-stat {
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 8px;
      }

      .report-highlight-label {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .report-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .report-metric {
        background: var(--input-bg);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
      }

      .report-metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #6366f1;
        margin-bottom: 8px;
      }

      .report-metric-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .report-metric-change {
        font-size: 0.85rem;
        margin-top: 4px;
        font-weight: 600;
      }

      .report-metric-change.positive {
        color: #10b981;
      }

      .report-metric-change.negative {
        color: #ef4444;
      }

      .report-insight {
        background: rgba(59, 130, 246, 0.1);
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .report-insight-title {
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 6px;
      }

      .report-insight-text {
        color: var(--text-primary);
        line-height: 1.5;
      }

      .report-recommendation {
        background: rgba(16, 185, 129, 0.1);
        border-left: 4px solid #10b981;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .report-recommendation-title {
        font-weight: 700;
        color: #10b981;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .report-recommendation-text {
        color: var(--text-primary);
        line-height: 1.5;
      }

      /* ===== CONVERSATION MODE TOGGLE ===== */
      .conversation-mode-toggle {
        background: var(--input-bg);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .mode-btn {
        flex: 1;
        min-width: 140px;
        padding: 10px 16px;
        border-radius: 8px;
        border: 2px solid transparent;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .mode-btn:hover {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
      }

      .correction-indicator {
        position: relative;
        padding: 12px;
        background: rgba(239, 68, 68, 0.1);
        border-left: 4px solid #ef4444;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
        animation: fadeIn 0.3s ease-out;
      }

      .correction-indicator::before {
        content: "📝";
        margin-right: 6px;
      }

      /* ===== MOBILE RESPONSIVE ===== */
      @media (max-width: 768px) {
        .fluency-panel,
        .progress-report-panel {
          padding: 16px;
          max-height: 95vh;
        }

        .challenge-grid {
          grid-template-columns: 1fr;
        }

        .timer-display {
          font-size: 2rem;
        }

        .flashcard {
          min-height: 250px;
          padding: 24px;
        }

        .flashcard-text {
          font-size: 2rem;
        }

        .srs-buttons {
          flex-direction: column;
        }

        .srs-btn {
          width: 100%;
        }

        .report-grid {
          grid-template-columns: 1fr;
        }

        .conversation-mode-toggle {
          flex-direction: column;
        }

        .mode-btn {
          width: 100%;
        }
      }

      /* ===== ANIMATIONS ===== */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col">
    <div id="app" class="flex flex-col flex-grow container mx-auto p-4 md:p-8">
      <!-- Header -->
      <header class="text-center mb-6 flex justify-between items-center">
        <h1 class="text-xl md:text-3xl font-bold">
          <span id="app-language-display">🇮🇹 Italian</span> Language Tutor
        </h1>

        <div class="flex items-center space-x-4">
          <!-- 🌗 Theme Toggle Button -->
          <button
            id="theme-toggle"
            class="p-2 rounded-full text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-gray-100 transition duration-300"
            title="Toggle Dark/Light Mode"
          >
            <i id="theme-icon" class="fas fa-sun"></i>
          </button>

          <!-- 🔒 Logout Button -->
          <button
            id="logout-btn"
            class="p-2 rounded-full text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-gray-100 transition duration-300"
            title="Logout"
          >
            <i class="fas fa-sign-out-alt"></i>
          </button>

          <button
            class="mobile-menu-btn"
            id="mobile-menu-btn"
            onclick="toggleMobileMenu()"
            title="Menu"
          >
            <i class="fas fa-bars"></i>
          </button>

          <!-- Language Selector -->
          <div class="relative">
            <select
              id="language-select"
              class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm appearance-none pr-8 transition duration-150"
            >
              <option value="Italian" selected>Italiano (Italian)</option>
              <option value="Sicilian">Sicilianu (Sicilian)</option>
            </select>
            <i
              class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"
            ></i>
          </div>

          <!-- Level Selector -->
          <div class="relative">
            <select
              id="level-select"
              class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm appearance-none pr-8 transition duration-150"
            >
              <option value="level1" selected>🌱 Beginner (A1-A2)</option>
              <option value="level2">🌿 Intermediate (B1-B2)</option>
              <option value="level3">🌳 Advanced (C1-C2)</option>
            </select>
            <i
              class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"
            ></i>
          </div>
        </div>
      </header>

      <!-- PHASE 6: Mobile Menu Overlay -->
      <div
        class="mobile-menu-overlay"
        id="mobile-menu-overlay"
        onclick="closeMobileMenu()"
      ></div>

      <!-- PHASE 6: Mobile Menu Panel -->
      <div class="mobile-menu-panel" id="mobile-menu-panel">
        <div class="mobile-menu-header">
          <h3 class="text-lg font-bold text-indigo-600 dark:text-indigo-400">
            Menu
          </h3>
          <button class="mobile-menu-close" onclick="closeMobileMenu()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="mobile-menu-items">
          <button
            class="mobile-menu-item"
            onclick="closeMobileMenu(); document.getElementById('theme-toggle').click();"
          >
            <i class="fas fa-moon"></i>
            <span>Toggle Dark Mode</span>
          </button>
          <button
            class="mobile-menu-item"
            onclick="closeMobileMenu(); openScenariosModal();"
>
            <i class="fas fa-comments"></i>
            <span>Practice Conversations</span>
          </button>
          <button
            class="mobile-menu-item"
            onclick="closeMobileMenu(); openProgressReport();"
          >
            <i class="fas fa-chart-bar"></i>
            <span>Weekly Report</span>
          </button>
          <button
            class="mobile-menu-item"
            onclick="closeMobileMenu(); openPronunciationModal();"
          >
            <i class="fas fa-microphone"></i>
            <span>Pronunciation</span>
          </button>
          <button
            class="mobile-menu-item"
            onclick="closeMobileMenu(); openFluencyModal();"
          >
            <i class="fas fa-clock"></i>
            <span>Fluency Challenges</span>
          </button>
        </div>
      </div>

      <!-- Main Content Area -->
      <main class="flex flex-col flex-grow gap-6 md:flex-row">
        <!-- Primary Left Column: Builder and Phrases -->
        <div class="md:w-1/2 flex flex-col gap-6">
          <!-- Lesson/Word Building Area (Top Left) -->
          <section
            class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col flex-shrink-0"
          >
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">
              Sentence Builder
            </h2>

            <div class="flex-grow flex flex-col justify-between">
              <!-- Current Target Sentence/Exercise -->
              <div
                id="exercise-area"
                class="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg dark:bg-gray-600 dark:border-gray-500"
              >
                <p
                  class="text-sm font-medium text-indigo-700 mb-2 dark:text-indigo-300"
                >
                  Goal: Construct the Italian/Sicilian sentence for:
                </p>
                <div class="flex items-center justify-between">
                  <p
                    id="current-goal"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-100"
                  >
                    Loading a new sentence...
                  </p>
                  <button
                    id="listen-goal-btn"
                    class="audio-btn p-1 ml-2 text-indigo-600 dark:text-indigo-400"
                    title="Listen to the goal sentence (if Italian/Sicilian)"
                  >
                    <i class="fas fa-volume-up"></i>
                  </button>
                </div>
                <p
                  id="mastery-status"
                  class="text-xs text-indigo-600 mt-2 dark:text-indigo-300"
                >
                  Mastery: 0/20 phrases done.
                </p>
              </div>

              <!-- Selected Words Display -->
              <div
                id="selected-sentence"
                class="min-h-16 p-3 mb-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-500 flex flex-wrap items-center gap-2"
                style="background-color: var(--input-bg)"
              >
                <span class="text-gray-500 italic"
                  >Tap words below to build your sentence...</span
                >
              </div>

              <!-- Word Bank -->
              <div
                id="word-bank"
                class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 mb-4"
              >
                <!-- Words will be injected here -->
              </div>

              <!-- Actions -->
              <div class="flex gap-2">
                <button
                  id="submit-btn"
                  class="flex-grow py-3 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  Check Sentence
                </button>
                <button
                  id="clear-btn"
                  class="py-3 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150"
                >
                  Clear
                </button>
              </div>
            </div>

            <!-- Feedback Area -->
            <div
              id="feedback-message"
              class="mt-4 p-3 rounded-lg text-sm hidden"
            ></div>
          </section>

          <!-- Tabbed Section: Phrases and Verb Trainer -->
          <section
            class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex-grow flex flex-col"
          >
            <!-- Tab Navigation -->
            <div class="flex gap-2 mb-4 border-b border-gray-200">
              <button
                id="phrases-tab-btn"
                class="tab-btn px-4 py-2 font-semibold text-pink-600 border-b-2 border-pink-600 transition duration-150"
              >
                Common Phrases
              </button>
              <button
                id="verbs-tab-btn"
                class="tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-purple-600 transition duration-150"
              >
                Verb Trainer
              </button>
            </div>

            <!-- Phrases Tab Content -->
            <div id="phrases-tab-content" class="flex-grow overflow-y-auto">
              <div id="phrase-list" class="space-y-3">
                <!-- Phrases will be injected here -->
              </div>
            </div>

            <!-- Verb Trainer Tab Content -->
            <div id="verbs-tab-content" class="hidden flex-grow flex flex-col">
              <!-- Verb Selection -->
              <div class="mb-4">
                <label
                  class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
                  >Select a verb to practice:</label
                >
                <select
                  id="verb-select"
                  class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                >
                  <option value="">Choose a verb...</option>
                </select>
              </div>

              <!-- Verb Info -->
              <div
                id="verb-info"
                class="mb-4 p-4 bg-purple-50 dark:bg-purple-900 rounded-lg hidden"
              >
                <h3
                  class="text-lg font-bold text-purple-800 dark:text-purple-200"
                  id="verb-infinitive"
                ></h3>
                <p
                  class="text-sm text-purple-600 dark:text-purple-300"
                  id="verb-english"
                ></p>
                <p
                  class="text-xs text-purple-500 dark:text-purple-400 mt-1"
                  id="verb-type"
                ></p>
              </div>

              <!-- Conjugation Exercise -->
              <div
                id="conjugation-exercise"
                class="hidden flex-grow flex flex-col"
              >
                <h4
                  class="text-md font-semibold mb-3 text-purple-700 dark:text-purple-300"
                >
                  Present Tense (Presente)
                </h4>

                <div class="space-y-3 mb-4 flex-grow overflow-y-auto">
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">io</span>
                    <input
                      type="text"
                      id="conj-io"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-io" class="w-6"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">tu</span>
                    <input
                      type="text"
                      id="conj-tu"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-tu" class="w-6"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">lui/lei</span>
                    <input
                      type="text"
                      id="conj-lui-lei"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-lui-lei" class="w-6"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">noi</span>
                    <input
                      type="text"
                      id="conj-noi"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-noi" class="w-6"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">voi</span>
                    <input
                      type="text"
                      id="conj-voi"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-voi" class="w-6"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="w-16 text-sm font-medium">loro</span>
                    <input
                      type="text"
                      id="conj-loro"
                      class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"
                      placeholder="Type conjugation..."
                    />
                    <span id="feedback-loro" class="w-6"></span>
                  </div>
                </div>

                <div class="flex gap-2">
                  <button
                    id="check-conjugations-btn"
                    class="flex-grow py-2 px-4 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition duration-150"
                  >
                    Check Answers
                  </button>
                  <button
                    id="show-answers-btn"
                    class="py-2 px-4 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition duration-150"
                  >
                    Show Answers
                  </button>
                  <button
                    id="reset-verb-btn"
                    class="py-2 px-4 bg-red-400 text-white font-semibold rounded-lg shadow-md hover:bg-red-500 transition duration-150"
                  >
                    Reset
                  </button>
                </div>

                <!-- Score Display -->
                <div
                  id="verb-score"
                  class="mt-3 text-center text-sm text-gray-600 dark:text-gray-400"
                >
                  Score: <span id="score-display">0/0</span>
                </div>
              </div>

              <!-- Empty State -->
              <div
                id="verb-empty-state"
                class="flex-grow flex items-center justify-center text-gray-400"
              >
                <p class="text-center">
                  Select a verb above to start practicing!
                </p>
              </div>
            </div>
          </section>
        </div>

        <!-- Chat & History Area (Right) -->
        <section
          class="md:w-1/2 bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col"
        >
          <h2
            class="text-xl font-semibold mb-4 text-indigo-600 flex justify-between items-center"
          >
            Tutor Chat
            <span
              id="user-id-display"
              class="text-xs font-mono text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 px-2 py-1 rounded"
              >User ID: Loading...</span
            >
          </h2>

          <!-- Chat History -->
          <div
            id="chat-history"
            class="chat-area overflow-y-auto mb-4 p-3 space-y-4 rounded-lg flex-grow"
            style="background-color: var(--input-bg)"
          >
            <!-- Messages will be appended here -->
            <div class="flex justify-start">
              <div
                class="bubble bg-blue-100 text-blue-800 p-3 rounded-tr-xl rounded-b-xl shadow-sm dark:bg-blue-800 dark:text-blue-100"
              >
                Ciao! Welcome to your language lesson. Use the Sentence Builder
                on the left, or chat with me here!
              </div>
            </div>
          </div>

          <!-- Chat Input -->
          <div class="flex gap-2">
            <input
              type="text"
              id="chat-input"
              placeholder="Ask the tutor a question or type your sentence..."
              class="flex-grow p-3 border border-gray-300 dark:border-gray-500 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
            />
            <button
              id="mic-chat-btn"
              class="p-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 disabled:bg-gray-400"
              title="Start voice dictation"
            >
              <i class="fas fa-microphone"></i>
            </button>
            <button
              id="chat-send-btn"
              class="w-20 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 disabled:bg-gray-400"
            >
              Send
            </button>
          </div>

          <!-- Loading Indicator for LLM -->
          <div
            id="chat-loading-indicator"
            class="mt-2 text-center text-sm text-indigo-500 hidden dark:text-indigo-400"
          >
            Tutor is thinking...
          </div>
        </section>
      </main>

      <!-- Modal Placeholder -->
      <div
        id="modal-container"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50"
      >
        <div
          id="custom-modal"
          class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full dark:bg-gray-700"
        >
          <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">
            Error
          </h3>
          <p id="modal-message" class="mb-4 text-gray-700 dark:text-gray-300">
            An unknown error occurred.
          </p>
          <div class="flex justify-end">
            <button
              id="modal-close-btn"
              class="py-2 px-4 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PHASE 6: MOBILE BOTTOM NAVIGATION -->
    <nav class="mobile-bottom-nav">
      <div class="mobile-nav-items">
        <button
          class="mobile-nav-item active"
          id="mobile-nav-practice"
          onclick="showMobilePractice()"
        >
          <i class="fas fa-book"></i>
          <span>Practice</span>
        </button>
        <button
          class="mobile-nav-item"
          id="mobile-nav-progress"
          onclick="showMobileProgress()"
        >
          <i class="fas fa-chart-line"></i>
          <span>Progress</span>
        </button>
        <button
          class="mobile-nav-item"
          id="mobile-nav-scenarios"
          onclick="showScenariosModal()"
        >
          <i class="fas fa-comments"></i>
          <span>Scenarios</span>
        </button>
        <button
          class="mobile-nav-item"
          id="mobile-nav-chat"
          onclick="showMobileChat()"
        >
          <i class="fas fa-robot"></i>
          <span>Tutor</span>
        </button>
      </div>
    </nav>

    <!-- Firebase and Application Logic -->
    <script type="module">
      // Import necessary Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        collection,
        query,
        addDoc,
        serverTimestamp,
        limit,
        setLogLevel,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- GLOBAL VARIABLES & CONFIGURATION ---

      const appId =
        typeof __app_id !== "undefined" ? __app_id : "italian-tutor-default";
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let firebaseConfig = null;

      // Fetch Firebase config from Cloud Function
      async function loadFirebaseConfig() {
        try {
          // Detect if running locally (localhost or 127.0.0.1)
          const isLocal =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1";

          // If local, skip the Cloud Function fetch and use mock config
          if (isLocal) {
            console.warn("⚠️ Running locally — using mock Firebase config");
            return {
              apiKey: "test-key",
              authDomain: "test.firebaseapp.com",
              projectId: "test-project",
              storageBucket: "test.appspot.com",
              messagingSenderId: "12345",
              appId: "1:12345:web:test",
            };
          }

          // Otherwise, load config from Cloud Function
          const response = await fetch("/api/get-config");

          if (!response.ok) {
            throw new Error(
              `Server returned ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();
          console.log("✅ Loaded Firebase config from Cloud Function");
          return data.firebaseConfig || data; // handles either format
        } catch (e) {
          console.error("❌ Error loading Firebase config:", e.message);
          return null; // Return null to avoid crashing initializeApp()
        }
      }

      let app;
      let db;
      let auth;
      let userId = "loading";
      let currentLanguage = "Italian"; // Default language
      let currentLevel = "level1"; // Default difficulty level: level1, level2, level3

      // --- UI Element References ---
      const modalContainer = document.getElementById("modal-container");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const wordBankContainer = document.getElementById("word-bank");
      const selectedSentenceContainer =
        document.getElementById("selected-sentence");
      const submitButton = document.getElementById("submit-btn");
      const chatInput = document.getElementById("chat-input");
      const chatSendButton = document.getElementById("chat-send-btn");
      const chatHistoryContainer = document.getElementById("chat-history");
      const chatLoadingIndicator = document.getElementById(
        "chat-loading-indicator"
      );

      const phraseListContainer = document.getElementById("phrase-list");
      const micChatBtn = document.getElementById("mic-chat-btn");
      const listenGoalBtn = document.getElementById("listen-goal-btn");
      const languageSelect = document.getElementById("language-select");
      const masteryStatus = document.getElementById("mastery-status");
      const currentGoalDisplay = document.getElementById("current-goal");

      // --- Data & State ---
      let currentSelectedWords = [];
      let currentGoalId = null; // Used to track the phrase being mastered
      let masteredPhraseIds = new Set();
      const MAX_STATIC_PHRASES = 20; // Used for the 50% calculation
      let progressLoadedOnce = false; // Flag to prevent initial load loop

      const wordBankData = {
        // LEVEL 1: Beginner (A1-A2)
        level1: {
          pronouns: ["Io", "Tu", "Lui", "Lei", "Noi", "Voi", "Loro"],

          articles: ["il", "la", "un", "una", "i", "le", "gli", "lo", "l'"],

          verbs_present: [
            // -ARE verbs
            "parlo",
            "parli",
            "parla",
            "parliamo",
            "parlate",
            "parlano", // parlare (to speak)
            "mangio",
            "mangi",
            "mangia",
            "mangiamo",
            "mangiate",
            "mangiano", // mangiare (to eat)
            "amo",
            "ami",
            "ama",
            "amiamo",
            "amate",
            "amano", // amare (to love)
            "lavoro",
            "lavori",
            "lavora",
            "lavoriamo",
            "lavorate",
            "lavorano", // lavorare (to work)
            "studio",
            "studi",
            "studia",
            "studiamo",
            "studiate",
            "studiano", // studiare (to study)
            "guardo",
            "guardi",
            "guarda",
            "guardiamo",
            "guardate",
            "guardano", // guardare (to watch)
            "cammino",
            "cammini",
            "cammina",
            "camminiamo",
            "camminate",
            "camminano", // camminare (to walk)
            "compro",
            "compri",
            "compra",
            "compriamo",
            "comprate",
            "comprano", // comprare (to buy)
            "ascolto",
            "ascolti",
            "ascolta",
            "ascoltiamo",
            "ascoltate",
            "ascoltano", // ascoltare (to listen)
            "abito",
            "abiti",
            "abita",
            "abitiamo",
            "abitate",
            "abitano", // abitare (to live)

            // -ERE verbs
            "leggo",
            "leggi",
            "legge",
            "leggiamo",
            "leggete",
            "leggono", // leggere (to read)
            "scrivo",
            "scrivi",
            "scrive",
            "scriviamo",
            "scrivete",
            "scrivono", // scrivere (to write)
            "vedo",
            "vedi",
            "vede",
            "vediamo",
            "vedete",
            "vedono", // vedere (to see)
            "bevo",
            "bevi",
            "beve",
            "beviamo",
            "bevete",
            "bevono", // bere (to drink)
            "prendo",
            "prendi",
            "prende",
            "prendiamo",
            "prendete",
            "prendono", // prendere (to take)
            "metto",
            "metti",
            "mette",
            "mettiamo",
            "mettete",
            "mettono", // mettere (to put)
            "conosco",
            "conosci",
            "conosce",
            "conosciamo",
            "conoscete",
            "conoscono", // conoscere (to know)

            // -IRE verbs
            "dormo",
            "dormi",
            "dorme",
            "dormiamo",
            "dormite",
            "dormono", // dormire (to sleep)
            "apro",
            "apri",
            "apre",
            "apriamo",
            "aprite",
            "aprono", // aprire (to open)
            "sento",
            "senti",
            "sente",
            "sentiamo",
            "sentite",
            "sentono", // sentire (to hear/feel)
            "parto",
            "parti",
            "parte",
            "partiamo",
            "partite",
            "partono", // partire (to leave)

            // -ISC verbs
            "capisco",
            "capisci",
            "capisce",
            "capiamo",
            "capite",
            "capiscono", // capire (to understand)
            "finisco",
            "finisci",
            "finisce",
            "finiamo",
            "finite",
            "finiscono", // finire (to finish)
            "preferisco",
            "preferisci",
            "preferisce",
            "preferiamo",
            "preferite",
            "preferiscono", // preferire (to prefer)

            // Irregular essentials
            "sono",
            "sei",
            "è",
            "siamo",
            "siete",
            "sono", // essere (to be)
            "ho",
            "hai",
            "ha",
            "abbiamo",
            "avete",
            "hanno", // avere (to have)
            "vado",
            "vai",
            "va",
            "andiamo",
            "andate",
            "vanno", // andare (to go)
            "faccio",
            "fai",
            "fa",
            "facciamo",
            "fate",
            "fanno", // fare (to do/make)
            "dico",
            "dici",
            "dice",
            "diciamo",
            "dite",
            "dicono", // dire (to say)
            "vengo",
            "vieni",
            "viene",
            "veniamo",
            "venite",
            "vengono", // venire (to come)
            "voglio",
            "vuoi",
            "vuole",
            "vogliamo",
            "volete",
            "vogliono", // volere (to want)
            "posso",
            "puoi",
            "può",
            "possiamo",
            "potete",
            "possono", // potere (to be able)
            "devo",
            "devi",
            "deve",
            "dobbiamo",
            "dovete",
            "devono", // dovere (to have to)
          ],

          nouns_food: [
            "pane",
            "pasta",
            "pizza",
            "acqua",
            "vino",
            "caffè",
            "tè",
            "latte",
            "formaggio",
            "carne",
            "pesce",
            "pollo",
            "uovo",
            "mela",
            "banana",
            "arancia",
            "pomodoro",
            "insalata",
            "riso",
            "zucchero",
            "sale",
            "pepe",
            "burro",
            "olio",
          ],

          nouns_people: [
            "uomo",
            "donna",
            "bambino",
            "bambina",
            "ragazzo",
            "ragazza",
            "amico",
            "amica",
            "madre",
            "padre",
            "fratello",
            "sorella",
            "nonno",
            "nonna",
            "figlio",
            "figlia",
            "marito",
            "moglie",
            "famiglia",
            "persona",
            "studente",
            "studentessa",
            "professore",
            "professoressa",
          ],

          nouns_places: [
            "casa",
            "città",
            "paese",
            "strada",
            "piazza",
            "negozio",
            "ristorante",
            "bar",
            "hotel",
            "stazione",
            "aeroporto",
            "scuola",
            "università",
            "ospedale",
            "chiesa",
            "museo",
            "parco",
            "spiaggia",
            "montagna",
            "mare",
            "lago",
            "centro",
            "ufficio",
            "banca",
          ],

          nouns_things: [
            "libro",
            "telefono",
            "computer",
            "tavolo",
            "sedia",
            "letto",
            "porta",
            "finestra",
            "chiave",
            "borsa",
            "valigia",
            "auto",
            "bicicletta",
            "treno",
            "autobus",
            "aereo",
            "biglietto",
            "soldi",
            "carta",
            "penna",
            "quaderno",
            "orologio",
            "giornale",
            "rivista",
          ],

          nouns_time: [
            "giorno",
            "settimana",
            "mese",
            "anno",
            "ora",
            "minuto",
            "mattina",
            "pomeriggio",
            "sera",
            "notte",
            "oggi",
            "domani",
            "ieri",
            "lunedì",
            "martedì",
            "mercoledì",
            "giovedì",
            "venerdì",
            "sabato",
            "domenica",
          ],

          adjectives: [
            "buono",
            "buona",
            "cattivo",
            "cattiva",
            "bello",
            "bella",
            "brutto",
            "brutta",
            "grande",
            "piccolo",
            "piccola",
            "nuovo",
            "nuova",
            "vecchio",
            "vecchia",
            "giovane",
            "felice",
            "triste",
            "stanco",
            "stanca",
            "caldo",
            "calda",
            "freddo",
            "fredda",
            "facile",
            "difficile",
            "lungo",
            "lunga",
            "corto",
            "corta",
            "alto",
            "alta",
            "basso",
            "bassa",
            "rosso",
            "rossa",
            "blu",
            "verde",
            "giallo",
            "gialla",
            "bianco",
            "bianca",
            "nero",
            "nera",
          ],

          adverbs: [
            "molto",
            "poco",
            "troppo",
            "bene",
            "male",
            "sempre",
            "mai",
            "spesso",
            "raramente",
            "adesso",
            "ora",
            "già",
            "ancora",
            "presto",
            "tardi",
            "qui",
            "qua",
            "lì",
            "là",
            "dove",
            "quando",
            "come",
            "perché",
          ],

          prepositions: [
            "di",
            "a",
            "da",
            "in",
            "con",
            "su",
            "per",
            "tra",
            "fra",
            "dentro",
            "fuori",
            "sopra",
            "sotto",
            "vicino",
            "lontano",
            "davanti",
            "dietro",
            "prima",
            "dopo",
            "durante",
            "senza",
          ],

          conjunctions: [
            "e",
            "o",
            "ma",
            "però",
            "quindi",
            "allora",
            "se",
            "che",
            "perché",
            "quando",
            "mentre",
          ],
        },

        // LEVEL 2: Intermediate (B1-B2)
        level2: {
          verbs_past: [
            // Passato prossimo with avere
            "parlato",
            "mangiato",
            "bevuto",
            "letto",
            "scritto",
            "visto",
            "fatto",
            "detto",
            "preso",
            "messo",
            "chiuso",
            "aperto",

            // Passato prossimo with essere
            "andato",
            "andata",
            "venuto",
            "venuta",
            "stato",
            "stata",
            "partito",
            "partita",
            "arrivato",
            "arrivata",
            "tornato",
            "tornata",
            "nato",
            "nata",
            "morto",
            "morta",
            "uscito",
            "uscita",

            // Imperfetto
            "ero",
            "eri",
            "era",
            "eravamo",
            "eravate",
            "erano",
            "avevo",
            "avevi",
            "aveva",
            "avevamo",
            "avevate",
            "avevano",
            "facevo",
            "facevi",
            "faceva",
            "facevamo",
            "facevate",
            "facevano",
            "andavo",
            "andavi",
            "andava",
            "andavamo",
            "andavate",
            "andavano",
          ],

          verbs_future: [
            "parlerò",
            "parlerai",
            "parlerà",
            "parleremo",
            "parlerete",
            "parleranno",
            "mangerò",
            "mangerai",
            "mangerà",
            "mangeremo",
            "mangerete",
            "mangeranno",
            "sarò",
            "sarai",
            "sarà",
            "saremo",
            "sarete",
            "saranno",
            "avrò",
            "avrai",
            "avrà",
            "avremo",
            "avrete",
            "avranno",
            "farò",
            "farai",
            "farà",
            "faremo",
            "farete",
            "faranno",
            "andrò",
            "andrai",
            "andrà",
            "andremo",
            "andrete",
            "andranno",
          ],

          nouns_abstract: [
            "amore",
            "vita",
            "morte",
            "tempo",
            "lavoro",
            "problema",
            "soluzione",
            "idea",
            "pensiero",
            "sentimento",
            "emozione",
            "sogno",
            "speranza",
            "paura",
            "gioia",
            "tristezza",
            "pace",
            "guerra",
            "libertà",
            "verità",
            "bugia",
            "ragione",
            "torto",
          ],

          adjectives_advanced: [
            "interessante",
            "noioso",
            "noiosa",
            "divertente",
            "importante",
            "necessario",
            "necessaria",
            "possibile",
            "impossibile",
            "probabile",
            "strano",
            "strana",
            "normale",
            "speciale",
            "perfetto",
            "perfetta",
            "sicuro",
            "sicura",
            "pericoloso",
            "pericolosa",
            "sano",
            "sana",
            "malato",
            "malata",
            "ricco",
            "ricca",
            "povero",
            "povera",
          ],

          pronouns_object: [
            "mi",
            "ti",
            "lo",
            "la",
            "ci",
            "vi",
            "li",
            "le", // direct
            "ne",
            "ci",
            "si", // particles
          ],
        },

        // LEVEL 3: Advanced (C1-C2)
        level3: {
          verbs_conditional: [
            "vorrei",
            "vorresti",
            "vorrebbe",
            "vorremmo",
            "vorreste",
            "vorrebbero",
            "potrei",
            "potresti",
            "potrebbe",
            "potremmo",
            "potreste",
            "potrebbero",
            "dovrei",
            "dovresti",
            "dovrebbe",
            "dovremmo",
            "dovreste",
            "dovrebbero",
            "sarei",
            "saresti",
            "sarebbe",
            "saremmo",
            "sareste",
            "sarebbero",
            "avrei",
            "avresti",
            "avrebbe",
            "avremmo",
            "avreste",
            "avrebbero",
            "farei",
            "faresti",
            "farebbe",
            "faremmo",
            "fareste",
            "farebbero",
          ],

          verbs_subjunctive: [
            "sia",
            "sia",
            "sia",
            "siamo",
            "siate",
            "siano", // essere
            "abbia",
            "abbia",
            "abbia",
            "abbiamo",
            "abbiate",
            "abbiano", // avere
            "parli",
            "parli",
            "parli",
            "parliamo",
            "parliate",
            "parlino", // parlare
            "faccia",
            "faccia",
            "faccia",
            "facciamo",
            "facciate",
            "facciano", // fare
            "vada",
            "vada",
            "vada",
            "andiamo",
            "andiate",
            "vadano", // andare
          ],

          conjunctions_advanced: [
            "sebbene",
            "benché",
            "affinché",
            "purché",
            "nonostante",
            "quantunque",
            "comunque",
            "tuttavia",
            "inoltre",
            "invece",
            "cioè",
            "ossia",
            "ovvero",
            "pertanto",
            "dunque",
          ],

          expressions_idiomatic: [
            "avere fretta",
            "avere ragione",
            "avere torto",
            "fare bella figura",
            "fare brutta figura",
            "prendere in giro",
            "dare una mano",
            "andare d'accordo",
            "non veder l'ora",
            "costare un occhio della testa",
          ],
        },
      };

      // Verb Conjugation Database for Grammar Trainer
      const verbDatabase = {
        Italian: {
          level1: [
            {
              infinitive: "parlare",
              english: "to speak",
              type: "regular_are",
              conjugations: {
                presente: {
                  io: "parlo",
                  tu: "parli",
                  lui_lei: "parla",
                  noi: "parliamo",
                  voi: "parlate",
                  loro: "parlano",
                },
              },
            },
            {
              infinitive: "mangiare",
              english: "to eat",
              type: "regular_are",
              conjugations: {
                presente: {
                  io: "mangio",
                  tu: "mangi",
                  lui_lei: "mangia",
                  noi: "mangiamo",
                  voi: "mangiate",
                  loro: "mangiano",
                },
              },
            },
            {
              infinitive: "amare",
              english: "to love",
              type: "regular_are",
              conjugations: {
                presente: {
                  io: "amo",
                  tu: "ami",
                  lui_lei: "ama",
                  noi: "amiamo",
                  voi: "amate",
                  loro: "amano",
                },
              },
            },
            {
              infinitive: "lavorare",
              english: "to work",
              type: "regular_are",
              conjugations: {
                presente: {
                  io: "lavoro",
                  tu: "lavori",
                  lui_lei: "lavora",
                  noi: "lavoriamo",
                  voi: "lavorate",
                  loro: "lavorano",
                },
              },
            },
            {
              infinitive: "studiare",
              english: "to study",
              type: "regular_are",
              conjugations: {
                presente: {
                  io: "studio",
                  tu: "studi",
                  lui_lei: "studia",
                  noi: "studiamo",
                  voi: "studiate",
                  loro: "studiano",
                },
              },
            },
            {
              infinitive: "leggere",
              english: "to read",
              type: "regular_ere",
              conjugations: {
                presente: {
                  io: "leggo",
                  tu: "leggi",
                  lui_lei: "legge",
                  noi: "leggiamo",
                  voi: "leggete",
                  loro: "leggono",
                },
              },
            },
            {
              infinitive: "scrivere",
              english: "to write",
              type: "regular_ere",
              conjugations: {
                presente: {
                  io: "scrivo",
                  tu: "scrivi",
                  lui_lei: "scrive",
                  noi: "scriviamo",
                  voi: "scrivete",
                  loro: "scrivono",
                },
              },
            },
            {
              infinitive: "vedere",
              english: "to see",
              type: "regular_ere",
              conjugations: {
                presente: {
                  io: "vedo",
                  tu: "vedi",
                  lui_lei: "vede",
                  noi: "vediamo",
                  voi: "vedete",
                  loro: "vedono",
                },
              },
            },
            {
              infinitive: "dormire",
              english: "to sleep",
              type: "regular_ire",
              conjugations: {
                presente: {
                  io: "dormo",
                  tu: "dormi",
                  lui_lei: "dorme",
                  noi: "dormiamo",
                  voi: "dormite",
                  loro: "dormono",
                },
              },
            },
            {
              infinitive: "aprire",
              english: "to open",
              type: "regular_ire",
              conjugations: {
                presente: {
                  io: "apro",
                  tu: "apri",
                  lui_lei: "apre",
                  noi: "apriamo",
                  voi: "aprite",
                  loro: "aprono",
                },
              },
            },
            {
              infinitive: "capire",
              english: "to understand",
              type: "regular_ire_isc",
              conjugations: {
                presente: {
                  io: "capisco",
                  tu: "capisci",
                  lui_lei: "capisce",
                  noi: "capiamo",
                  voi: "capite",
                  loro: "capiscono",
                },
              },
            },
            {
              infinitive: "finire",
              english: "to finish",
              type: "regular_ire_isc",
              conjugations: {
                presente: {
                  io: "finisco",
                  tu: "finisci",
                  lui_lei: "finisce",
                  noi: "finiamo",
                  voi: "finite",
                  loro: "finiscono",
                },
              },
            },
            {
              infinitive: "essere",
              english: "to be",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "sono",
                  tu: "sei",
                  lui_lei: "è",
                  noi: "siamo",
                  voi: "siete",
                  loro: "sono",
                },
              },
            },
            {
              infinitive: "avere",
              english: "to have",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "ho",
                  tu: "hai",
                  lui_lei: "ha",
                  noi: "abbiamo",
                  voi: "avete",
                  loro: "hanno",
                },
              },
            },
            {
              infinitive: "andare",
              english: "to go",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "vado",
                  tu: "vai",
                  lui_lei: "va",
                  noi: "andiamo",
                  voi: "andate",
                  loro: "vanno",
                },
              },
            },
            {
              infinitive: "fare",
              english: "to do or make",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "faccio",
                  tu: "fai",
                  lui_lei: "fa",
                  noi: "facciamo",
                  voi: "fate",
                  loro: "fanno",
                },
              },
            },
            {
              infinitive: "volere",
              english: "to want",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "voglio",
                  tu: "vuoi",
                  lui_lei: "vuole",
                  noi: "vogliamo",
                  voi: "volete",
                  loro: "vogliono",
                },
              },
            },
            {
              infinitive: "potere",
              english: "to be able to",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "posso",
                  tu: "puoi",
                  lui_lei: "può",
                  noi: "possiamo",
                  voi: "potete",
                  loro: "possono",
                },
              },
            },
            {
              infinitive: "dovere",
              english: "to have to",
              type: "irregular",
              conjugations: {
                presente: {
                  io: "devo",
                  tu: "devi",
                  lui_lei: "deve",
                  noi: "dobbiamo",
                  voi: "dovete",
                  loro: "devono",
                },
              },
            },
          ],
        },
      };

      // Trainer state
      let currentVerb = null;
      let currentTense = "presente";
      let verbTrainerScore = { correct: 0, total: 0 };

      // Static Phrases (Each needs a unique ID for tracking)
      const staticPhraseData = [
        {
          id: "S01",
          english: "I speak Italian.",
          italian: "Io parlo italiano.",
          context: "greeting",
        },
        {
          id: "S02",
          english: "You eat the bread.",
          italian: "Tu mangi il pane.",
          context: "cafe",
        },
        {
          id: "S03",
          english: "He talks with the dog.",
          italian: "Lui parla con il cane.",
          context: "small_talk",
        },
        {
          id: "S04",
          english: "She drinks water.",
          italian: "Lei beve acqua.",
          context: "cafe",
        },
        {
          id: "S05",
          english: "We eat pasta.",
          italian: "Noi mangiamo la pasta.",
          context: "restaurant",
        },
        {
          id: "S06",
          english: "You (pl.) speak well.",
          italian: "Voi parlate bene.",
          context: "greeting",
        },
        {
          id: "S07",
          english: "They read the book.",
          italian: "Loro leggono il libro.",
          context: "small_talk",
        },
        {
          id: "S08",
          english: "A fast train.",
          italian: "Un treno veloce.",
          context: "directions",
        },
        {
          id: "S09",
          english: "The apple is red.",
          italian: "La mela è rossa.",
          context: "shopping",
        },
        {
          id: "S10",
          english: "He speaks always.",
          italian: "Lui parla sempre.",
          context: "small_talk",
        },
        {
          id: "S11",
          english: "I drink water now.",
          italian: "Io bevo acqua adesso.",
          context: "cafe",
        },
        {
          id: "S12",
          english: "We speak much.",
          italian: "Noi parliamo molto.",
          context: "small_talk",
        },
        {
          id: "S13",
          english: "The music is beautiful.",
          italian: "La musica è bella.",
          context: "small_talk",
        },
        {
          id: "S14",
          english: "They eat bread and water.",
          italian: "Loro mangiano pane e acqua.",
          context: "restaurant",
        },
        {
          id: "S15",
          english: "Do you talk with us?",
          italian: "Parli con noi?",
          context: "greeting",
        },
        {
          id: "S16",
          english: "She reads a book.",
          italian: "Lei legge un libro.",
          context: "small_talk",
        },
        {
          id: "S17",
          english: "I like apples.",
          italian: "Mi piacciono le mele.",
          context: "shopping",
        },
        {
          id: "S18",
          english: "He eats slowly.",
          italian: "Lui mangia lentamente.",
          context: "restaurant",
        },
        {
          id: "S19",
          english: "We are here.",
          italian: "Noi siamo qui.",
          context: "directions",
        },
        {
          id: "S20",
          english: "The bread is on the table.",
          italian: "Il pane è sulla tavola.",
          context: "restaurant",
        },
      ];

      // Enhanced Common Phrases with Context Tags
      // Replace your existing commonPhrases object in index.html (around line 600)

      const commonPhrases = {
        Italian: [
          // Greetings & Basic
          {
            language: "Italian",
            text: "Ciao!",
            english: "Hello / Bye!",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Buongiorno!",
            english: "Good morning!",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Buonasera!",
            english: "Good evening!",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Buonanotte!",
            english: "Good night!",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Come stai?",
            english: "How are you? (informal)",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Come sta?",
            english: "How are you? (formal)",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Sto bene, grazie.",
            english: "I am well, thank you.",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "E tu?",
            english: "And you?",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Piacere di conoscerti.",
            english: "Nice to meet you.",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Come ti chiami?",
            english: "What is your name?",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Mi chiamo...",
            english: "My name is...",
            context: "greeting",
          },

          // Polite Expressions
          {
            language: "Italian",
            text: "Per favore",
            english: "Please",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Grazie",
            english: "Thank you",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Grazie mille!",
            english: "Thank you very much!",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Prego",
            english: "You're welcome",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Scusa",
            english: "Sorry / Excuse me (informal)",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Mi dispiace",
            english: "I'm sorry",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Permesso",
            english: "Excuse me (to pass)",
            context: "small_talk",
          },

          // Basic Communication
          {
            language: "Italian",
            text: "Sì",
            english: "Yes",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "No",
            english: "No",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Non lo so",
            english: "I don't know",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Capisco",
            english: "I understand",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Non capisco",
            english: "I don't understand",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Parli inglese?",
            english: "Do you speak English?",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Non parlo italiano.",
            english: "I do not speak Italian.",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Parla più lentamente",
            english: "Speak more slowly",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Può ripetere?",
            english: "Can you repeat?",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Come si dice...?",
            english: "How do you say...?",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Cosa significa?",
            english: "What does it mean?",
            context: "small_talk",
          },

          // Questions
          {
            language: "Italian",
            text: "Dove?",
            english: "Where?",
            context: "directions",
          },
          {
            language: "Italian",
            text: "Quando?",
            english: "When?",
            context: "time",
          },
          {
            language: "Italian",
            text: "Perché?",
            english: "Why?",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Come?",
            english: "How?",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Quanto costa?",
            english: "How much does it cost?",
            context: "shopping",
          },
          {
            language: "Italian",
            text: "Che ore sono?",
            english: "What time is it?",
            context: "time",
          },
          {
            language: "Italian",
            text: "Dov'è il bagno?",
            english: "Where is the bathroom?",
            context: "emergency",
          },

          // Daily Life
          {
            language: "Italian",
            text: "Ho fame",
            english: "I am hungry",
            context: "restaurant",
          },
          {
            language: "Italian",
            text: "Ho sete",
            english: "I am thirsty",
            context: "cafe",
          },
          {
            language: "Italian",
            text: "Sono stanco",
            english: "I am tired",
            context: "hotel",
          },
          {
            language: "Italian",
            text: "Va bene",
            english: "It's okay / Alright",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Perfetto!",
            english: "Perfect!",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Ottimo!",
            english: "Excellent!",
            context: "restaurant",
          },
          {
            language: "Italian",
            text: "Bellissimo!",
            english: "Beautiful!",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "Che bella giornata!",
            english: "What a beautiful day!",
            context: "small_talk",
          },
          {
            language: "Italian",
            text: "A domani",
            english: "See you tomorrow",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "A presto",
            english: "See you soon",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Ci vediamo",
            english: "See you",
            context: "greeting",
          },
          {
            language: "Italian",
            text: "Buon appetito!",
            english: "Enjoy your meal!",
            context: "restaurant",
          },
          {
            language: "Italian",
            text: "Salute!",
            english: "Cheers! / Bless you!",
            context: "cafe",
          },
          {
            language: "Italian",
            text: "In bocca al lupo!",
            english: "Good luck!",
            context: "small_talk",
          },
        ],

        Sicilian: [
          // Greetings & Basic
          {
            language: "Sicilian",
            text: "Ciau!",
            english: "Hello / Bye!",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Bon jornu!",
            english: "Good morning!",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Bona sira!",
            english: "Good evening!",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Bona notti!",
            english: "Good night!",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Comu stai?",
            english: "How are you? (informal)",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Comu sta?",
            english: "How are you? (formal)",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Staiu bonu, grazzi.",
            english: "I am well, thank you.",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "E tu?",
            english: "And you?",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Piaciri di canùsciri.",
            english: "Nice to meet you.",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Comu ti chiami?",
            english: "What is your name?",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Mi chiamu...",
            english: "My name is...",
            context: "greeting",
          },

          // Polite Expressions
          {
            language: "Sicilian",
            text: "Pi favuri",
            english: "Please",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Grazzi",
            english: "Thank you",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Grazzi assai!",
            english: "Thank you very much!",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Prego",
            english: "You're welcome",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Scusa",
            english: "Sorry / Excuse me (informal)",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Mi dispiaci",
            english: "I'm sorry",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Pirmessu",
            english: "Excuse me (to pass)",
            context: "small_talk",
          },

          // Basic Communication
          {
            language: "Sicilian",
            text: "Sì",
            english: "Yes",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "No",
            english: "No",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Nun sacciu",
            english: "I don't know",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Capisciu",
            english: "I understand",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Nun capisciu",
            english: "I don't understand",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Parri ngrisi?",
            english: "Do you speak English?",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Nun parru sicilianu.",
            english: "I do not speak Sicilian.",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Parra cchiù chiano",
            english: "Speak more slowly",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Poi ripìtiri?",
            english: "Can you repeat?",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Comu si dici...?",
            english: "How do you say...?",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Chi voli diri?",
            english: "What does it mean?",
            context: "small_talk",
          },

          // Questions
          {
            language: "Sicilian",
            text: "Unni?",
            english: "Where?",
            context: "directions",
          },
          {
            language: "Sicilian",
            text: "Quannu?",
            english: "When?",
            context: "time",
          },
          {
            language: "Sicilian",
            text: "Picchì?",
            english: "Why?",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Comu?",
            english: "How?",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Quantu costa?",
            english: "How much does it cost?",
            context: "shopping",
          },
          {
            language: "Sicilian",
            text: "Chi ura è?",
            english: "What time is it?",
            context: "time",
          },
          {
            language: "Sicilian",
            text: "Unni è lu bagnu?",
            english: "Where is the bathroom?",
            context: "emergency",
          },

          // Daily Life
          {
            language: "Sicilian",
            text: "Haiu fami",
            english: "I am hungry",
            context: "restaurant",
          },
          {
            language: "Sicilian",
            text: "Haiu siti",
            english: "I am thirsty",
            context: "cafe",
          },
          {
            language: "Sicilian",
            text: "Sugnu stancu",
            english: "I am tired",
            context: "hotel",
          },
          {
            language: "Sicilian",
            text: "Va beni",
            english: "It's okay / Alright",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Perfettu!",
            english: "Perfect!",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Ottimu!",
            english: "Excellent!",
            context: "restaurant",
          },
          {
            language: "Sicilian",
            text: "Beddu assai!",
            english: "Beautiful!",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "Chi bedda jurnata!",
            english: "What a beautiful day!",
            context: "small_talk",
          },
          {
            language: "Sicilian",
            text: "A dumani",
            english: "See you tomorrow",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "A prestu",
            english: "See you soon",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Ci videmu",
            english: "See you",
            context: "greeting",
          },
          {
            language: "Sicilian",
            text: "Bonu appetitu!",
            english: "Enjoy your meal!",
            context: "restaurant",
          },
          {
            language: "Sicilian",
            text: "Saluti!",
            english: "Cheers! / Bless you!",
            context: "cafe",
          },
          {
            language: "Sicilian",
            text: "In bucca â lupu!",
            english: "Good luck!",
            context: "small_talk",
          },
        ],
      };

      let allPhrases = []; // Will hold static + dynamic phrases

      // PHASE 1: Enhancement data
      let contextsData = null;
      let alternativeExpressionsData = null;

      // Global state for Phase 2
      let grammarMilestonesData = null;
      let userProgress = null;

      // Load grammar milestones data
      async function loadGrammarMilestones() {
        try {
          const response = await fetch("grammarMilestones.json");
          grammarMilestonesData = await response.json();
          console.log("✅ Grammar milestones data loaded");
          return true;
        } catch (error) {
          console.warn("⚠️ Could not load grammar milestones:", error);
          return false;
        }
      }

      // Initialize user progress structure
      function initializeUserProgress() {
        return {
          verb_mastery: {},
          grammar_usage: {
            articles: { attempts: 0, correct: 0 },
            pronouns: { attempts: 0, correct: 0 },
            prepositions: { attempts: 0, correct: 0 },
            agreement: { attempts: 0, correct: 0 },
          },
          sentences: {
            simple: 0,
            compound: 0,
            complex: 0,
            total: 0,
          },
          vocabulary: {
            unique_words: [],
            words_by_category: {
              nouns: [],
              verbs: [],
              adjectives: [],
              adverbs: [],
            },
          },
          milestones_completed: {},
          practice_days: {
            streak: 0,
            longest_streak: 0,
            total_days: 0,
            last_practice_date: null,
            practice_calendar: {},
          },
          common_mistakes: {},
          stats: {
            total_sentences_built: 0,
            total_sentences_correct: 0,
            total_chat_messages: 0,
            total_practice_time_minutes: 0,
            level_progress: {
              level1: 0,
              level2: 0,
              level3: 0,
            },
          },
          achievements: {},
        };
      }

      // Update practice streak
      function updatePracticeStreak() {
        if (!userProgress) return;

        const today = new Date().toISOString().split("T")[0];
        const lastPractice = userProgress.practice_days.last_practice_date;

        if (!lastPractice) {
          userProgress.practice_days.streak = 1;
          userProgress.practice_days.total_days = 1;
          userProgress.practice_days.last_practice_date = today;
          userProgress.practice_days.practice_calendar[today] = true;

          saveUserProgressToFirebase();
          return;
        }

        if (lastPractice === today) {
          return; // Already practiced today
        }

        const lastDate = new Date(lastPractice);
        const todayDate = new Date(today);
        const dayDiff = Math.floor(
          (todayDate - lastDate) / (1000 * 60 * 60 * 24)
        );

        if (dayDiff === 1) {
          // Consecutive day
          userProgress.practice_days.streak += 1;
          userProgress.practice_days.total_days += 1;

          if (
            userProgress.practice_days.streak >
            userProgress.practice_days.longest_streak
          ) {
            userProgress.practice_days.longest_streak =
              userProgress.practice_days.streak;
          }

          // Check for streak milestones
          checkStreakMilestones();
        } else {
          // Streak broken
          userProgress.practice_days.streak = 1;
          userProgress.practice_days.total_days += 1;
        }

        userProgress.practice_days.last_practice_date = today;
        userProgress.practice_days.practice_calendar[today] = true;

        saveUserProgressToFirebase();
      }

      // Track verb practice
      function trackVerbPractice(verb, tense, isCorrect) {
        if (!userProgress) return;

        const key = `${verb}_${tense}`;

        if (!userProgress.verb_mastery[key]) {
          userProgress.verb_mastery[key] = {
            attempts: 0,
            correct: 0,
            lastPracticed: Date.now(),
          };
        }

        userProgress.verb_mastery[key].attempts += 1;
        if (isCorrect) {
          userProgress.verb_mastery[key].correct += 1;
        }
        userProgress.verb_mastery[key].lastPracticed = Date.now();

        // Check for mastery (80% accuracy over 5+ attempts)
        const accuracy =
          userProgress.verb_mastery[key].correct /
          userProgress.verb_mastery[key].attempts;
        const isMastered =
          userProgress.verb_mastery[key].attempts >= 5 && accuracy >= 0.8;

        if (isMastered) {
          checkVerbMilestones(verb, tense);
        }

        saveUserProgressToFirebase();

        return { mastered: isMastered, accuracy: accuracy };
      }

      // Track vocabulary usage
      function trackVocabularyUsage(words) {
        if (!userProgress) return;

        words.forEach((word) => {
          const lowerWord = word.toLowerCase();
          if (!userProgress.vocabulary.unique_words.includes(lowerWord)) {
            userProgress.vocabulary.unique_words.push(lowerWord);
          }
        });

        checkVocabularyMilestones();
        saveUserProgressToFirebase();
      }

      // Track sentence building
      function trackSentenceBuilt(isCorrect, complexity = "simple") {
        if (!userProgress) return;

        userProgress.sentences.total += 1;
        userProgress.sentences[complexity] += 1;
        userProgress.stats.total_sentences_built += 1;

        if (isCorrect) {
          userProgress.stats.total_sentences_correct += 1;
        }

        checkSentenceMilestones();
        saveUserProgressToFirebase();
      }

      // Check verb conjugation milestones
      function checkVerbMilestones(verb, tense) {
        if (!grammarMilestonesData) return;

        const verbMilestones =
          grammarMilestonesData.milestones.verb_conjugations;

        // Check present tense milestone
        if (tense === "presente") {
          const milestone = verbMilestones.present;
          const progress = calculateVerbMilestoneProgress(milestone);

          if (isVerbMilestoneComplete(progress, milestone)) {
            unlockMilestone("present_tense", milestone);
          }
        }
      }

      // Calculate verb milestone progress
      function calculateVerbMilestoneProgress(milestone) {
        const progress = {};
        const requirements = milestone.requirements;

        Object.keys(requirements).forEach((verbType) => {
          const required = requirements[verbType];
          const mastered = countMasteredVerbsByType(verbType);

          progress[verbType] = {
            current: mastered,
            required: required,
            percentage: Math.min(100, (mastered / required) * 100),
          };
        });

        return progress;
      }

      // Count mastered verbs by type
      function countMasteredVerbsByType(verbType) {
        if (!userProgress || !userProgress.verb_mastery) return 0;

        let count = 0;

        Object.keys(userProgress.verb_mastery).forEach((key) => {
          const [verb, tense] = key.split("_");
          const data = userProgress.verb_mastery[key];

          if (tense === "presente" && data.attempts >= 5) {
            const accuracy = data.correct / data.attempts;
            if (accuracy >= 0.8) {
              // Check if verb matches type
              // This would need verb type database
              count++;
            }
          }
        });

        return count;
      }

      // Check if verb milestone is complete
      function isVerbMilestoneComplete(progress, milestone) {
        return Object.values(progress).every((p) => p.percentage >= 100);
      }

      // Check streak milestones
      function checkStreakMilestones() {
        if (!grammarMilestonesData || !userProgress) return;

        const consistencyMilestones =
          grammarMilestonesData.milestones.consistency;
        const streak = userProgress.practice_days.streak;
        const totalDays = userProgress.practice_days.total_days;

        // Check daily learner (7 days)
        if (
          streak >= 7 &&
          !userProgress.milestones_completed["daily_learner"]
        ) {
          unlockMilestone(
            "daily_learner",
            consistencyMilestones.daily_practice
          );
        }

        // Check weekly warrior (30 days)
        if (
          streak >= 30 &&
          !userProgress.milestones_completed["weekly_warrior"]
        ) {
          unlockMilestone(
            "weekly_warrior",
            consistencyMilestones.weekly_warrior
          );
        }

        // Check dedicated student (100 total days)
        if (
          totalDays >= 100 &&
          !userProgress.milestones_completed["dedicated_student"]
        ) {
          unlockMilestone(
            "dedicated_student",
            consistencyMilestones.dedication
          );
        }
      }

      // Check vocabulary milestones
      function checkVocabularyMilestones() {
        if (!grammarMilestonesData || !userProgress) return;

        const vocabMilestones = grammarMilestonesData.milestones.vocabulary;
        const wordCount = userProgress.vocabulary.unique_words.length;

        if (
          wordCount >= 100 &&
          !userProgress.milestones_completed["vocab_100"]
        ) {
          unlockMilestone("vocab_100", vocabMilestones.beginner);
        }

        if (
          wordCount >= 300 &&
          !userProgress.milestones_completed["vocab_300"]
        ) {
          unlockMilestone("vocab_300", vocabMilestones.intermediate);
        }

        if (
          wordCount >= 500 &&
          !userProgress.milestones_completed["vocab_500"]
        ) {
          unlockMilestone("vocab_500", vocabMilestones.advanced);
        }
      }

      // Check sentence complexity milestones
      function checkSentenceMilestones() {
        if (!grammarMilestonesData || !userProgress) return;

        const sentenceMilestones =
          grammarMilestonesData.milestones.sentence_complexity;
        const sentences = userProgress.sentences;

        if (
          sentences.total >= 10 &&
          !userProgress.milestones_completed["simple_sentences"]
        ) {
          unlockMilestone("simple_sentences", sentenceMilestones.simple);
        }

        if (
          sentences.total >= 30 &&
          !userProgress.milestones_completed["compound_sentences"]
        ) {
          unlockMilestone("compound_sentences", sentenceMilestones.compound);
        }

        if (
          sentences.total >= 60 &&
          !userProgress.milestones_completed["complex_sentences"]
        ) {
          unlockMilestone("complex_sentences", sentenceMilestones.complex);
        }
      }

      // Unlock a milestone
      function unlockMilestone(milestoneId, milestoneData) {
        if (!userProgress) return;

        userProgress.milestones_completed[milestoneId] = {
          completedAt: Date.now(),
          celebrated: false,
        };

        saveUserProgressToFirebase();
        showAchievementPopup(milestoneData);
      }

      // Show achievement popup
      function showAchievementPopup(milestoneData) {
        const popup = document.createElement("div");
        popup.className = "achievement-popup";
        popup.innerHTML = `
                <button class="achievement-close" onclick="this.parentElement.remove()">×</button>
                <div class="achievement-header">
                  <span class="achievement-icon">${milestoneData.icon}</span>
                  <div>
                    <h3 class="achievement-title">${milestoneData.name}</h3>
                  </div>
                </div>
                <p class="achievement-message">${milestoneData.description}</p>
              `;

        document.body.appendChild(popup);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          popup.style.opacity = "0";
          popup.style.transform = "translateX(400px)";
          setTimeout(() => popup.remove(), 300);
        }, 5000);

        // Mark as celebrated
        if (
          userProgress &&
          userProgress.milestones_completed[milestoneData.id]
        ) {
          userProgress.milestones_completed[milestoneData.id].celebrated = true;
          saveUserProgressToFirebase();
        }
      }

      // Save user progress to Firebase
      async function saveUserProgressToFirebase() {
        if (!db || !userId || !auth.currentUser || !userProgress) return;

        try {
          const progressDocRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "user_progress"
          );

          await setDoc(
            progressDocRef,
            {
              ...userProgress,
              lastUpdated: serverTimestamp(),
            },
            { merge: true }
          );
        } catch (error) {
          console.warn("Could not save user progress:", error);
        }
      }

      // Load user progress from Firebase
      async function loadUserProgressFromFirebase() {
        if (!db || !userId || !auth.currentUser) return;

        try {
          const progressDocRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "user_progress"
          );

          const docSnap = await getDoc(progressDocRef);

          if (docSnap.exists()) {
            userProgress = docSnap.data();
            console.log("✅ User progress loaded from Firebase");
          } else {
            userProgress = initializeUserProgress();
            console.log("✅ Initialized new user progress");
          }

          // Update practice streak on load
          updatePracticeStreak();
        } catch (error) {
          console.error("Error loading user progress:", error);
          userProgress = initializeUserProgress();
        }
      }

      // Create progress dashboard UI
      function createProgressDashboard() {
        if (!grammarMilestonesData) return null;

        const dashboard = document.createElement("div");
        dashboard.className = "progress-dashboard";
        dashboard.id = "progress-dashboard";

        // Header
        dashboard.innerHTML = `
                <div class="dashboard-header">
                  <div>
                    <h2 class="dashboard-title">📊 Your Progress</h2>
                    <p class="dashboard-subtitle">Track your learning journey</p>
                  </div>
                </div>
              `;

        // Skill areas
        const skillAreas = document.createElement("div");
        skillAreas.className = "skill-areas";

        grammarMilestonesData.skill_areas.forEach((skill) => {
          const card = createSkillCard(skill);
          skillAreas.appendChild(card);
        });

        dashboard.appendChild(skillAreas);

        // Stats
        const statsGrid = createStatsGrid();
        dashboard.appendChild(statsGrid);

        return dashboard;
      }

      // Create skill card
      function createSkillCard(skill) {
        const card = document.createElement("div");
        card.className = "skill-card";
        card.onclick = () => showSkillDetails(skill.id);

        const progress = calculateSkillProgress(skill.id);

        card.innerHTML = `
                <span class="skill-icon">${skill.icon}</span>
                <div class="skill-name">${skill.name}</div>
                <div class="skill-description">${skill.description}</div>
                <div class="skill-progress">${progress}%</div>
                <div class="progress-bar-container">
                  <div class="progress-bar-fill" style="width: ${progress}%; background-color: ${skill.color};"></div>
                </div>
              `;

        return card;
      }

      // Calculate skill progress
      function calculateSkillProgress(skillId) {
        if (!userProgress) return 0;

        // Placeholder calculation - will be enhanced
        switch (skillId) {
          case "verbs":
            return Math.min(
              100,
              Object.keys(userProgress.verb_mastery).length * 2
            );
          case "vocabulary":
            return Math.min(
              100,
              Math.floor(
                (userProgress.vocabulary.unique_words.length / 500) * 100
              )
            );
          case "sentences":
            return Math.min(
              100,
              Math.floor((userProgress.sentences.total / 60) * 100)
            );
          case "consistency":
            return Math.min(100, userProgress.practice_days.total_days);
          default:
            return 0;
        }
      }

      // Create stats grid
      function createStatsGrid() {
        if (!userProgress) return document.createElement("div");

        const grid = document.createElement("div");
        grid.className = "stats-grid";

        const stats = [
          { label: "Streak", value: `${userProgress.practice_days.streak}🔥` },
          { label: "Sentences", value: userProgress.sentences.total },
          {
            label: "Words",
            value: userProgress.vocabulary.unique_words.length,
          },
          {
            label: "Accuracy",
            value:
              userProgress.stats.total_sentences_built > 0
                ? `${Math.round(
                    (userProgress.stats.total_sentences_correct /
                      userProgress.stats.total_sentences_built) *
                      100
                  )}%`
                : "0%",
          },
        ];

        stats.forEach((stat) => {
          const statCard = document.createElement("div");
          statCard.className = "stat-card";
          statCard.innerHTML = `
                  <div class="stat-value">${stat.value}</div>
                  <div class="stat-label">${stat.label}</div>
                `;
          grid.appendChild(statCard);
        });

        return grid;
      }

      // Show skill details (placeholder for future expansion)
      function showSkillDetails(skillId) {
        console.log("Show details for skill:", skillId);
        // This will open a detailed view of milestones for this skill
      }

      // Initialize Phase 2
      async function initializePhase2() {
        console.log("🚀 Initializing Phase 2 enhancements...");

        const loaded = await loadGrammarMilestones();

        if (loaded && auth.currentUser) {
          await loadUserProgressFromFirebase();
          console.log("✅ Phase 2 ready!");
          return true;
        } else {
          console.warn("⚠️ Phase 2 data not fully loaded");
          return false;
        }
      }

      // Global state for Phase 3
      let conversationScenariosData = null;
      let activeScenario = null;
      let currentTurn = 0;
      let scenarioDialogue = [];
      let completedScenarios = new Set();

      // Load conversation scenarios data
      async function loadConversationScenarios() {
        try {
          const response = await fetch("conversationScenarios.json");
          conversationScenariosData = await response.json();
          console.log("✅ Conversation scenarios loaded");
          return true;
        } catch (error) {
          console.warn("⚠️ Could not load conversation scenarios:", error);
          return false;
        }
      }

      // Load completed scenarios from Firebase
      async function loadCompletedScenarios() {
        if (!db || !userId || !auth.currentUser) return;

        try {
          const progressDocRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "scenarios"
          );

          const docSnap = await getDoc(progressDocRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            completedScenarios = new Set(data.completed || []);
            console.log(
              "✅ Loaded completed scenarios:",
              completedScenarios.size
            );
          }
        } catch (error) {
          console.warn("Could not load completed scenarios:", error);
        }
      }

      // Save completed scenario
      async function saveCompletedScenario(scenarioId) {
        if (!db || !userId || !auth.currentUser) return;

        completedScenarios.add(scenarioId);

        try {
          const progressDocRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "scenarios"
          );

          await setDoc(
            progressDocRef,
            {
              completed: Array.from(completedScenarios),
              lastCompleted: serverTimestamp(),
            },
            { merge: true }
          );

          console.log("✅ Saved scenario completion:", scenarioId);
        } catch (error) {
          console.warn("Could not save scenario completion:", error);
        }
      }

      // Check if scenario is unlocked
      function isScenarioUnlocked(scenario) {
        if (scenario.unlocked_by_default) return true;

        if (scenario.unlocks_after) {
          return completedScenarios.has(scenario.unlocks_after);
        }

        return false;
      }

      // Open scenarios modal
      function openScenariosModal() {
        if (!conversationScenariosData) {
          showModal(
            "Scenarios Not Available",
            "Conversation scenarios data is not loaded.",
            true
          );
          return;
        }

        const modal = createScenariosModal();
        document.body.appendChild(modal);
      }

      // Create scenarios modal
      function createScenariosModal() {
        const modal = document.createElement("div");
        modal.className = "scenarios-modal";
        modal.id = "scenarios-modal";

        const panel = document.createElement("div");
        panel.className = "scenarios-panel";

        // Header
        panel.innerHTML = `
                <div class="scenarios-header">
                  <h2 class="scenarios-title">🎭 Conversation Scenarios</h2>
                  <button class="scenarios-close-btn" onclick="closeScenariosModal()">×</button>
                </div>
              `;

        // Category tabs
        const categoryTabs = document.createElement("div");
        categoryTabs.className = "category-tabs";

        const allTab = document.createElement("button");
        allTab.className = "category-tab active";
        allTab.innerHTML = "🌟 All Scenarios";
        allTab.onclick = () => filterScenarios("all", allTab);
        categoryTabs.appendChild(allTab);

        conversationScenariosData.categories.forEach((category) => {
          const tab = document.createElement("button");
          tab.className = "category-tab";
          tab.innerHTML = `${category.icon} ${category.name}`;
          tab.onclick = () => filterScenarios(category.id, tab);
          categoryTabs.appendChild(tab);
        });

        panel.appendChild(categoryTabs);

        // Scenarios grid
        const grid = document.createElement("div");
        grid.className = "scenarios-grid";
        grid.id = "scenarios-grid";

        renderScenarios(grid, "all");

        panel.appendChild(grid);
        modal.appendChild(panel);

        // Close on backdrop click
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeScenariosModal();
          }
        };

        return modal;
      }

      // Filter scenarios by category
      function filterScenarios(categoryId, activeTab) {
        // Update active tab
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        activeTab.classList.add("active");

        // Re-render grid
        const grid = document.getElementById("scenarios-grid");
        if (grid) {
          renderScenarios(grid, categoryId);
        }
      }

      // Render scenarios grid
      function renderScenarios(grid, categoryFilter) {
        grid.innerHTML = "";

        const scenarios = conversationScenariosData.scenarios.filter(
          (scenario) => {
            if (categoryFilter === "all") return true;
            return scenario.category === categoryFilter;
          }
        );

        scenarios.forEach((scenario) => {
          const card = createScenarioCard(scenario);
          grid.appendChild(card);
        });
      }

      // Create scenario card
      function createScenarioCard(scenario) {
        const card = document.createElement("div");
        const isCompleted = completedScenarios.has(scenario.id);
        const isUnlocked = isScenarioUnlocked(scenario);

        card.className = `scenario-card ${isCompleted ? "completed" : ""} ${
          !isUnlocked ? "locked" : ""
        }`;

        card.innerHTML = `
                <div class="scenario-card-header">
                  <span class="scenario-icon">${scenario.icon}</span>
                  <div class="scenario-info">
                    <h3 class="scenario-name">${scenario.name}</h3>
                    <span class="scenario-difficulty ${scenario.difficulty}">${
          scenario.difficulty
        }</span>
                  </div>
                </div>
                <p class="scenario-description">${scenario.description}</p>
                <div class="scenario-meta">
                  <span class="scenario-turns">💬 ${
                    scenario.estimated_turns
                  } turns</span>
                  ${
                    isCompleted
                      ? '<span style="color: #10B981;">✓ Completed</span>'
                      : ""
                  }
                </div>
                ${
                  isCompleted
                    ? '<span class="scenario-badge">✓ Done</span>'
                    : ""
                }
                ${
                  !isUnlocked
                    ? '<span class="scenario-badge locked">🔒 Locked</span>'
                    : ""
                }
              `;

        if (isUnlocked) {
          card.onclick = () => startScenario(scenario);
        }

        return card;
      }

      // Close scenarios modal
      function closeScenariosModal() {
        const modal = document.getElementById("scenarios-modal");
        if (modal) {
          modal.remove();
        }
      }

      // Start a scenario
      function startScenario(scenario) {
        activeScenario = scenario;
        currentTurn = 0;
        scenarioDialogue = [];

        closeScenariosModal();
        renderActiveScenario();

        // Start with first turn (usually NPC speaking)
        processNextTurn();
      }

      // Render active scenario interface
      function renderActiveScenario() {
        // Hide the sentence builder and phrases sections temporarily
        const leftColumn = document.querySelector(
          ".md\\:w-1\\/2.flex.flex-col.gap-6"
        );
        if (!leftColumn) return;

        // Create scenario container
        const scenarioContainer = document.createElement("div");
        scenarioContainer.id = "active-scenario-container";
        scenarioContainer.className = "scenario-active";

        scenarioContainer.innerHTML = `
                <div class="scenario-active-header">
                  <div class="scenario-active-title">
                    <span class="scenario-active-icon">${activeScenario.icon}</span>
                    <div class="scenario-active-info">
                      <h3>${activeScenario.name}</h3>
                      <p class="scenario-active-meta">${activeScenario.description}</p>
                    </div>
                  </div>
                  <button class="scenario-exit-btn" onclick="exitScenario()">Exit Scenario</button>
                </div>

                <div class="cultural-note">
                  <span class="cultural-note-icon">💡</span>
                  <p><strong>Cultural Tip:</strong> ${activeScenario.cultural_note}</p>
                </div>

                <div class="scenario-progress" id="scenario-progress"></div>

                <div class="dialogue-container" id="dialogue-container"></div>

                <div class="player-input-section" id="player-input-section" style="display: none;">
                  <div class="input-hints" id="input-hints"></div>
                  <div class="scenario-input-container">
                    <input
                      type="text"
                      class="scenario-input"
                      id="scenario-input"
                      placeholder="Type your response in Italian..."
                    />
                    <button class="scenario-submit-btn" id="scenario-submit-btn">Send</button>
                  </div>
                </div>
              `;

        // Insert at top of left column
        leftColumn.insertBefore(scenarioContainer, leftColumn.firstChild);

        // Update progress dots
        updateProgressDots();
      }

      document.addEventListener("click", function (e) {
        if (e.target && e.target.id === "scenario-submit-btn") {
          submitScenarioResponse();
        }
      });

      // Process next turn in dialogue
      function processNextTurn() {
        if (currentTurn >= activeScenario.dialogue_flow.length) {
          // Scenario complete!
          completeScenario();
          return;
        }

        const turn = activeScenario.dialogue_flow[currentTurn];

        if (
          turn.speaker === "customer" ||
          turn.speaker === "tourist" ||
          turn.speaker === "guest" ||
          turn.speaker === "caller" ||
          turn.speaker === "diner"
        ) {
          // Player's turn
          showPlayerInput(turn);
        } else {
          // NPC's turn
          displayNPCMessage(turn);
          currentTurn++;

          // After NPC speaks, show player input if next turn is player's
          setTimeout(() => {
            processNextTurn();
          }, 1000);
        }

        updateProgressDots();
      }

      // Display NPC message
      function displayNPCMessage(turn) {
        const container = document.getElementById("dialogue-container");
        if (!container) return;

        const message = document.createElement("div");
        message.className = "dialogue-message npc";

        message.innerHTML = `
                <div class="dialogue-bubble npc">
                  <div class="dialogue-speaker">${turn.speaker}</div>
                  <div class="dialogue-text">${turn.text_italian}</div>
                  <div class="dialogue-translation">${turn.text_english}</div>
                  ${
                    turn.audio_hint
                      ? `<div class="dialogue-audio-hint">🔊 ${turn.audio_hint}</div>`
                      : ""
                  }
                  <button class="dialogue-listen-btn" onclick="speakText('${
                    turn.text_italian
                  }', '${currentLanguage}')">
                    <i class="fas fa-volume-up"></i> Listen
                  </button>
                </div>
              `;

        container.appendChild(message);
        scenarioDialogue.push({
          speaker: turn.speaker,
          text: turn.text_italian,
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      }

      // Show player input section
      function showPlayerInput(turn) {
        const inputSection = document.getElementById("player-input-section");
        const hintsContainer = document.getElementById("input-hints");

        if (!inputSection || !hintsContainer) return;

        // Show hints
        hintsContainer.innerHTML = `
                <div class="input-hints-title">💡 Hints for this response:</div>
              `;

        turn.hints.forEach((hint) => {
          const hintItem = document.createElement("div");
          hintItem.className = "hint-item";
          hintItem.innerHTML = `<span>💬</span> ${hint}`;
          hintsContainer.appendChild(hintItem);
        });

        // Show vocabulary chips
        if (turn.vocabulary && turn.vocabulary.length > 0) {
          const vocabContainer = document.createElement("div");
          vocabContainer.className = "vocabulary-chips";

          turn.vocabulary.forEach((word) => {
            const chip = document.createElement("span");
            chip.className = "vocab-chip";
            chip.textContent = word;
            chip.onclick = () => {
              const input = document.getElementById("scenario-input");
              if (input) {
                input.value += (input.value ? " " : "") + word;
                input.focus();
              }
            };
            vocabContainer.appendChild(chip);
          });

          hintsContainer.appendChild(vocabContainer);
        }

        inputSection.style.display = "block";

        // Focus input
        const input = document.getElementById("scenario-input");
        if (input) {
          input.focus();
          input.value = "";

          // Handle Enter key
          input.onkeydown = (e) => {
            if (e.key === "Enter") {
              submitScenarioResponse();
            }
          };
        }
      }

      // Submit player response
      async function submitScenarioResponse() {
        const input = document.getElementById("scenario-input");
        if (!input || !input.value.trim()) return;

        const playerResponse = input.value.trim();
        const turn = activeScenario.dialogue_flow[currentTurn];

        // Display player message
        displayPlayerMessage(playerResponse);

        // Hide input section
        document.getElementById("player-input-section").style.display = "none";

        // Check response with AI
        await checkScenarioResponse(playerResponse, turn);
      }

      // Display player message
      function displayPlayerMessage(text) {
        const container = document.getElementById("dialogue-container");
        if (!container) return;

        const message = document.createElement("div");
        message.className = "dialogue-message player";

        message.innerHTML = `
                <div class="dialogue-bubble player">
                  <div class="dialogue-speaker">You</div>
                  <div class="dialogue-text">${text}</div>
                </div>
              `;

        container.appendChild(message);
        scenarioDialogue.push({ speaker: "player", text: text });

        container.scrollTop = container.scrollHeight;
      }

      // Check scenario response with AI
      async function checkScenarioResponse(playerResponse, turn) {
        const expectedPatterns = turn.expected_patterns.join(", ");

        const userPrompt = `In a conversation scenario, the user said: "${playerResponse}".
            Expected patterns were: ${expectedPatterns}.
            Context: ${activeScenario.description}.
            Is this response appropriate and correct? If yes, respond with "CORRECT" and brief encouragement.
            If no, respond with "INCORRECT" and provide a gentle correction with one of the expected patterns.`;

        const systemPrompt = `You are a supportive Italian language tutor evaluating conversational responses. Be encouraging but accurate.`;

        try {
          // Use simple approach - just check if response is reasonable
          const isGoodEnough = turn.expected_patterns.some((pattern) => {
            const patternWords = pattern.toLowerCase().split(" ");
            const responseWords = playerResponse.toLowerCase().split(" ");
            return patternWords.some((word) => responseWords.includes(word));
          });

          if (isGoodEnough) {
            // Correct - move to next turn
            currentTurn++;
            setTimeout(() => {
              processNextTurn();
            }, 500);
          } else {
            // Show hint
            showModal(
              "Try Again",
              `Try using: "${turn.expected_patterns[0]}"`,
              false
            );

            // Allow retry
            showPlayerInput(turn);
          }
        } catch (error) {
          console.error("Error checking response:", error);
          // On error, just accept and continue
          currentTurn++;
          processNextTurn();
        }
      }

      // Complete scenario
      function completeScenario() {
        saveCompletedScenario(activeScenario.id);

        const container = document.getElementById("dialogue-container");
        if (!container) return;

        container.innerHTML = `
                <div class="scenario-completion">
                  <div class="completion-icon">🎉</div>
                  <h2 class="completion-title">Scenario Complete!</h2>
                  <p class="completion-message">Great job! You successfully completed "${activeScenario.name}"</p>

                  <div class="completion-stats">
                    <div class="completion-stat">
                      <div class="completion-stat-value">${scenarioDialogue.length}</div>
                      <div class="completion-stat-label">Turns</div>
                    </div>
                    <div class="completion-stat">
                      <div class="completion-stat-value">${activeScenario.estimated_turns}</div>
                      <div class="completion-stat-label">Expected</div>
                    </div>
                  </div>

                  <div class="completion-actions">
                    <button class="completion-btn completion-btn-primary" onclick="openScenariosModal()">
                      Try Another Scenario
                    </button>
                    <button class="completion-btn completion-btn-secondary" onclick="exitScenario()">
                      Back to Lessons
                    </button>
                  </div>
                </div>
              `;
      }

      // Exit scenario
      function exitScenario() {
        const container = document.getElementById("active-scenario-container");
        if (container) {
          container.remove();
        }

        activeScenario = null;
        currentTurn = 0;
        scenarioDialogue = [];
      }

      // Update progress dots
      function updateProgressDots() {
        const progressContainer = document.getElementById("scenario-progress");
        if (!progressContainer || !activeScenario) return;

        progressContainer.innerHTML = "";

        for (let i = 0; i < activeScenario.dialogue_flow.length; i++) {
          const dot = document.createElement("div");
          dot.className = "progress-dot";

          if (i < currentTurn) {
            dot.classList.add("completed");
          } else if (i === currentTurn) {
            dot.classList.add("current");
          }

          progressContainer.appendChild(dot);
        }
      }

      // DISABLED - Moved to hamburger menu
      /*
      function addConversationButton() {
        // Find the chat section header
        const chatHeader =
          document.querySelector("#chat-history").previousElementSibling;

        if (chatHeader) {
          // Existing conversation button
          const button = document.createElement("button");
          button.className =
            "py-2 px-4 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition duration-150";
          button.innerHTML = "🎭 Practice Conversations";
          button.onclick = openScenariosModal;
          button.style.marginLeft = "auto";
          chatHeader.appendChild(button);

          // ADD THIS: Pronunciation button
          const pronButton = document.createElement("button");
          pronButton.id = "pronunciation-practice-btn";
          pronButton.className =
            "py-2 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition duration-150";
          pronButton.innerHTML = "🗣️ Pronunciation";
          pronButton.onclick = openPronunciationModal;
          pronButton.style.marginLeft = "8px";
          chatHeader.appendChild(pronButton);
        }
      }
      */

      // Initialize Phase 3
      async function initializePhase3() {
        console.log("🚀 Initializing Phase 3: Conversation Scenarios...");

        const loaded = await loadConversationScenarios();

        if (loaded && auth.currentUser) {
          await loadCompletedScenarios();
          // addConversationButton(); // DISABLED - moved to hamburger menu
          console.log("✅ Phase 3 ready!");
          return true;
        } else {
          console.warn("⚠️ Phase 3 data not fully loaded");
          return false;
        }
      }

      // Load enhancement data
      async function loadEnhancementData() {
        try {
          const contextsResponse = await fetch("contexts.json");
          contextsData = await contextsResponse.json();

          const altExpResponse = await fetch("alternativeExpressions.json");
          alternativeExpressionsData = await altExpResponse.json();

          console.log("✅ Phase 1 enhancement data loaded");
          return true;
        } catch (error) {
          console.warn("⚠️ Could not load enhancement data:", error);
          return false;
        }
      }

      // Create context badge
      function createContextBadge(contextId) {
        if (!contextsData || !contextId) return null;

        const context = contextsData.contexts.find((c) => c.id === contextId);
        if (!context) return null;

        const badge = document.createElement("span");
        badge.className = "context-badge";
        badge.style.borderColor = context.color;
        badge.title = context.description;
        badge.innerHTML = `<span class="context-icon">${context.icon}</span> ${context.name}`;

        return badge;
      }

      // Show alternative expressions
      function showAlternativeExpressions(phraseText) {
        if (!alternativeExpressionsData) return null;

        const alternatives =
          alternativeExpressionsData.alternativeExpressions[phraseText];
        if (!alternatives || alternatives.length === 0) return null;

        const panel = document.createElement("div");
        panel.className = "alternatives-panel";

        // Header
        panel.innerHTML = `
                <div class="alternatives-header">
                  <h4 class="alternatives-title">✨ Native speakers also say:</h4>
                  <button class="alternatives-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
                <div class="alternatives-original"><strong>You said:</strong> ${phraseText}</div>
              `;

        // Italian alternatives
        const italianAlts = alternatives.filter(
          (alt) => alt.region === "standard"
        );
        if (italianAlts.length > 0) {
          const section = document.createElement("div");
          section.className = "alternatives-section";
          section.innerHTML =
            '<h5 class="alternatives-section-title">🇮🇹 Italian Variations</h5>';

          const list = document.createElement("div");
          list.className = "alternatives-list";

          italianAlts.forEach((alt) => {
            const item = document.createElement("div");
            item.className = "alternative-item";
            item.innerHTML = `
                    <div class="alternative-header">
                      <span>${alt.type === "formal" ? "🎩" : "😊"}</span>
                      <span class="alternative-text">${alt.text}</span>
                      <span class="alternative-badge ${alt.type}">${
              alt.type
            }</span>
                    </div>
                    <p class="alternative-note">${alt.note}</p>
                  `;
            list.appendChild(item);
          });

          section.appendChild(list);
          panel.appendChild(section);
        }

        // Sicilian alternatives
        const sicilianAlts = alternatives.filter(
          (alt) => alt.region === "sicilian"
        );
        if (sicilianAlts.length > 0) {
          const section = document.createElement("div");
          section.className = "alternatives-section";
          section.innerHTML =
            '<h5 class="alternatives-section-title">🏝️ Sicilian Says...</h5>';

          const list = document.createElement("div");
          list.className = "alternatives-list";

          sicilianAlts.forEach((alt) => {
            const item = document.createElement("div");
            item.className = "alternative-item sicilian";
            item.innerHTML = `
                    <div class="alternative-header">
                      <span>🌊</span>
                      <span class="alternative-text">${alt.text}</span>
                    </div>
                    <p class="alternative-note">${alt.note}</p>
                  `;
            list.appendChild(item);
          });

          section.appendChild(list);
          panel.appendChild(section);
        }

        // Tip
        const tip = document.createElement("div");
        tip.className = "alternatives-tip";
        tip.innerHTML =
          "💡 <strong>Tip:</strong> Understanding these variations helps you sound more natural!";
        panel.appendChild(tip);

        return panel;
      }

      // --- Theme Management ---
      function setDarkMode(isDark) {
        if (isDark) {
          document.documentElement.classList.add("dark");
          document.getElementById("theme-icon").className = "fas fa-moon";
        } else {
          document.documentElement.classList.remove("dark");
          document.getElementById("theme-icon").className = "fas fa-sun";
        }
      }
      function initializeTheme() {
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const savedTheme = localStorage.getItem("theme");
        setDarkMode(
          savedTheme === "dark" || (!savedTheme && systemPrefersDark)
        );
      }
      document.getElementById("theme-toggle").onclick = () => {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        document.getElementById("theme-icon").className = isDark
          ? "fas fa-moon"
          : "fas fa-sun";
      };

      // --- Utility Functions (Modal) ---
      function showModal(title, message, isError = false) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-message").textContent = message;
        document.getElementById("modal-title").className = isError
          ? "text-xl font-bold mb-4 text-red-600"
          : "text-xl font-bold mb-4 text-green-600";
        modalContainer.classList.remove("hidden");
        modalContainer.classList.add("flex");
      }
      modalCloseBtn.onclick = () => {
        modalContainer.classList.add("hidden");
        modalContainer.classList.remove("flex");
      };

      function speakText(text, lang) {
        if (!("speechSynthesis" in window)) {
          showModal(
            "Audio Error",
            "Text-to-Speech is not supported in this browser.",
            true
          );
          return;
        }

        try {
          const utterance = new SpeechSynthesisUtterance(String(text ?? ""));
          if (!utterance.text.trim()) return;

          // Italian & Sicilian => it-IT; otherwise fall back to English (UK)
          const lower = String(lang || "").toLowerCase();
          const chosenLang =
            lower.includes("ital") || lower.includes("sici")
              ? "it-IT"
              : "en-GB";
          utterance.lang = chosenLang;

          // Prefer a matching voice if available
          const voices = window.speechSynthesis.getVoices();
          const match = voices.find(
            (v) => v.lang && v.lang.startsWith(chosenLang)
          );
          if (match) utterance.voice = match;

          // Quality tweaks
          utterance.rate = 0.95;
          utterance.pitch = 1.0;

          // Prevent overlap
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utterance);
        } catch (e) {
          console.warn("speakText failed:", e);
        }
      }

      window.speakText = speakText;

      function startRecognition(targetElement) {
        if (!("webkitSpeechRecognition" in window)) {
          showModal(
            "Mic Error",
            "Speech recognition is not supported in this browser.",
            true
          );
          return;
        }
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        // Use Italian for both, as Sicilian isn't a standard recognition language code
        recognition.lang = "it-IT";

        micChatBtn.disabled = true;
        micChatBtn.classList.add("bg-yellow-500", "hover:bg-yellow-500");
        micChatBtn.classList.remove("bg-red-500", "hover:bg-red-600");

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          if (targetElement === "chat") {
            chatInput.value = transcript;
          }
        };
        recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
          showModal("Mic Error", `Recognition failed: ${event.error}`, true);
          resetMicButton();
        };
        recognition.onend = () => {
          resetMicButton();
        };
        recognition.start();

        function resetMicButton() {
          micChatBtn.disabled = false;
          micChatBtn.classList.remove("bg-yellow-500", "hover:bg-yellow-500");
          micChatBtn.classList.add("bg-red-500", "hover:bg-red-600");
        }
      }

      // --- Firebase Setup and Persistence ---

      function getPrivateCollectionPath(collectionName) {
        return `/artifacts/${appId}/users/${userId}/${collectionName}`;
      }

      async function setupFirebase() {
        try {
          // Load config from Firebase Cloud Function
          firebaseConfig = await loadFirebaseConfig();

          if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("Firebase config not available");
            showModal(
              "Database Error",
              "Could not load database configuration.",
              true
            );
            return;
          }

          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          // setLogLevel('Debug');

          onAuthStateChanged(auth, async (user) => {
            if (!user) {
              window.location.href = "login.html";
              return;
            }

            userId = user.uid;
            const userEmail =
              user.email || (user.isAnonymous ? "Guest User" : "User");
            document.getElementById("user-id-display").textContent = userEmail;

            startChatListener();
            startProgressListener();

            // PHASE 2: Initialize progress tracking
            await loadGrammarMilestones();
            await loadUserProgressFromFirebase();

            // Add progress dashboard to UI
            const dashboardContainer = document.querySelector(
              ".md\\:w-1\\/2.flex.flex-col.gap-6"
            );
            if (dashboardContainer && grammarMilestonesData && userProgress) {
              const dashboard = createProgressDashboard();
              if (dashboard) {
                dashboardContainer.insertBefore(
                  dashboard,
                  dashboardContainer.firstChild
                );
              }
            }

            await initializePhase3();
            await initializePhase4();
          });
        } catch (error) {
          console.error("Firebase Initialization Error:", error);
          showModal(
            "Persistence Failure",
            "Could not connect to the database. History will not be saved.",
            true
          );
        }
      }

      function startProgressListener() {
        if (!db || !userId || !auth.currentUser) return;
        const progressDocRef = doc(
          db,
          getPrivateCollectionPath("progress"),
          "user_state"
        );

        onSnapshot(
          progressDocRef,
          (docSnap) => {
            const data = docSnap.data() || {};

            // 1. Load Mastery Status and Dynamic Phrases
            masteredPhraseIds = new Set(data.masteredIds || []);
            const dynamicPhrases = data.dynamicPhrases || [];

            // Combine static and dynamic phrases
            allPhrases = [...staticPhraseData];
            const existingDynamicIds = new Set(
              staticPhraseData.map((p) => p.id)
            );
            dynamicPhrases.forEach((dp) => {
              if (!existingDynamicIds.has(dp.id)) {
                allPhrases.push(dp);
                existingDynamicIds.add(dp.id);
              }
            });

            // 2. Update Mastery UI
            const totalMastered = Array.from(masteredPhraseIds).filter((id) =>
              id.startsWith("S")
            ).length;
            masteryStatus.textContent = `Mastery: ${totalMastered}/${MAX_STATIC_PHRASES} foundational phrases mastered.`;

            // 3. Load Current Lesson State
            const goalIdFromDB = data.currentGoalId || null;
            const langFromDB = data.language || languageSelect.value;

            currentGoalDisplay.textContent =
              data.currentGoal || "Loading a new sentence...";
            currentGoalId = goalIdFromDB;
            currentLanguage = langFromDB;
            languageSelect.value = currentLanguage;

            updateUILanguage();

            // 4. FIX: Use the flag to prevent the initial loop AND stop re-rendering the selected words on every DB change.
            if (!progressLoadedOnce) {
              progressLoadedOnce = true;
              // Only load selected words from DB on initial load
              currentSelectedWords = JSON.parse(data.selectedWords || "[]");
              updateSelectedSentenceUI(false); // Initial render is fine

              // Only select a new goal if the DB didn't provide one
              if (!currentGoalId) {
                selectNewPhraseOrGoal(true);
              } else {
                // If we have a goal from DB, populate word bank with it
                const currentPhrase = allPhrases.find(
                  (p) => p.id === currentGoalId
                );
                if (currentPhrase) {
                  const targetSentence =
                    currentLanguage === "Italian"
                      ? currentPhrase.italian
                      : currentPhrase.sicilian || currentPhrase.italian;
                  populateWordBank(targetSentence);
                }
              }
            } else if (langFromDB !== languageSelect.value) {
              // Handle language change from selector
              currentLanguage = languageSelect.value;
              selectNewPhraseOrGoal(true);
            }
          },
          (error) => {
            console.error("Error listening to user progress state:", error);
          }
        );
      }

      let saveProgressTimer = null;

      async function saveProgressState(goal, goalId, selectedWords) {
        if (!db || !userId || !auth.currentUser) return;

        clearTimeout(saveProgressTimer);
        saveProgressTimer = setTimeout(async () => {
          try {
            const progressDocRef = doc(
              db,
              getPrivateCollectionPath("progress"),
              "user_state"
            );

            // Get existing dynamic phrases to merge (safer read before write)
            const docSnap = await getDoc(progressDocRef);
            const existingData = docSnap.data() || {};

            await setDoc(
              progressDocRef,
              {
                currentGoal: goal,
                currentGoalId: goalId,
                // Save the user's current word selection
                selectedWords: JSON.stringify(selectedWords),
                masteredIds: Array.from(masteredPhraseIds), // Save the set as an array
                dynamicPhrases: existingData.dynamicPhrases || [],
                lastUpdated: serverTimestamp(),
                language: currentLanguage,
              },
              { merge: true }
            );
          } catch (error) {
            console.warn("Could not save progress state.", error);
          }
        }, 500);
      }

      async function saveDynamicPhrase(newPhrase) {
        if (!db || !userId || !auth.currentUser) return;
        try {
          const progressDocRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "user_state"
          );
          const docSnap = await getDoc(progressDocRef);
          const existingData = docSnap.data() || {};

          const currentDynamicPhrases = existingData.dynamicPhrases || [];

          // Prevent duplicate saves of the new phrase
          const isDuplicate = currentDynamicPhrases.some(
            (p) => p.id === newPhrase.id
          );
          if (!isDuplicate) {
            currentDynamicPhrases.push(newPhrase);
          }

          await setDoc(
            progressDocRef,
            {
              dynamicPhrases: currentDynamicPhrases,
              lastPhraseGenerated: serverTimestamp(),
            },
            { merge: true }
          );
        } catch (error) {
          console.warn("Could not save new dynamic phrase.", error);
        }
      }

      async function saveChatMessage(text, role) {
        if (!db || !userId || !auth.currentUser) return;
        try {
          const chatCollectionRef = collection(
            db,
            getPrivateCollectionPath("chat_history")
          );
          await addDoc(chatCollectionRef, {
            text: text,
            role: role,
            timestamp: serverTimestamp(),
            userId: userId,
            language: currentLanguage,
          });
        } catch (error) {
          console.warn("Could not save chat message.", error);
        }
      }

      function startChatListener() {
        if (!db || !userId || !auth.currentUser) return;

        const chatCollectionRef = collection(
          db,
          getPrivateCollectionPath("chat_history")
        );
        const q = query(chatCollectionRef, limit(50));

        onSnapshot(
          q,
          (snapshot) => {
            chatHistoryContainer.innerHTML = "";
            let messages = [];

            snapshot.docs.forEach((doc) => messages.push(doc.data()));
            messages.sort(
              (a, b) =>
                (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)
            );

            messages.forEach((message) =>
              appendChatMessage(message.text, message.role === "user")
            );
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;

            if (messages.length === 0) {
              appendChatMessage(
                `Ciao! Welcome to your ${currentLanguage} lesson.`,
                false
              );
            }
          },
          (error) => {
            console.error("Error listening to chat history:", error);
            showModal(
              "Chat History Error",
              "Could not load chat history.",
              true
            );
          }
        );
      }

      // --- Language & UI Management ---

      function updateUILanguage() {
        const langCode =
          currentLanguage === "Italian" ? "🇮🇹 Italian" : "🟡 Sicilian";
        document.getElementById("app-language-display").textContent = langCode;
        populatePhrases();
      }

      languageSelect.onchange = (e) => {
        currentLanguage = e.target.value;
        // Force a state save to trigger a language/goal refresh
        updateUILanguage();
        clearSentence();
        selectNewPhraseOrGoal(true);
      };

      // Level selector handler
      const levelSelect = document.getElementById("level-select");
      levelSelect.onchange = (e) => {
        currentLevel = e.target.value;
        populateWordBank(); // Refresh word bank with new level
        clearSentence();
        selectNewPhraseOrGoal(true); // Get new phrase appropriate for level
      };

      function populateWordBank(targetSentence = null) {
        wordBankContainer.innerHTML = "";

        // Get words for current level
        const levelData = wordBankData[currentLevel];
        if (!levelData) return;

        // Flatten all categories into a single array for distractor words
        let allWords = [];
        Object.keys(levelData).forEach((category) => {
          if (Array.isArray(levelData[category])) {
            allWords = allWords.concat(levelData[category]);
          }
        });

        // Extract words from target sentence if provided
        let targetWords = [];
        if (targetSentence && targetSentence.trim() !== "") {
          // Split by spaces and clean up punctuation
          targetWords = targetSentence
            .split(/\s+/)
            .map((word) => word.replace(/[.,!?;:"""'']/g, "").trim())
            .filter((word) => word.length > 0);
        }

        // Remove target words from distractor pool to avoid duplicates
        const targetWordsLower = targetWords.map((w) => w.toLowerCase());
        const distractorWords = allWords.filter(
          (word) => !targetWordsLower.includes(word.toLowerCase())
        );

        // Shuffle distractor words
        distractorWords.sort(() => Math.random() - 0.5);

        // Calculate how many distractors we need to reach ~50 total words
        const totalWords = 50;
        const distractorCount = Math.max(0, totalWords - targetWords.length);

        // Combine target words + distractors
        const finalWordList = [
          ...targetWords,
          ...distractorWords.slice(0, distractorCount),
        ];

        // Shuffle the final list so target words aren't all at the start
        finalWordList.sort(() => Math.random() - 0.5);

        // Display all words
        finalWordList.forEach((word) => {
          wordBankContainer.appendChild(createWordElement(word, false));
        });
      }

      function populatePhrases() {
        const phrases = commonPhrases[currentLanguage] || [];
        phraseListContainer.innerHTML = "";

        phrases.forEach((phrase) => {
          const phraseDiv = document.createElement("div");
          phraseDiv.className =
            "p-3 rounded-lg border border-gray-200 hover:bg-indigo-50 transition duration-150 cursor-pointer flex flex-col gap-2 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-500";

          // Top row with text and listen button
          const topRow = document.createElement("div");
          topRow.className = "flex items-center justify-between";

          const textContainer = document.createElement("div");
          textContainer.innerHTML = `
                  <p class="font-semibold">${phrase.text}</p>
                  <p class="text-sm text-gray-500 dark:text-gray-400 italic">${phrase.english}</p>
                `;

          const listenBtn = document.createElement("button");
          listenBtn.className = "audio-btn text-pink-600 dark:text-pink-400";
          listenBtn.title = `Listen to ${currentLanguage}`;
          listenBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          listenBtn.onclick = (e) => {
            e.stopPropagation();
            speakText(phrase.text, currentLanguage);
          };

          topRow.appendChild(textContainer);
          topRow.appendChild(listenBtn);
          phraseDiv.appendChild(topRow);

          // Add context badge if available
          if (phrase.context && contextsData) {
            const badge = createContextBadge(phrase.context);
            if (badge) {
              phraseDiv.appendChild(badge);
            }
          }

          // Click handler for phrase
          phraseDiv.onclick = () => {
            chatInput.value = phrase.text;
            chatInput.focus();

            // Show alternative expressions
            const existingPanel = phraseListContainer.querySelector(
              ".alternatives-panel"
            );
            if (existingPanel) {
              existingPanel.remove();
            }

            const altPanel = showAlternativeExpressions(phrase.text);
            if (altPanel) {
              phraseDiv.parentElement.insertBefore(
                altPanel,
                phraseDiv.nextSibling
              );
            }
          };

          phraseListContainer.appendChild(phraseDiv);
        });
      }

      // Tab switching for Phrases/Verb Trainer
      const phrasesTabBtn = document.getElementById("phrases-tab-btn");
      const verbsTabBtn = document.getElementById("verbs-tab-btn");
      const phrasesTabContent = document.getElementById("phrases-tab-content");
      const verbsTabContent = document.getElementById("verbs-tab-content");

      phrasesTabBtn.onclick = () => {
        phrasesTabBtn.className =
          "tab-btn px-4 py-2 font-semibold text-pink-600 border-b-2 border-pink-600 transition duration-150";
        verbsTabBtn.className =
          "tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-purple-600 transition duration-150";
        phrasesTabContent.classList.remove("hidden");
        verbsTabContent.classList.add("hidden");
      };

      verbsTabBtn.onclick = () => {
        verbsTabBtn.className =
          "tab-btn px-4 py-2 font-semibold text-purple-600 border-b-2 border-purple-600 transition duration-150";
        phrasesTabBtn.className =
          "tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-pink-600 transition duration-150";
        verbsTabContent.classList.remove("hidden");
        phrasesTabContent.classList.add("hidden");
        populateVerbSelector(); // Load verbs when tab opens
      };

      // Populate verb selector dropdown
      function populateVerbSelector() {
        const verbSelect = document.getElementById("verb-select");
        const verbs = verbDatabase[currentLanguage]?.level1 || [];

        verbSelect.innerHTML = '<option value="">Choose a verb...</option>';

        verbs.forEach((verb, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${verb.infinitive} (${verb.english})`;
          verbSelect.appendChild(option);
        });
      }

      // Handle verb selection
      document.getElementById("verb-select").onchange = (e) => {
        const index = e.target.value;
        if (index === "") {
          document.getElementById("verb-info").classList.add("hidden");
          document
            .getElementById("conjugation-exercise")
            .classList.add("hidden");
          document
            .getElementById("verb-empty-state")
            .classList.remove("hidden");
          return;
        }

        const verbs = verbDatabase[currentLanguage]?.level1 || [];
        currentVerb = verbs[index];

        // Show verb info
        document.getElementById("verb-infinitive").textContent =
          currentVerb.infinitive;
        document.getElementById("verb-english").textContent =
          currentVerb.english;
        document.getElementById("verb-type").textContent =
          "Type: " + currentVerb.type.replace(/_/g, " ");
        document.getElementById("verb-info").classList.remove("hidden");

        // Show exercise
        document
          .getElementById("conjugation-exercise")
          .classList.remove("hidden");
        document.getElementById("verb-empty-state").classList.add("hidden");

        // Clear previous inputs
        resetVerbInputs();
      };

      // Reset verb inputs
      function resetVerbInputs() {
        const pronouns = ["io", "tu", "lui-lei", "noi", "voi", "loro"];
        pronouns.forEach((pronoun) => {
          const input = document.getElementById(`conj-${pronoun}`);
          const feedback = document.getElementById(`feedback-${pronoun}`);
          if (input) {
            input.value = "";
            input.className =
              "flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg";
          }
          if (feedback) feedback.innerHTML = "";
        });
      }

      // Check conjugations
      document.getElementById("check-conjugations-btn").onclick = () => {
        if (!currentVerb) return;

        const conjugations = currentVerb.conjugations[currentTense];
        const pronounMapping = {
          io: "io",
          tu: "tu",
          "lui-lei": "lui_lei",
          noi: "noi",
          voi: "voi",
          loro: "loro",
        };

        let correct = 0;
        let total = 0;

        Object.keys(pronounMapping).forEach((pronoun) => {
          const input = document.getElementById(`conj-${pronoun}`);
          const feedback = document.getElementById(`feedback-${pronoun}`);
          const userAnswer = input.value.trim().toLowerCase();
          const correctAnswer =
            conjugations[pronounMapping[pronoun]].toLowerCase();

          total++;

          if (userAnswer === correctAnswer) {
            correct++;
            input.className =
              "flex-grow p-2 border-2 border-green-500 bg-green-50 dark:bg-green-900 dark:border-green-400 rounded-lg";
            feedback.innerHTML = '<i class="fas fa-check text-green-500"></i>';
          } else {
            input.className =
              "flex-grow p-2 border-2 border-red-500 bg-red-50 dark:bg-red-900 dark:border-red-400 rounded-lg";
            feedback.innerHTML = '<i class="fas fa-times text-red-500"></i>';
          }

          // PHASE 2: Track each pronoun conjugation
          if (userProgress) {
            const isCorrect = userAnswer === correctAnswer;
            trackVerbPractice(currentVerb.infinitive, currentTense, isCorrect);
          }
        });

        verbTrainerScore.correct += correct;
        verbTrainerScore.total += total;
        document.getElementById(
          "score-display"
        ).textContent = `${verbTrainerScore.correct}/${verbTrainerScore.total}`;

        if (correct === total) {
          showModal("Perfect!", "🎉 All conjugations are correct!", false);
        }
      };

      // Show answers
      document.getElementById("show-answers-btn").onclick = () => {
        if (!currentVerb) return;

        const conjugations = currentVerb.conjugations[currentTense];
        const pronounMapping = {
          io: "io",
          tu: "tu",
          "lui-lei": "lui_lei",
          noi: "noi",
          voi: "voi",
          loro: "loro",
        };

        Object.keys(pronounMapping).forEach((pronoun) => {
          const input = document.getElementById(`conj-${pronoun}`);
          const correctAnswer = conjugations[pronounMapping[pronoun]];
          input.value = correctAnswer;
          input.className =
            "flex-grow p-2 border-2 border-blue-500 bg-blue-50 dark:bg-blue-900 dark:border-blue-400 rounded-lg";
        });
      };

      // Reset button
      document.getElementById("reset-verb-btn").onclick = () => {
        resetVerbInputs();
      };

      // --- Sentence Builder Logic ---

      function createWordElement(word, isSelected) {
        const element = document.createElement("span");
        element.textContent = word;

        if (isSelected) {
          element.className =
            "py-1 px-3 bg-indigo-500 text-white font-semibold rounded-full shadow-md cursor-pointer transition duration-150 hover:bg-indigo-600 text-sm";
          element.onclick = () => removeWord(word);
        } else {
          element.className =
            "py-2 px-3 bg-gray-200 text-gray-800 font-medium rounded-lg shadow-sm cursor-pointer transition duration-150 hover:bg-gray-300 text-sm dark:bg-gray-700 dark:text-gray-200";
          element.onclick = () => addWord(word);
        }
        return element;
      }

      function updateSelectedSentenceUI(save = true) {
        selectedSentenceContainer.innerHTML = "";
        if (currentSelectedWords.length === 0) {
          selectedSentenceContainer.innerHTML =
            '<span class="text-gray-500 italic">Tap words below to build your sentence...</span>';
        } else {
          const sentenceText = currentSelectedWords.join(" ");

          const listenBtn = document.createElement("button");
          listenBtn.className =
            "audio-btn ml-2 text-indigo-600 dark:text-indigo-400 p-2";
          listenBtn.title = `Listen to sentence`;
          listenBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          listenBtn.onclick = () => speakText(sentenceText, currentLanguage);

          currentSelectedWords.forEach((word) => {
            selectedSentenceContainer.appendChild(
              createWordElement(word, true)
            );
          });

          selectedSentenceContainer.appendChild(listenBtn);
        }
        if (save) {
          // The database write is now DECOUPLED from the listener re-render, solving the judder.
          saveProgressState(
            currentGoalDisplay.textContent,
            currentGoalId,
            currentSelectedWords
          );
        }
      }

      function addWord(word) {
        currentSelectedWords.push(word);
        updateSelectedSentenceUI();
      }

      function removeWord(wordToRemove) {
        const index = currentSelectedWords.indexOf(wordToRemove);
        if (index > -1) {
          currentSelectedWords.splice(index, 1);
        }
        updateSelectedSentenceUI();
      }

      function clearSentence() {
        currentSelectedWords = [];
        updateSelectedSentenceUI();
        document.getElementById("feedback-message").classList.add("hidden");
      }

      document.getElementById("clear-btn").onclick = clearSentence;

      listenGoalBtn.onclick = () => {
        // Find the current goal phrase's Italian/Sicilian text to speak
        const currentPhrase = allPhrases.find((p) => p.id === currentGoalId);
        const textToSpeak = currentPhrase
          ? currentLanguage === "Italian"
            ? currentPhrase.italian
            : currentPhrase.sicilian || currentPhrase.italian
          : "";
        if (textToSpeak) {
          speakText(textToSpeak, currentLanguage);
        } else {
          showModal(
            "Audio Error",
            "The foreign language sentence is not available for speaking.",
            true
          );
        }
      };

      // --- LLM Interaction ---

      async function postToGemini(userPrompt, systemPrompt, useSearch, isChat) {
        const modelName = "gemini-2.5-flash-preview-05-20";

        // Use Firebase Cloud Function proxy
        // Falls back to direct API call if running locally with API key
        const useProxy =
          typeof __gemini_api_key === "undefined" || !__gemini_api_key;

        let apiUrl, payload;

        if (useProxy) {
          // Use serverless function proxy
          apiUrl = "/api/gemini-proxy";
          payload = {
            userPrompt,
            systemPrompt,
            useSearch,
            modelName,
          };
        } else {
          // Direct API call (local development only)
          apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${__gemini_api_key}`;
          payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
          };
          if (useSearch) {
            payload.tools = [{ google_search: {} }];
          }
        }

        const maxRetries = 5;
        let delay = 1000;

        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              if (response.status === 429 && i < maxRetries - 1) {
                await new Promise((resolve) => setTimeout(resolve, delay));
                delay *= 2;
                continue;
              }
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const text =
              result.candidates?.[0]?.content?.parts?.[0]?.text ||
              "The tutor didn't provide a complete response.";

            if (isChat) {
              appendChatMessage(text, false);
              saveChatMessage(text, "tutor");
            } else {
              processSentenceCheckResponse(text);
            }

            return; // Success, break retry loop
          } catch (error) {
            console.error("Gemini API call failed:", error);
            if (i === maxRetries - 1 || error.message.includes("HTTP error")) {
              const errorMessage = isChat
                ? "Sorry, I can't connect to the tutor right now."
                : "Could not check sentence. Please try again.";
              showModal("Connection Error", errorMessage, true);
            }

            if (!isChat) {
              const feedbackMessage =
                document.getElementById("feedback-message");
              feedbackMessage.textContent =
                "Error: Could not check sentence. Please try again.";
              feedbackMessage.className =
                "mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-700 block dark:bg-red-900 dark:text-red-200";
            }
          }
        }
      }

      async function generateDynamicPhrase() {
        currentGoalDisplay.textContent = "Generating a new phrase using AI...";

        const targetLang =
          currentLanguage === "Sicilian"
            ? "Sicilian (Sicilianu)"
            : "Italian (Italiano)";
        const levelDescriptions = {
          level1:
            "beginner (A1-A2) using only present tense and basic vocabulary",
          level2:
            "intermediate (B1-B2) using past/future tenses and expanded vocabulary",
          level3:
            "advanced (C1-C2) using all tenses including subjunctive/conditional and complex structures",
        };
        const levelDesc =
          levelDescriptions[currentLevel] || levelDescriptions.level1;

        const structurePrompt = `Generate a new, unique sentence for a ${levelDesc} student in ${targetLang}. The sentence must be 5-10 words long. Provide the sentence in the requested language and its exact English translation.`;
        const systemPrompt = `You are a phrase generator. Respond STRICTLY in JSON format with the following schema:
                        {"english": "English translation", "${currentLanguage.toLowerCase()}": "Target language sentence"}.
                        Do not include any other text or explanation.`;

        const useProxy =
          typeof __gemini_api_key === "undefined" || !__gemini_api_key;

        try {
          const modelName = "gemini-2.5-flash-preview-05-20";
          let apiUrl, payload;

          if (useProxy) {
            // Use Firebase Cloud Function proxy
            apiUrl = "/api/gemini-proxy";
            payload = {
              userPrompt: structurePrompt,
              systemPrompt: systemPrompt,
              useSearch: false,
              modelName: modelName,
            };
          } else {
            // Direct API call (local development)
            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${__gemini_api_key}`;
            payload = {
              contents: [{ parts: [{ text: structurePrompt }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    english: { type: "STRING" },
                    [currentLanguage.toLowerCase()]: { type: "STRING" },
                  },
                },
              },
            };
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

          if (jsonText) {
            const newPhrase = JSON.parse(jsonText);
            const phraseId = "D" + Date.now();
            const phraseObject = {
              id: phraseId,
              english: newPhrase.english,
              [currentLanguage.toLowerCase()]:
                newPhrase[currentLanguage.toLowerCase()],
            };

            await saveDynamicPhrase(phraseObject);
            return phraseObject;
          } else {
            console.error("AI returned empty JSON or invalid structure.");
            return null;
          }
        } catch (error) {
          console.error("Error generating dynamic phrase:", error);
          showModal(
            "AI Generation Error",
            "Could not generate new lesson phrase.",
            true
          );
          return null;
        }
      }

      async function selectNewPhraseOrGoal(forceReload) {
        // Only proceed if we are forcing a reload (mastery, language change) or if no goal is set.
        if (!forceReload && currentGoalId) return;

        // 1. Determine Mastery Level
        const staticMasteredCount = Array.from(masteredPhraseIds).filter((id) =>
          id.startsWith("S")
        ).length;
        const percentageMastered =
          (staticMasteredCount / staticPhraseData.length) * 100;

        const unmasteredStatic = staticPhraseData.filter(
          (p) => !masteredPhraseIds.has(p.id)
        );
        let selectedPhrase = null;

        currentGoalDisplay.textContent = "Selecting next lesson...";

        // 2. Apply 50% Rule
        const isAdvanced = percentageMastered >= 50;

        if (
          isAdvanced &&
          (Math.random() < 0.5 || unmasteredStatic.length === 0)
        ) {
          // 50% chance to generate a new phrase, OR if static phrases are exhausted
          selectedPhrase = await generateDynamicPhrase();
        } else if (unmasteredStatic.length > 0) {
          // Focus on remaining static phrases
          const randomIndex = Math.floor(
            Math.random() * unmasteredStatic.length
          );
          selectedPhrase = unmasteredStatic[randomIndex];
        }

        // Fallback if AI or static choice failed
        if (!selectedPhrase) {
          selectedPhrase = {
            id: "FALLBACK",
            english: 'Try saying "Thank you" in your chosen language.',
            italian: "Grazie",
          };
        }

        // 3. Update UI and State
        const targetGoal = selectedPhrase.english;
        currentGoalId = selectedPhrase.id;
        currentGoalDisplay.textContent = targetGoal;

        // Get the Italian/Sicilian sentence for word bank
        const targetSentence =
          currentLanguage === "Italian"
            ? selectedPhrase.italian
            : selectedPhrase.sicilian || selectedPhrase.italian;

        clearSentence(); // Clear the builder for the new goal

        // Populate word bank with the target sentence words
        populateWordBank(targetSentence);

        // CRITICAL FIX: Only save state here after a selection is made to prevent the infinite loop on load.
        await saveProgressState(
          targetGoal,
          currentGoalId,
          currentSelectedWords
        );

        // The onSnapshot listener will fire now, but it won't re-trigger selectNewPhraseOrGoal
      }

      function processSentenceCheckResponse(text) {
        const feedbackMessage = document.getElementById("feedback-message");
        const isCorrect = text.toLowerCase().trim().startsWith("correct");

        feedbackMessage.textContent = text;
        feedbackMessage.className = isCorrect
          ? "mt-4 p-3 rounded-lg text-sm bg-green-100 text-green-700 block dark:bg-green-900 dark:text-green-200"
          : "mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-700 block dark:bg-red-900 dark:text-red-200";

        // PHASE 2: Track sentence building
        if (userProgress) {
          trackSentenceBuilt(isCorrect, "simple");
          trackVocabularyUsage(currentSelectedWords);
        }

        if (isCorrect && currentGoalId && currentGoalId !== "FALLBACK") {
          masteredPhraseIds.add(currentGoalId);
          clearSentence();
          selectNewPhraseOrGoal(true);
        }
      }

      // --- UI Event Handlers ---

      function appendChatMessage(text, isUser) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${
          isUser ? "justify-end" : "justify-start"
        }`;

        const bubble = document.createElement("div");
        bubble.className = `bubble p-3 shadow-md rounded-xl ${
          isUser
            ? "bg-indigo-500 text-white rounded-tr-none"
            : "bg-white border border-gray-200 text-gray-800 rounded-tl-none dark:bg-gray-700 dark:border-gray-500 dark:text-gray-200"
        }`;

        let formattedText = text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(
            /\[(.*?)\]\((.*?)\)/g,
            '<a href="$2" target="_blank" class="text-blue-400 hover:underline">$1</a>'
          );

        bubble.innerHTML = formattedText;
        messageDiv.appendChild(bubble);
        chatHistoryContainer.appendChild(messageDiv);
        chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
      }

      // Sentence Check Handler
      submitButton.onclick = async () => {
        if (currentSelectedWords.length === 0) {
          const feedbackMessage = document.getElementById("feedback-message");
          feedbackMessage.textContent =
            "Please select some words to form a sentence.";
          feedbackMessage.className =
            "mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-700 block dark:bg-red-900 dark:text-red-200";
          return;
        }

        submitButton.disabled = true;
        chatLoadingIndicator.textContent = "Checking sentence...";
        chatLoadingIndicator.classList.remove("hidden");

        const sentence = currentSelectedWords.join(" ");
        const goal = currentGoalDisplay.textContent;

        const currentPhrase = allPhrases.find((p) => p.id === currentGoalId);
        const expectedAnswer = currentPhrase
          ? currentLanguage === "Italian"
            ? currentPhrase.italian
            : currentPhrase.sicilian || currentPhrase.italian || ""
          : "";

        // System prompt now includes the expected answer for better grounding
        const userPrompt = `The user built the ${currentLanguage} sentence: "${sentence}". The goal was the English phrase: "${goal}". The expected target language answer is: "${expectedAnswer}". Analyze the user's sentence against the expected answer. 1) If it is grammatically correct and meets the goal, start your response with "Correct: " and provide positive feedback. 2) If it is incorrect or fails to meet the goal, start with "Incorrect: " and explain the error and provide the correct sentence.`;
        const systemPrompt = `You are a supportive, knowledgeable ${currentLanguage} language tutor. Your response must be concise and actionable.`;

        await postToGemini(userPrompt, systemPrompt, false, false);

        submitButton.disabled = false;
        chatLoadingIndicator.classList.add("hidden");
      };

      // Mic for Chat Handler
      micChatBtn.onclick = () => {
        startRecognition("chat");
      };

      // Chat Send Handler
      const handleChatSend = async () => {
        const message = chatInput.value.trim();
        if (message === "") return;

        appendChatMessage(message, true);
        saveChatMessage(message, "user");

        chatInput.value = "";
        chatSendButton.disabled = true;
        chatLoadingIndicator.textContent = "Tutor is thinking...";
        chatLoadingIndicator.classList.remove("hidden");

        const systemPrompt = `You are a highly knowledgeable and friendly ${currentLanguage} language tutor. Respond to the user's question with encouraging and detailed grammatical explanations, vocabulary help, or cultural context for the ${currentLanguage} language. Use Google search grounding for up-to-date facts.`;

        await postToGemini(message, systemPrompt, true, true);

        chatSendButton.disabled = false;
        chatLoadingIndicator.classList.add("hidden");
      };

      chatSendButton.onclick = handleChatSend;
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleChatSend();
        }
      });

      // ========================================
      // PHASE 4: PRONUNCIATION PRACTICE
      // ========================================

      let pronunciationTargetsData = null;
      let currentPronunciationTarget = null;
      let currentCategoryTargets = [];
      let currentTargetIndex = 0;
      let pronunciationRecognition = null;
      let isRecording = false;
      let pronunciationStats = {
        practiced: 0,
        totalScore: 0,
        streak: 0,
      };

      // Load pronunciation targets data
      async function loadPronunciationTargets() {
        try {
          const response = await fetch("pronunciationTargets.json");
          pronunciationTargetsData = await response.json();
          console.log("✅ Pronunciation targets loaded");
          return true;
        } catch (error) {
          console.warn("⚠️ Could not load pronunciation targets:", error);
          return false;
        }
      }

      // Open pronunciation modal
      function openPronunciationModal() {
        if (!pronunciationTargetsData) {
          showModal(
            "Pronunciation Practice Unavailable",
            "Data is not loaded. Please refresh.",
            true
          );
          return;
        }

        const modal = document.getElementById("pronunciation-modal");
        modal.classList.add("active");

        renderCategories();
      }

      // Close pronunciation modal
      function closePronunciationModal() {
        const modal = document.getElementById("pronunciation-modal");
        modal.classList.remove("active");
        stopPronunciationRecording();
      }

      // Render categories
      function renderCategories() {
        const container = document.getElementById("pronunciation-categories");
        container.innerHTML = "";

        pronunciationTargetsData.categories.forEach((category) => {
          const card = document.createElement("div");
          card.className = "pronunciation-category-card";
          card.innerHTML = `
                  <div class="category-card-icon">${category.icon}</div>
                  <div class="category-card-name">${category.name}</div>
                  <div class="category-card-description">${
                    category.description
                  }</div>
                  <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                    ${
                      category.difficulty.charAt(0).toUpperCase() +
                      category.difficulty.slice(1)
                    }
                  </div>
                `;

          card.onclick = () => selectCategory(category.id);
          container.appendChild(card);
        });
      }

      // Select category
      function selectCategory(categoryId) {
        // Highlight selected category
        document
          .querySelectorAll(".pronunciation-category-card")
          .forEach((card) => {
            card.classList.remove("active");
          });
        event.target
          .closest(".pronunciation-category-card")
          .classList.add("active");

        // Filter targets by category
        currentCategoryTargets = pronunciationTargetsData.targets.filter(
          (target) => target.category === categoryId
        );
        currentTargetIndex = 0;

        // Show practice area
        document.getElementById("pronunciation-categories").style.display =
          "none";
        document.getElementById("pronunciation-practice").style.display =
          "block";

        // Load first target
        loadPronunciationTarget();
      }

      // Load current pronunciation target
      function loadPronunciationTarget() {
        if (currentTargetIndex >= currentCategoryTargets.length) {
          // Category complete
          showCategoryComplete();
          return;
        }

        currentPronunciationTarget = currentCategoryTargets[currentTargetIndex];

        // Update UI
        document.getElementById("pron-text").textContent =
          currentPronunciationTarget.text;
        document.getElementById("pron-ipa").textContent =
          currentPronunciationTarget.ipa;
        document.getElementById("pron-english").textContent =
          currentPronunciationTarget.english;
        document.getElementById(
          "pron-focus"
        ).textContent = `Focus: ${currentPronunciationTarget.focus_sound}`;

        // Update tip
        document.getElementById("pron-tip").textContent =
          currentPronunciationTarget.tip;

        // Update mistakes
        if (
          currentPronunciationTarget.common_mistakes &&
          currentPronunciationTarget.common_mistakes.length > 0
        ) {
          document.getElementById("pron-mistake").textContent =
            currentPronunciationTarget.common_mistakes[0];
          document.getElementById("pron-mistakes-box").style.display = "block";
        } else {
          document.getElementById("pron-mistakes-box").style.display = "none";
        }

        // Hide feedback
        document.getElementById("pron-feedback").classList.remove("show");

        // Update progress
        const progress =
          ((currentTargetIndex + 1) / currentCategoryTargets.length) * 100;
        document.getElementById(
          "pron-progress-fill"
        ).style.width = `${progress}%`;
      }

      // Listen to native pronunciation
      function listenToPronunciation() {
        if (currentPronunciationTarget) {
          speakText(currentPronunciationTarget.text, "Italian");
        }
      }

      // Start pronunciation recording
      function startPronunciationRecording() {
        if (!("webkitSpeechRecognition" in window)) {
          showModal(
            "Microphone Error",
            "Speech recognition is not supported in this browser.",
            true
          );
          return;
        }

        const recordBtn = document.getElementById("pron-record-btn");
        const recordText = document.getElementById("pron-record-text");
        const waveform = document.getElementById("pron-waveform");

        if (isRecording) {
          stopPronunciationRecording();
          return;
        }

        isRecording = true;
        recordBtn.classList.add("recording");
        recordText.textContent = "Recording...";
        waveform.style.display = "flex";

        // Initialize speech recognition
        pronunciationRecognition = new webkitSpeechRecognition();
        pronunciationRecognition.lang = "it-IT";
        pronunciationRecognition.continuous = false;
        pronunciationRecognition.interimResults = false;

        pronunciationRecognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript.toLowerCase();
          const confidence = event.results[0][0].confidence;

          stopPronunciationRecording();
          analyzePronunciation(transcript, confidence);
        };

        pronunciationRecognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
          stopPronunciationRecording();
          showModal(
            "Recognition Error",
            "Could not understand. Please try again.",
            true
          );
        };

        pronunciationRecognition.onend = () => {
          if (isRecording) {
            stopPronunciationRecording();
          }
        };

        pronunciationRecognition.start();
      }

      // Stop pronunciation recording
      function stopPronunciationRecording() {
        if (pronunciationRecognition) {
          try {
            pronunciationRecognition.stop();
          } catch (e) {
            console.log("Recognition already stopped");
          }
          pronunciationRecognition = null;
        }

        isRecording = false;

        // Safely update UI elements (check if they exist)
        const recordBtn = document.getElementById("pron-record-btn");
        const recordText = document.getElementById("pron-record-text");
        const waveform = document.getElementById("pron-waveform");

        if (recordBtn) {
          recordBtn.classList.remove("recording");
        }
        if (recordText) {
          recordText.textContent = "Record Yourself";
        }
        if (waveform) {
          waveform.style.display = "none";
        }
      }

      // Analyze pronunciation
      function analyzePronunciation(spokenText, confidence) {
        const target = currentPronunciationTarget.text.toLowerCase().trim();
        const spoken = spokenText.toLowerCase().trim();

        // Remove punctuation for better matching
        const cleanTarget = target.replace(/[.,!?;:]/g, "");
        const cleanSpoken = spoken.replace(/[.,!?;:]/g, "");

        let score = 0;

        // Exact match
        if (cleanSpoken === cleanTarget) {
          score = Math.round(confidence * 100);
        }
        // Close match (Levenshtein-like similarity)
        else {
          const targetWords = cleanTarget.split(" ");
          const spokenWords = cleanSpoken.split(" ");

          let matchCount = 0;

          // Check for exact word matches
          targetWords.forEach((targetWord) => {
            if (spokenWords.includes(targetWord)) {
              matchCount++;
            } else {
              // Check for similar words (allow small variations)
              spokenWords.forEach((spokenWord) => {
                if (isSimilar(targetWord, spokenWord)) {
                  matchCount += 0.8; // Partial credit for close matches
                }
              });
            }
          });

          // Helper function to check word similarity
          function isSimilar(word1, word2) {
            // If words are very short, require exact match
            if (word1.length <= 2 || word2.length <= 2) {
              return word1 === word2;
            }

            // Check if one word contains the other
            if (word1.includes(word2) || word2.includes(word1)) {
              return true;
            }

            // Check Levenshtein distance (allow 1-2 character difference)
            const maxDistance = Math.max(1, Math.floor(word1.length * 0.3));
            const distance = levenshteinDistance(word1, word2);
            return distance <= maxDistance;
          }

          // Calculate Levenshtein distance between two strings
          function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
              matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
              matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
              for (let j = 1; j <= str1.length; j++) {
                if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                  matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                  matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                  );
                }
              }
            }

            return matrix[str2.length][str1.length];
          }

          // Calculate score with minimum of 30% for any attempt
          const matchRatio = matchCount / targetWords.length;
          score = Math.max(30, Math.round(matchRatio * confidence * 100));
        }

        // Ensure score is between 0-100
        score = Math.max(0, Math.min(100, score));

        // Update stats
        pronunciationStats.practiced++;
        pronunciationStats.totalScore += score;

        if (score >= 75) {
          pronunciationStats.streak++;
        } else {
          pronunciationStats.streak = 0;
        }

        // Show feedback
        displayPronunciationFeedback(spoken, score);

        // Update stats display
        updatePronunciationStats();
      }

      // Display pronunciation feedback
      function displayPronunciationFeedback(spokenText, score) {
        const feedbackBox = document.getElementById("pron-feedback");
        const scoreNumber = document.getElementById("pron-score-number");
        const scoreLabel = document.getElementById("pron-score-label");
        const youSaid = document.getElementById("pron-you-said");
        const targetText = document.getElementById("pron-target");

        // Update comparison
        youSaid.textContent = spokenText;
        targetText.textContent = currentPronunciationTarget.text;

        // Update score
        scoreNumber.textContent = `${score}%`;

        // Determine score category
        const scoringCriteria = pronunciationTargetsData.scoring_criteria;
        let category = "needs_work";
        let message = scoringCriteria.needs_work.message;

        if (score >= scoringCriteria.excellent.threshold) {
          category = "excellent";
          message = scoringCriteria.excellent.message;
        } else if (score >= scoringCriteria.good.threshold) {
          category = "good";
          message = scoringCriteria.good.message;
        } else if (score >= scoringCriteria.fair.threshold) {
          category = "fair";
          message = scoringCriteria.fair.message;
        }

        scoreNumber.className = `score-display ${category}`;
        scoreLabel.textContent = message;

        // Show feedback
        feedbackBox.classList.add("show");
      }

      // Update pronunciation stats
      function updatePronunciationStats() {
        document.getElementById("pron-stat-practiced").textContent =
          pronunciationStats.practiced;

        const avgScore =
          pronunciationStats.practiced > 0
            ? Math.round(
                pronunciationStats.totalScore / pronunciationStats.practiced
              )
            : 0;
        document.getElementById(
          "pron-stat-accuracy"
        ).textContent = `${avgScore}%`;

        document.getElementById("pron-stat-streak").textContent =
          pronunciationStats.streak;
      }

      // Next pronunciation target
      function nextPronunciationTarget() {
        currentTargetIndex++;
        loadPronunciationTarget();
      }

      // Show category complete
      function showCategoryComplete() {
        const practiceArea = document.getElementById("pronunciation-practice");
        practiceArea.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                  <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
                  <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 12px;">Category Complete!</h2>
                  <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 24px;">
                    Great work! You've completed all targets in this category.
                  </p>
                  <div style="display: flex; justify-content: center; gap: 12px;">
                    <button class="pronunciation-btn pronunciation-btn-next" onclick="backToCategories()">
                      Try Another Category
                    </button>
                    <button class="pronunciation-btn pronunciation-btn-secondary" onclick="closePronunciationModal()">
                      Finish
                    </button>
                  </div>
                </div>
              `;
      }

      // Back to categories
      function backToCategories() {
        document.getElementById("pronunciation-categories").style.display =
          "grid";
        document.getElementById("pronunciation-practice").style.display =
          "none";
        document.getElementById("pronunciation-practice").innerHTML = `
                <div class="pronunciation-target">
                  <div class="pronunciation-text" id="pron-text">casa</div>
                  <div class="pronunciation-ipa" id="pron-ipa">/ˈka.sa/</div>
                  <div class="pronunciation-english" id="pron-english">house</div>
                  <span class="pronunciation-focus" id="pron-focus">Focus: a sound</span>
                </div>
                <div class="pronunciation-controls">
                  <button class="pronunciation-btn pronunciation-btn-listen" onclick="listenToPronunciation()">
                    <i class="fas fa-volume-up"></i> Listen to Native
                  </button>
                  <button class="pronunciation-btn pronunciation-btn-record" id="pron-record-btn" onclick="startPronunciationRecording()">
                    <i class="fas fa-microphone"></i>
                    <span id="pron-record-text">Record Yourself</span>
                  </button>
                </div>
                <div class="waveform" id="pron-waveform" style="display: none;">
                  <div class="waveform-bar"></div>
                  <div class="waveform-bar"></div>
                  <div class="waveform-bar"></div>
                  <div class="waveform-bar"></div>
                  <div class="waveform-bar"></div>
                </div>
                <div id="pron-feedback" class="pronunciation-feedback">
                  <div class="pronunciation-score">
                    <div class="score-display excellent" id="pron-score-number">85%</div>
                    <div class="score-label" id="pron-score-label">Good job! Almost there!</div>
                  </div>
                  <div class="pronunciation-comparison">
                    <div class="comparison-box">
                      <div class="comparison-label">You Said</div>
                      <div class="comparison-text" id="pron-you-said">casa</div>
                    </div>
                    <div class="comparison-box">
                      <div class="comparison-label">Target</div>
                      <div class="comparison-text" id="pron-target">casa</div>
                    </div>
                  </div>
                  <div class="pronunciation-tips">
                    <div class="tips-title"><i class="fas fa-lightbulb"></i> Pronunciation Tip</div>
                    <div class="tips-content" id="pron-tip"></div>
                  </div>
                  <div class="pronunciation-mistakes" id="pron-mistakes-box">
                    <div class="mistakes-title"><i class="fas fa-exclamation-triangle"></i> Common Mistake</div>
                    <div class="mistakes-content" id="pron-mistake"></div>
                  </div>
                  <button class="pronunciation-btn pronunciation-btn-next" onclick="nextPronunciationTarget()">
                    Next Word <i class="fas fa-arrow-right"></i>
                  </button>
                </div>
                <div class="pronunciation-stats">
                  <div class="pronunciation-stat-card">
                    <div class="stat-number" id="pron-stat-practiced">0</div>
                    <div class="stat-label">Practiced</div>
                  </div>
                  <div class="pronunciation-stat-card">
                    <div class="stat-number" id="pron-stat-accuracy">0%</div>
                    <div class="stat-label">Avg Score</div>
                  </div>
                  <div class="pronunciation-stat-card">
                    <div class="stat-number" id="pron-stat-streak">0</div>
                    <div class="stat-label">Streak</div>
                  </div>
                </div>
                <div class="pronunciation-progress-bar">
                  <div class="pronunciation-progress-fill" id="pron-progress-fill" style="width: 0%"></div>
                </div>
              `;
        renderCategories();
      }

      // Add pronunciation button to UI
      function addPronunciationButton() {
        // Find the conversation button
        const conversationBtn = document.querySelector(
          'button[onclick="openScenariosModal()"]'
        );

        if (conversationBtn && conversationBtn.parentElement) {
          const pronunciationBtn = document.createElement("button");
          pronunciationBtn.id = "pronunciation-practice-btn";
          pronunciationBtn.className =
            "py-2 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition duration-150";
          pronunciationBtn.innerHTML = "🗣️ Pronunciation";
          pronunciationBtn.onclick = openPronunciationModal;
          pronunciationBtn.style.marginLeft = "8px";

          conversationBtn.parentElement.appendChild(pronunciationBtn);
        }
      }

      // Expose functions to global scope
      window.closePronunciationModal = closePronunciationModal;
      window.listenToPronunciation = listenToPronunciation;
      window.startPronunciationRecording = startPronunciationRecording;
      window.nextPronunciationTarget = nextPronunciationTarget;
      window.backToCategories = backToCategories;

      // ========================================
      // PHASE 4 - JAVASCRIPT IMPLEMENTATION
      // ========================================

      // Global state for Phase 4
      let fluencyChallengesData = null;
      let srsCardsData = null;
      let conversationTopicsData = null;

      let activeFluencyChallenge = null;
      let challengeTimer = null;
      let challengeStartTime = null;
      let challengeCorrectCount = 0;
      let challengeAttempts = 0;

      let srsCardQueue = [];
      let currentSRSCard = null;
      let srsUserData = {};
      let cardFlipped = false;

      let conversationMode = "normal";
      let conversationHistory = [];
      let conversationCorrections = [];

      // ===== LOAD PHASE 4 DATA =====

      async function loadPhase4Data() {
        try {
          // Load Fluency Challenges
          const fluencyResponse = await fetch("fluencyChallenges.json");
          fluencyChallengesData = await fluencyResponse.json();
          console.log("✅ Fluency challenges loaded");

          // Load SRS Cards
          const srsResponse = await fetch("srsCards.json");
          srsCardsData = await srsResponse.json();
          console.log("✅ SRS cards loaded");

          // Load Conversation Topics
          const convResponse = await fetch("conversationTopics.json");
          conversationTopicsData = await convResponse.json();
          console.log("✅ Conversation topics loaded");

          return true;
        } catch (error) {
          console.warn("⚠️ Could not load Phase 4 data:", error);
          return false;
        }
      }

      // ===== FLUENCY CHALLENGES =====

      function openFluencyModal() {
        if (!fluencyChallengesData) {
          showModal(
            "Feature Unavailable",
            "Fluency challenges data is not loaded.",
            true
          );
          return;
        }

        const modal = document.getElementById("fluency-modal");
        modal.classList.add("active");

        renderFluencyChallenges();
      }

      function closeFluencyModal() {
        const modal = document.getElementById("fluency-modal");
        modal.classList.remove("active");

        if (challengeTimer) {
          clearInterval(challengeTimer);
        }

        // Reset UI
        document.getElementById("fluency-challenges-list").style.display =
          "grid";
        document.getElementById("fluency-challenge-active").style.display =
          "none";
        document.getElementById("fluency-results").style.display = "none";
      }

      function renderFluencyChallenges() {
        const container = document.getElementById("fluency-challenges-list");
        container.innerHTML = "";

        fluencyChallengesData.challenges.forEach((challenge) => {
          const card = document.createElement("div");
          card.className = "challenge-card";
          card.innerHTML = `
            <span class="challenge-icon">${challenge.icon}</span>
            <div class="challenge-name">${challenge.name}</div>
            <div class="challenge-description">${challenge.description}</div>
            <div class="challenge-meta">
              <span>⏱️ ${Math.floor(challenge.time_limit / 60)}:${(
            challenge.time_limit % 60
          )
            .toString()
            .padStart(2, "0")}</span>
              <span style="text-transform: capitalize;">${
                challenge.difficulty
              }</span>
            </div>
          `;

          card.onclick = () => startFluencyChallenge(challenge);
          container.appendChild(card);
        });
      }

      function startFluencyChallenge(challenge) {
        activeFluencyChallenge = challenge;
        challengeStartTime = Date.now();
        challengeCorrectCount = 0;
        challengeAttempts = 0;

        // Switch UI
        document.getElementById("fluency-challenges-list").style.display =
          "none";
        document.getElementById("fluency-challenge-active").style.display =
          "block";

        // Set up timer
        let timeRemaining = challenge.time_limit;
        updateChallengeTimer(timeRemaining);

        challengeTimer = setInterval(() => {
          timeRemaining--;
          updateChallengeTimer(timeRemaining);

          if (timeRemaining <= 0) {
            endFluencyChallenge("timeout");
          }
        }, 1000);

        // Update UI
        document.getElementById("challenge-completed").textContent = "0";
        document.getElementById("challenge-target").textContent =
          challenge.target_count;

        // Start first item
        selectNewPhraseOrGoal(true);
      }

      function updateChallengeTimer(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        const timerEl = document.getElementById("challenge-timer");

        timerEl.textContent = `${minutes.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;

        if (seconds <= 30) {
          timerEl.classList.add("warning");
        }
      }

      function pauseChallenge() {
        if (challengeTimer) {
          clearInterval(challengeTimer);
          challengeTimer = null;
          document.querySelector('[onclick="pauseChallenge()"]').innerHTML =
            '<i class="fas fa-play"></i> Resume';
        } else {
          // Resume logic would go here
        }
      }

      function exitChallenge() {
        if (
          confirm("Are you sure you want to exit? Your progress will be lost.")
        ) {
          clearInterval(challengeTimer);
          closeFluencyModal();
        }
      }

      function checkChallengeProgress(isCorrect) {
        challengeAttempts++;

        if (isCorrect) {
          challengeCorrectCount++;
          document.getElementById("challenge-completed").textContent =
            challengeCorrectCount;

          if (challengeCorrectCount >= activeFluencyChallenge.target_count) {
            endFluencyChallenge("complete");
          } else {
            // Next item
            selectNewPhraseOrGoal(true);
          }
        }
      }

      function endFluencyChallenge(reason) {
        clearInterval(challengeTimer);

        const timeElapsed = (Date.now() - challengeStartTime) / 1000;
        const accuracy =
          challengeAttempts > 0
            ? (challengeCorrectCount / challengeAttempts) * 100
            : 0;

        // Calculate score
        const timeScore = Math.max(
          0,
          100 - (timeElapsed / activeFluencyChallenge.time_limit) * 50
        );
        const accuracyScore = accuracy;
        const finalScore = Math.round(timeScore * 0.4 + accuracyScore * 0.6);

        // Show results
        document.getElementById("fluency-challenge-active").style.display =
          "none";
        document.getElementById("fluency-results").style.display = "block";

        document.getElementById("final-score").textContent = finalScore;
        document.getElementById("result-time").textContent =
          formatTime(timeElapsed);
        document.getElementById("result-accuracy").textContent =
          Math.round(accuracy) + "%";
        document.getElementById("result-streak").textContent =
          finalScore >= 80 ? "+20%" : "+0%";

        if (finalScore >= 90) {
          document.getElementById("result-icon").textContent = "🏆";
          document.getElementById("result-title").textContent = "Excellent!";
        } else if (finalScore >= 70) {
          document.getElementById("result-icon").textContent = "🌟";
          document.getElementById("result-title").textContent = "Great Job!";
        } else {
          document.getElementById("result-icon").textContent = "✓";
          document.getElementById("result-title").textContent =
            "Challenge Complete!";
        }

        // Save to Firebase
        saveFluencyChallengeResult(finalScore, timeElapsed, accuracy);
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      function retryChallenge() {
        if (activeFluencyChallenge) {
          startFluencyChallenge(activeFluencyChallenge);
          document.getElementById("fluency-results").style.display = "none";
        }
      }

      async function saveFluencyChallengeResult(score, time, accuracy) {
        if (!db || !userId || !auth.currentUser) return;

        try {
          const challengesRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "fluency_challenges"
          );

          await setDoc(
            challengesRef,
            {
              lastChallenge: {
                id: activeFluencyChallenge.id,
                score: score,
                time: time,
                accuracy: accuracy,
                completedAt: serverTimestamp(),
              },
              totalChallenges: increment(1),
              totalScore: increment(score),
            },
            { merge: true }
          );

          console.log("✅ Fluency challenge result saved");
        } catch (error) {
          console.warn("Could not save fluency challenge result:", error);
        }
      }

      // ===== SPACED REPETITION SYSTEM (SRS) =====

      async function initializeSRS() {
        if (!srsCardsData) return;

        // Load user's SRS data from Firebase
        await loadSRSData();

        // Initialize queue
        updateSRSQueue();

        // Show SRS section if there are due cards
        const srsContainer = document.getElementById("srs-daily-review");
        if (srsCardQueue.length > 0) {
          srsContainer.style.display = "block";
          loadNextSRSCard();
        }
      }

      async function loadSRSData() {
        if (!db || !userId || !auth.currentUser) return;

        try {
          const srsRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "srs_data"
          );
          const docSnap = await getDoc(srsRef);

          if (docSnap.exists()) {
            srsUserData = docSnap.data();
          } else {
            // Initialize new user data
            srsUserData = {
              cards: {},
              stats: {
                new: 0,
                learning: 0,
                review: 0,
                mastered: 0,
              },
              lastReview: null,
            };

            // Add initial cards as "new"
            srsCardsData.initial_deck.forEach((card) => {
              srsUserData.cards[card.id] = {
                state: "new",
                interval: 0,
                easiness: 2.5,
                repetitions: 0,
                lastReview: null,
                nextReview: Date.now(),
              };
            });
          }

          console.log("✅ SRS data loaded");
        } catch (error) {
          console.error("Error loading SRS data:", error);
        }
      }

      function updateSRSQueue() {
        srsCardQueue = [];
        const now = Date.now();

        // Find all due cards
        Object.keys(srsUserData.cards).forEach((cardId) => {
          const cardData = srsUserData.cards[cardId];
          if (cardData.nextReview <= now && cardData.state !== "suspended") {
            srsCardQueue.push(cardId);
          }
        });

        // Update counts
        updateSRSStats();

        document.getElementById("srs-due-count").textContent =
          srsCardQueue.length;
      }

      function updateSRSStats() {
        const stats = { new: 0, learning: 0, review: 0, mastered: 0 };

        Object.values(srsUserData.cards).forEach((card) => {
          if (card.state in stats) {
            stats[card.state]++;
          }
        });

        document.getElementById("srs-new-count").textContent = stats.new;
        document.getElementById("srs-learning-count").textContent =
          stats.learning;
        document.getElementById("srs-review-count").textContent = stats.review;
        document.getElementById("srs-mastered-count").textContent =
          stats.mastered || 0;

        srsUserData.stats = stats;
      }

      function loadNextSRSCard() {
        if (srsCardQueue.length === 0) {
          document.getElementById("srs-daily-review").innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 4rem; margin-bottom: 16px;">🎉</div>
              <h3 style="font-size: 1.5rem; font-weight: 700;">All Done!</h3>
              <p style="color: var(--text-secondary); margin-top: 8px;">You've reviewed all cards for today. Great job!</p>
            </div>
          `;
          return;
        }

        const cardId = srsCardQueue[0];
        const cardTemplate = srsCardsData.initial_deck.find(
          (c) => c.id === cardId
        );

        if (!cardTemplate) return;

        currentSRSCard = cardTemplate;
        cardFlipped = false;

        // Update UI
        document.getElementById("card-front-text").textContent =
          cardTemplate.front;
        document.getElementById("card-pronunciation").textContent =
          cardTemplate.pronunciation || "";
        document.getElementById("card-back-text").textContent =
          cardTemplate.back;
        document.getElementById("card-example").innerHTML = `
          ${cardTemplate.example_sentence}<br>
          <span style="font-size: 0.85rem; opacity: 0.8;">${cardTemplate.example_translation}</span>
        `;

        // Reset flip state
        document.getElementById("srs-flashcard").classList.remove("flipped");
        document.getElementById("srs-response-buttons").style.display = "none";

        // Update interval displays
        const userData = srsUserData.cards[cardId];
        updateIntervalDisplays(userData);
      }

      function flipCard() {
        const flashcard = document.getElementById("srs-flashcard");
        flashcard.classList.toggle("flipped");
        cardFlipped = !cardFlipped;

        if (cardFlipped) {
          document.getElementById("srs-response-buttons").style.display =
            "flex";
        }
      }

      function updateIntervalDisplays(userData) {
        const goodInterval = calculateNextInterval(userData, 4);
        const easyInterval = calculateNextInterval(userData, 5);

        document.getElementById("good-interval").textContent =
          formatInterval(goodInterval);
        document.getElementById("easy-interval").textContent =
          formatInterval(easyInterval);
      }

      function calculateNextInterval(userData, grade) {
        const settings = srsCardsData.difficulty_adjustments[`grade_${grade}`];
        let interval = userData.interval * settings.interval_mult;

        if (interval < 1) interval = 1;
        if (interval > srsCardsData.review_schedule.maximum_interval) {
          interval = srsCardsData.review_schedule.maximum_interval;
        }

        return interval;
      }

      function formatInterval(days) {
        if (days < 1) return "<1d";
        if (days < 30) return `${Math.round(days)}d`;
        if (days < 365) return `${Math.round(days / 30)}mo`;
        return `${Math.round(days / 365)}y`;
      }

      function rateCard(grade) {
        if (!currentSRSCard || !cardFlipped) return;

        const cardId = currentSRSCard.id;
        const userData = srsUserData.cards[cardId];

        // Apply SM-2 algorithm
        const adjustment =
          srsCardsData.difficulty_adjustments[`grade_${grade}`];

        // Update easiness
        userData.easiness = Math.max(
          1.3,
          userData.easiness + adjustment.ease_change
        );

        // Update interval
        if (grade < 3) {
          // Failed - reset
          userData.interval = 0;
          userData.repetitions = 0;
          userData.state = "learning";
        } else {
          // Passed
          userData.repetitions++;

          if (userData.repetitions === 1) {
            userData.interval = 1;
            userData.state = "learning";
          } else if (userData.repetitions === 2) {
            userData.interval = 6;
            userData.state = "review";
          } else {
            userData.interval = Math.round(
              userData.interval * userData.easiness
            );
            userData.state = "review";
          }
        }

        // Set next review date
        userData.lastReview = Date.now();
        userData.nextReview =
          Date.now() + userData.interval * 24 * 60 * 60 * 1000;

        // Remove from queue
        srsCardQueue.shift();

        // Save to Firebase
        saveSRSData();

        // Load next card
        loadNextSRSCard();
        updateSRSStats();
      }

      async function saveSRSData() {
        if (!db || !userId || !auth.currentUser) return;

        try {
          const srsRef = doc(
            db,
            getPrivateCollectionPath("progress"),
            "srs_data"
          );

          await setDoc(
            srsRef,
            {
              cards: srsUserData.cards,
              stats: srsUserData.stats,
              lastReview: serverTimestamp(),
            },
            { merge: true }
          );
        } catch (error) {
          console.warn("Could not save SRS data:", error);
        }
      }

      // ===== FREE-FORM AI CONVERSATIONS =====

      function initializeConversationMode() {
        const toggleContainer = document.getElementById(
          "conversation-mode-toggle"
        );
        if (conversationTopicsData) {
          toggleContainer.style.display = "flex";
        }
      }

      function setConversationMode(mode) {
        conversationMode = mode;

        // Update active button
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        document.querySelector(`[data-mode="${mode}"]`).classList.add("active");

        // Clear correction history for new mode
        conversationCorrections = [];

        // Show mode-specific guidance
        if (mode === "immersive") {
          appendChatMessage("Ora parleremo solo in italiano! 🇮🇹", false);
        } else if (mode === "freeform") {
          appendChatMessage(
            "Feel free to talk about anything! I'll gently correct mistakes at the end.",
            false
          );
        }
      }

      async function handleChatSendWithMode() {
        const message = chatInput.value.trim();
        if (message === "") return;

        appendChatMessage(message, true);
        saveChatMessage(message, "user");

        chatInput.value = "";
        chatSendButton.disabled = true;
        chatLoadingIndicator.textContent = "Tutor is thinking...";
        chatLoadingIndicator.classList.remove("hidden");

        // Construct system prompt based on mode
        let systemPrompt = "";

        if (conversationMode === "immersive") {
          systemPrompt = `You are an Italian language tutor. Respond ONLY in Italian. Keep responses natural and conversational. If the user makes a mistake, gently model the correct form in your response without explicitly pointing it out.`;
        } else if (conversationMode === "freeform") {
          systemPrompt = `You are a friendly Italian language tutor. Have a natural conversation with the learner. Track any grammar or vocabulary mistakes, but don't interrupt - save corrections for the end of the conversation. Be encouraging and supportive.`;
        } else {
          systemPrompt = `You are a supportive Italian language tutor. Provide helpful responses with cultural context and gentle corrections when needed.`;
        }

        await postToGemini(message, systemPrompt, true, true);

        // If in freeform mode, analyze for corrections (without interrupting)
        if (conversationMode === "freeform") {
          analyzeForCorrections(message);
        }

        chatSendButton.disabled = false;
        chatLoadingIndicator.classList.add("hidden");
      }

      function analyzeForCorrections(userMessage) {
        // This would use AI to detect errors
        // For now, we'll just track messages
        conversationHistory.push({
          message: userMessage,
          timestamp: Date.now(),
        });

        // After 5 messages in freeform mode, offer corrections
        if (conversationHistory.length % 5 === 0) {
          offerCorrections();
        }
      }

      function offerCorrections() {
        if (conversationMode !== "freeform") return;

        const correctionDiv = document.createElement("div");
        correctionDiv.className = "correction-indicator";
        correctionDiv.innerHTML = `
          Would you like me to review your recent messages and suggest improvements?
          <button onclick="showDetailedCorrections()" style="margin-left: 8px; padding: 4px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Yes, please!
          </button>
        `;

        chatHistoryContainer.appendChild(correctionDiv);
        chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
      }

      async function showDetailedCorrections() {
        // Generate correction summary using AI
        const recentMessages = conversationHistory
          .slice(-5)
          .map((m) => m.message)
          .join(" | ");

        const prompt = `Review these Italian language learner messages and provide gentle, encouraging corrections: ${recentMessages}. Format as: "Great effort! Here are some tips: 1) ... 2) ..."`;

        await postToGemini(
          prompt,
          "You are a supportive language tutor providing corrections.",
          false,
          true
        );
      }

      // ===== WEEKLY PROGRESS REPORTS =====

      function openProgressReport() {
        const modal = document.getElementById("progress-report-modal");
        modal.classList.add("active");

        generateProgressReport();
      }

      function closeProgressReport() {
        const modal = document.getElementById("progress-report-modal");
        modal.classList.remove("active");
      }

      async function generateProgressReport() {
        if (!userProgress) {
          document.getElementById("report-main-stat").textContent = "--";
          return;
        }

        // Calculate date range
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

        document.getElementById(
          "report-date-range"
        ).textContent = `${weekAgo.toLocaleDateString()} - ${now.toLocaleDateString()}`;

        // Practice time (estimated)
        const practiceMinutes = userProgress.stats.total_sentences_built * 2; // Rough estimate
        document.getElementById("report-main-stat").textContent =
          practiceMinutes;

        // Sentences
        document.getElementById("report-sentences").textContent =
          userProgress.stats.total_sentences_built;

        // Accuracy
        const accuracy =
          userProgress.stats.total_sentences_built > 0
            ? Math.round(
                (userProgress.stats.total_sentences_correct /
                  userProgress.stats.total_sentences_built) *
                  100
              )
            : 0;
        document.getElementById("report-accuracy").textContent = accuracy + "%";

        // Streak
        document.getElementById("report-streak").textContent =
          userProgress.practice_days.streak;

        // Vocabulary
        document.getElementById("report-vocab").textContent =
          userProgress.vocabulary.unique_words.length;

        // Generate insights
        generateInsights();
        generateRecommendations();
      }

      function generateInsights() {
        const container = document.getElementById("report-insights-container");
        container.innerHTML = "";

        // Find strongest area
        const verbAccuracy = calculateVerbAccuracy();

        if (verbAccuracy > 85) {
          const insight = document.createElement("div");
          insight.className = "report-insight";
          insight.innerHTML = `
            <div class="report-insight-title">🎯 Strongest Area</div>
            <div class="report-insight-text">You're excelling at verb conjugations! Your accuracy is ${Math.round(
              verbAccuracy
            )}%.</div>
          `;
          container.appendChild(insight);
        }

        // Most practiced
        if (userProgress.sentences.total > 20) {
          const insight = document.createElement("div");
          insight.className = "report-insight";
          insight.innerHTML = `
            <div class="report-insight-title">📚 Dedicated Learner</div>
            <div class="report-insight-text">You've built ${userProgress.sentences.total} sentences this week. Your consistency is impressive!</div>
          `;
          container.appendChild(insight);
        }
      }

      function generateRecommendations() {
        const container = document.getElementById(
          "report-recommendations-container"
        );
        container.innerHTML = "";

        // Check for areas needing improvement
        const vocabCount = userProgress.vocabulary.unique_words.length;

        if (vocabCount < 50) {
          const rec = document.createElement("div");
          rec.className = "report-recommendation";
          rec.innerHTML = `
            <div class="report-recommendation-title">
              <i class="fas fa-star"></i> Next Milestone
            </div>
            <div class="report-recommendation-text">
              You're ${
                50 - vocabCount
              } words away from the Vocabulary Explorer milestone! Try the SRS card review to learn new words efficiently.
            </div>
          `;
          container.appendChild(rec);
        }

        // Streak recommendation
        if (userProgress.practice_days.streak >= 7) {
          const rec = document.createElement("div");
          rec.className = "report-recommendation";
          rec.innerHTML = `
            <div class="report-recommendation-title">
              <i class="fas fa-fire"></i> Streak Master
            </div>
            <div class="report-recommendation-text">
              Amazing ${userProgress.practice_days.streak}-day streak! Keep it up to unlock the Weekly Warrior achievement.
            </div>
          `;
          container.appendChild(rec);
        }
      }

      function calculateVerbAccuracy() {
        if (!userProgress || !userProgress.verb_mastery) return 0;

        const verbs = Object.values(userProgress.verb_mastery);
        if (verbs.length === 0) return 0;

        const totalCorrect = verbs.reduce((sum, v) => sum + v.correct, 0);
        const totalAttempts = verbs.reduce((sum, v) => sum + v.attempts, 0);

        return totalAttempts > 0 ? (totalCorrect / totalAttempts) * 100 : 0;
      }

      function generateNewReport() {
        // Refresh the report
        generateProgressReport();
      }

      // ===== PHASE 4 INITIALIZATION =====

      async function initializePhase4() {
        console.log("🚀 Initializing Phase 4: Advanced Learning Features...");

        const loaded = await loadPhase4Data();

        if (loaded && auth.currentUser?.uid) {
          // Add UI buttons
          // addPhase4Buttons(); // DISABLED - moved to hamburger menu

          // Initialize SRS
          await initializeSRS();

          // Initialize conversation mode
          initializeConversationMode();

          console.log("✅ Phase 4 ready!");
          return true;
        } else {
          console.warn("⚠️ Phase 4 data not fully loaded");
          return false;
        }
      }

      function addPhase4Buttons() {
        // Find the pronunciation button location
        const pronButton = document.getElementById(
          "pronunciation-practice-btn"
        );

        if (pronButton && pronButton.parentElement) {
          // Fluency Challenge button
          const fluencyBtn = document.createElement("button");
          fluencyBtn.className =
            "py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150";
          fluencyBtn.innerHTML = "⚡ Fluency";
          fluencyBtn.onclick = openFluencyModal;
          fluencyBtn.style.marginLeft = "8px";
          pronButton.parentElement.appendChild(fluencyBtn);

          // Progress Report button
          const reportBtn = document.createElement("button");
          reportBtn.className =
            "py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150";
          reportBtn.innerHTML = "📊 Report";
          reportBtn.onclick = openProgressReport;
          reportBtn.style.marginLeft = "8px";
          pronButton.parentElement.appendChild(reportBtn);
        }

        // Add conversation mode toggle to chat section
        const chatHistory = document.getElementById("chat-history");
        if (chatHistory) {
          const modeToggle = document.getElementById(
            "conversation-mode-toggle"
          );
          chatHistory.parentElement.insertBefore(modeToggle, chatHistory);
        }
      }

      // Expose global functions
      window.closeFluencyModal = closeFluencyModal;
      window.pauseChallenge = pauseChallenge;
      window.exitChallenge = exitChallenge;
      window.retryChallenge = retryChallenge;
      window.flipCard = flipCard;
      window.rateCard = rateCard;
      window.setConversationMode = setConversationMode;
      window.showDetailedCorrections = showDetailedCorrections;
      window.openProgressReport = openProgressReport;
      window.closeProgressReport = closeProgressReport;
      window.generateNewReport = generateNewReport;
      window.openScenariosModal = openScenariosModal;
      window.openPronunciationModal = openPronunciationModal;
      window.openFluencyModal = openFluencyModal;

      window.onload = function () {
        loadEnhancementData();
        initializeTheme();
        setupFirebase();
        populateWordBank(null);
        initializePhase4();

        // Logout handler
        document.getElementById("logout-btn").onclick = async () => {
          if (confirm("Are you sure you want to logout?")) {
            try {
              await signOut(auth);
              // User will be redirected to login.html by onAuthStateChanged
            } catch (error) {
              console.error("Logout error:", error);
              showModal(
                "Logout Error",
                "Could not logout. Please try again.",
                true
              );
            }
          }
        };
      };

      // === Expose functions used by inline onclick handlers ===
      // These make the inline onclick="..." buttons work even inside a module.

      function getScenariosModalEl() {
        return document.querySelector(".scenarios-modal");
      }

      window.closeScenariosModal = function () {
        const modal = getScenariosModalEl();
        if (modal) modal.classList.add("hidden");
      };

      window.submitScenarioResponse = function () {
        const input = document.querySelector(".scenario-input");
        const value = (input?.value ?? "").trim();
        if (!value) return;

        document.dispatchEvent(
          new CustomEvent("scenario:submit", { detail: { value } })
        );

        if (input) input.value = "";
      };

      window.exitScenario = function () {
        const active = document.querySelector(".scenario-active");
        if (active) active.classList.add("hidden");

        const modal = getScenariosModalEl();
        if (modal) modal.classList.add("hidden");

        document.dispatchEvent(new Event("scenario:exit"));
      };

      // ===== PHASE 6: MOBILE NAVIGATION FUNCTIONS =====

      // Mobile menu toggle
      window.toggleMobileMenu = function () {
        const overlay = document.getElementById("mobile-menu-overlay");
        const panel = document.getElementById("mobile-menu-panel");

        if (overlay.style.display === "block") {
          closeMobileMenu();
        } else {
          overlay.style.display = "block";
          panel.classList.add("open");
          document.body.style.overflow = "hidden";
        }
      };

      window.closeMobileMenu = function () {
        const overlay = document.getElementById("mobile-menu-overlay");
        const panel = document.getElementById("mobile-menu-panel");

        overlay.style.display = "none";
        panel.classList.remove("open");
        document.body.style.overflow = "";
      };

      // Mobile bottom nav handlers
      window.showMobilePractice = function () {
        setMobileNavActive("mobile-nav-practice");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      window.showMobileProgress = function () {
        setMobileNavActive("mobile-nav-progress");
        const progressDashboard = document.querySelector(".progress-dashboard");
        if (progressDashboard) {
          progressDashboard.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      };

      window.showMobileChat = function () {
        setMobileNavActive("mobile-nav-chat");
        const chatInterface = document.getElementById("chat-interface");
        if (chatInterface) {
          chatInterface.scrollIntoView({ behavior: "smooth", block: "start" });
          const chatInput = document.getElementById("chat-input");
          if (chatInput) {
            setTimeout(() => chatInput.focus(), 300);
          }
        }
      };

      function setMobileNavActive(activeId) {
        document.querySelectorAll(".mobile-nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        const activeItem = document.getElementById(activeId);
        if (activeItem) {
          activeItem.classList.add("active");
        }
      }

      // Close mobile menu when clicking outside
      document.addEventListener("click", (e) => {
        const panel = document.getElementById("mobile-menu-panel");
        const btn = document.getElementById("mobile-menu-btn");
        const overlay = document.getElementById("mobile-menu-overlay");

        if (
          overlay &&
          overlay.style.display === "block" &&
          panel &&
          !panel.contains(e.target) &&
          btn &&
          !btn.contains(e.target)
        ) {
          closeMobileMenu();
        }
      });
    </script>
    <!-- Phase 4: Pronunciation Practice Modal -->
    <div id="pronunciation-modal" class="pronunciation-modal">
      <div class="pronunciation-panel">
        <!-- Header -->
        <div class="pronunciation-header">
          <h2 class="pronunciation-title">🗣️ Pronunciation Practice</h2>
          <button
            class="scenarios-close-btn"
            onclick="closePronunciationModal()"
          >
            ×
          </button>
        </div>

        <!-- Category Selection -->
        <div id="pronunciation-categories" class="pronunciation-categories">
          <!-- Categories will be dynamically inserted -->
        </div>

        <!-- Practice Area -->
        <div
          id="pronunciation-practice"
          class="pronunciation-practice-area"
          style="display: none"
        >
          <!-- Current Target -->
          <div class="pronunciation-target">
            <div class="pronunciation-text" id="pron-text">casa</div>
            <div class="pronunciation-ipa" id="pron-ipa">/ˈka.sa/</div>
            <div class="pronunciation-english" id="pron-english">house</div>
            <span class="pronunciation-focus" id="pron-focus"
              >Focus: a sound</span
            >
          </div>

          <!-- Controls -->
          <div class="pronunciation-controls">
            <button
              class="pronunciation-btn pronunciation-btn-listen"
              onclick="listenToPronunciation()"
            >
              <i class="fas fa-volume-up"></i>
              Listen to Native
            </button>
            <button
              class="pronunciation-btn pronunciation-btn-record"
              id="pron-record-btn"
              onclick="startPronunciationRecording()"
            >
              <i class="fas fa-microphone"></i>
              <span id="pron-record-text">Record Yourself</span>
            </button>
          </div>

          <!-- Waveform (shown during recording) -->
          <div class="waveform" id="pron-waveform" style="display: none">
            <div class="waveform-bar"></div>
            <div class="waveform-bar"></div>
            <div class="waveform-bar"></div>
            <div class="waveform-bar"></div>
            <div class="waveform-bar"></div>
          </div>

          <!-- Feedback Area -->
          <div id="pron-feedback" class="pronunciation-feedback">
            <div class="pronunciation-score">
              <div class="score-display excellent" id="pron-score-number">
                85%
              </div>
              <div class="score-label" id="pron-score-label">
                Good job! Almost there!
              </div>
            </div>

            <div class="pronunciation-comparison">
              <div class="comparison-box">
                <div class="comparison-label">You Said</div>
                <div class="comparison-text" id="pron-you-said">casa</div>
              </div>
              <div class="comparison-box">
                <div class="comparison-label">Target</div>
                <div class="comparison-text" id="pron-target">casa</div>
              </div>
            </div>

            <div class="pronunciation-tips">
              <div class="tips-title">
                <i class="fas fa-lightbulb"></i>
                Pronunciation Tip
              </div>
              <div class="tips-content" id="pron-tip">
                The 'a' sound is always like 'ah' in father.
              </div>
            </div>

            <div
              class="pronunciation-mistakes"
              id="pron-mistakes-box"
              style="display: none"
            >
              <div class="mistakes-title">
                <i class="fas fa-exclamation-triangle"></i>
                Common Mistake
              </div>
              <div class="mistakes-content" id="pron-mistake">
                Avoid pronouncing 'a' as 'ay' like in English 'case'.
              </div>
            </div>

            <button
              class="pronunciation-btn pronunciation-btn-next"
              onclick="nextPronunciationTarget()"
            >
              Next Word <i class="fas fa-arrow-right"></i>
            </button>
          </div>

          <!-- Stats -->
          <div class="pronunciation-stats">
            <div class="pronunciation-stat-card">
              <div class="stat-number" id="pron-stat-practiced">0</div>
              <div class="stat-label">Practiced</div>
            </div>
            <div class="pronunciation-stat-card">
              <div class="stat-number" id="pron-stat-accuracy">0%</div>
              <div class="stat-label">Avg Score</div>
            </div>
            <div class="pronunciation-stat-card">
              <div class="stat-number" id="pron-stat-streak">0</div>
              <div class="stat-label">Streak</div>
            </div>
          </div>

          <div class="pronunciation-progress-bar">
            <div
              class="pronunciation-progress-fill"
              id="pron-progress-fill"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- ========================================
     PHASE 4 MODALS - ADD BEFORE </body>
     ======================================== -->

    <!-- Fluency Challenge Modal -->
    <div id="fluency-modal" class="fluency-modal">
      <div class="fluency-panel">
        <div class="scenarios-header">
          <h2 class="scenarios-title">⚡ Fluency Challenges</h2>
          <button class="scenarios-close-btn" onclick="closeFluencyModal()">
            ×
          </button>
        </div>

        <!-- Challenge Selection -->
        <div id="fluency-challenges-list" class="challenge-grid">
          <!-- Challenges will be dynamically inserted -->
        </div>

        <!-- Active Challenge -->
        <div id="fluency-challenge-active" style="display: none">
          <div class="challenge-active">
            <!-- Timer -->
            <div class="challenge-timer">
              <div class="timer-display" id="challenge-timer">03:00</div>
              <div
                style="
                  font-size: 0.9rem;
                  color: var(--text-secondary);
                  margin-top: 8px;
                "
              >
                Time Remaining
              </div>
            </div>

            <!-- Progress -->
            <div class="challenge-progress-text" id="challenge-progress">
              Completed: <span id="challenge-completed">0</span> /
              <span id="challenge-target">5</span>
            </div>

            <!-- Challenge Area (reuses existing sentence builder) -->
            <div
              id="challenge-instruction"
              style="
                text-align: center;
                margin: 20px 0;
                font-size: 1.1rem;
                color: var(--text-primary);
              "
            >
              Build the sentence as fast as you can!
            </div>

            <!-- Controls -->
            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 20px;
              "
            >
              <button
                class="pronunciation-btn pronunciation-btn-listen"
                onclick="pauseChallenge()"
              >
                <i class="fas fa-pause"></i> Pause
              </button>
              <button class="scenario-exit-btn" onclick="exitChallenge()">
                Exit Challenge
              </button>
            </div>
          </div>
        </div>

        <!-- Challenge Results -->
        <div id="fluency-results" style="display: none">
          <div class="scenario-completion">
            <div class="completion-icon" id="result-icon">🏆</div>
            <h2 class="completion-title" id="result-title">
              Challenge Complete!
            </h2>

            <div class="challenge-score-display">
              <div class="score-number" id="final-score">0</div>
              <div class="score-label">Final Score</div>
            </div>

            <div class="completion-stats">
              <div class="completion-stat">
                <div class="completion-stat-value" id="result-time">--</div>
                <div class="completion-stat-label">Time</div>
              </div>
              <div class="completion-stat">
                <div class="completion-stat-value" id="result-accuracy">--</div>
                <div class="completion-stat-label">Accuracy</div>
              </div>
              <div class="completion-stat">
                <div class="completion-stat-value" id="result-streak">--</div>
                <div class="completion-stat-label">Bonus</div>
              </div>
            </div>

            <div class="completion-actions">
              <button
                class="completion-btn completion-btn-primary"
                onclick="retryChallenge()"
              >
                Try Again
              </button>
              <button
                class="completion-btn completion-btn-secondary"
                onclick="closeFluencyModal()"
              >
                Back to Challenges
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SRS Daily Review Section (add to main page, not modal) -->
    <div id="srs-daily-review" class="srs-container" style="display: none">
      <div class="srs-header">
        <h3 class="srs-title">🧠 Daily Review</h3>
        <span class="srs-due-count" id="srs-due-count">0</span>
      </div>

      <!-- Flashcard -->
      <div class="flashcard" id="srs-flashcard" onclick="flipCard()">
        <div class="flashcard-front">
          <div class="flashcard-text" id="card-front-text">casa</div>
          <div class="flashcard-pronunciation" id="card-pronunciation">
            /ˈka.sa/
          </div>
          <div
            style="
              font-size: 0.9rem;
              color: var(--text-secondary);
              margin-top: 20px;
            "
          >
            Click to reveal answer
          </div>
        </div>
        <div class="flashcard-back">
          <div class="flashcard-text" id="card-back-text">house</div>
          <div class="flashcard-example" id="card-example">
            La mia casa è grande.<br />
            <span style="font-size: 0.85rem; opacity: 0.8"
              >My house is big.</span
            >
          </div>
        </div>
      </div>

      <!-- Response Buttons -->
      <div class="srs-buttons" id="srs-response-buttons" style="display: none">
        <button class="srs-btn srs-btn-again" onclick="rateCard(0)">
          <i class="fas fa-times"></i> Again
          <span style="font-size: 0.75rem; opacity: 0.8">&lt;1m</span>
        </button>
        <button class="srs-btn srs-btn-hard" onclick="rateCard(3)">
          <i class="fas fa-frown"></i> Hard
          <span style="font-size: 0.75rem; opacity: 0.8">&lt;10m</span>
        </button>
        <button class="srs-btn srs-btn-good" onclick="rateCard(4)">
          <i class="fas fa-check"></i> Good
          <span style="font-size: 0.75rem; opacity: 0.8" id="good-interval"
            >4d</span
          >
        </button>
        <button class="srs-btn srs-btn-easy" onclick="rateCard(5)">
          <i class="fas fa-smile"></i> Easy
          <span style="font-size: 0.75rem; opacity: 0.8" id="easy-interval"
            >10d</span
          >
        </button>
      </div>

      <!-- Stats -->
      <div class="srs-stats">
        <div class="srs-stat-card">
          <div class="srs-stat-number" id="srs-new-count">0</div>
          <div class="srs-stat-label">New</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-number" id="srs-learning-count">0</div>
          <div class="srs-stat-label">Learning</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-number" id="srs-review-count">0</div>
          <div class="srs-stat-label">Review</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-number" id="srs-mastered-count">0</div>
          <div class="srs-stat-label">Mastered</div>
        </div>
      </div>
    </div>

    <!-- Progress Report Modal -->
    <div id="progress-report-modal" class="progress-report-modal">
      <div class="progress-report-panel">
        <div class="scenarios-header">
          <h2 class="scenarios-title">📊 Your Progress Report</h2>
          <button class="scenarios-close-btn" onclick="closeProgressReport()">
            ×
          </button>
        </div>

        <div class="report-header">
          <div class="report-title" id="report-period">Weekly Progress</div>
          <div class="report-subtitle" id="report-date-range">--</div>
        </div>

        <!-- Highlight Stats -->
        <div class="report-highlight">
          <div class="report-highlight-stat" id="report-main-stat">127</div>
          <div class="report-highlight-label">
            Total Practice Minutes This Week
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="report-section">
          <h3 class="report-section-title">📈 Key Metrics</h3>
          <div class="report-grid">
            <div class="report-metric">
              <div class="report-metric-value" id="report-sentences">42</div>
              <div class="report-metric-label">Sentences Built</div>
              <div
                class="report-metric-change positive"
                id="report-sentences-change"
              >
                +15% from last week
              </div>
            </div>
            <div class="report-metric">
              <div class="report-metric-value" id="report-accuracy">87%</div>
              <div class="report-metric-label">Accuracy</div>
              <div
                class="report-metric-change positive"
                id="report-accuracy-change"
              >
                +5% from last week
              </div>
            </div>
            <div class="report-metric">
              <div class="report-metric-value" id="report-streak">7</div>
              <div class="report-metric-label">Day Streak</div>
              <div
                class="report-metric-change positive"
                id="report-streak-change"
              >
                Keep it up!
              </div>
            </div>
            <div class="report-metric">
              <div class="report-metric-value" id="report-vocab">23</div>
              <div class="report-metric-label">New Words</div>
              <div
                class="report-metric-change positive"
                id="report-vocab-change"
              >
                +8 from last week
              </div>
            </div>
          </div>
        </div>

        <!-- Insights -->
        <div class="report-section">
          <h3 class="report-section-title">💡 Insights</h3>
          <div id="report-insights-container">
            <div class="report-insight">
              <div class="report-insight-title">🎯 Strongest Area</div>
              <div class="report-insight-text">
                You're excelling at present tense conjugations! Your accuracy is
                94%.
              </div>
            </div>
            <div class="report-insight">
              <div class="report-insight-title">📚 Most Practiced</div>
              <div class="report-insight-text">
                You practiced vocabulary most this week, spending 45 minutes on
                new words.
              </div>
            </div>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="report-section">
          <h3 class="report-section-title">🎯 Recommendations</h3>
          <div id="report-recommendations-container">
            <div class="report-recommendation">
              <div class="report-recommendation-title">
                <i class="fas fa-arrow-up"></i> Focus Area
              </div>
              <div class="report-recommendation-text">
                Consider practicing past tense more. Your accuracy (68%) could
                improve with focused practice.
              </div>
            </div>
            <div class="report-recommendation">
              <div class="report-recommendation-title">
                <i class="fas fa-star"></i> Next Goal
              </div>
              <div class="report-recommendation-text">
                You're close to reaching 50 unique words! Keep learning to
                unlock the Vocabulary Explorer milestone.
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div
          style="
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
          "
        >
          <button
            class="pronunciation-btn pronunciation-btn-next"
            onclick="generateNewReport()"
          >
            Generate New Report
          </button>
          <button
            class="completion-btn completion-btn-secondary"
            onclick="closeProgressReport()"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Conversation Mode Toggle (add to chat section) -->
    <div
      class="conversation-mode-toggle"
      id="conversation-mode-toggle"
      style="display: none"
    >
      <button
        class="mode-btn active"
        data-mode="normal"
        onclick="setConversationMode('normal')"
      >
        <i class="fas fa-comments"></i> Normal
      </button>
      <button
        class="mode-btn"
        data-mode="freeform"
        onclick="setConversationMode('freeform')"
      >
        <i class="fas fa-comment-dots"></i> Free Talk
      </button>
      <button
        class="mode-btn"
        data-mode="immersive"
        onclick="setConversationMode('immersive')"
      >
        <i class="fas fa-language"></i> Italian Only
      </button>
    </div>
  </body>
</html>
